<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/dc1/page_exahype_parallelisation.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Parallelisation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md883">Domain decomposition</a><ul><li class="level3"><a href="#autotoc_md884">Load balancing settings (best practices)</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md885">Task parallelism</a></li>
<li class="level2"><a href="#autotoc_md886">Writing your own parallel extensions</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p>ExaHyPE employs <a class="el" href="../../d4/d00/page_peano_domain_decomposition.html">Peano's domain decomposition</a> and adds tasking on top. Peano's domain decomposition is used for both MPI and multithreading, while the tasking only affects the shared memory parallelisation. Both parallelisation paradigms are controlled via the Python API.</p>
<h2><a class="anchor" id="autotoc_md883"></a>
Domain decomposition</h2>
<p>In ExaHyPE, you enable load balancing by adding</p>
<div class="fragment"><div class="line">project.set_load_balancing(<span class="stringliteral">&quot;toolbox::loadbalancing::RecursiveBipartition&quot;</span>,<span class="stringliteral">&quot;(new ::exahype2::LoadBalancingConfiguration(0.9))&quot;</span> )</div>
</div><!-- fragment --><p>There are multiple different load balancing schemes available through <a class="el" href="../../d1/de1/toolbox_loadbalancing.html">Peano's generic load balancing toolbox</a>.</p>
<p>It is important to study the constructor parameter list of <a class="el" href="../../d0/d0e/classexahype2_1_1LoadBalancingConfiguration.html" title="ExaHyPE 2-specific load balancing configuration.">exahype2::LoadBalancingConfiguration</a>. These arguments allow you to constrain the properties of the domain. for example, you can instruct the load balancing that you want it to be well-balanced accross ranks up to 80% and you also to constrain the tree (subpartition) size by 200 cells. This means that no domain on a rank will be split if this rank's load is around 20% off, and a partition will never split up if it has less than 200 cells.</p>
<p>There is a always a trade-off between the different settings: If you increase the quality of the domain decomposition, then the time per time step will go down. However, the load balancing will need way longer. If you pick a minimum cell size, then the grid will build up first until it can accommodate the constraint, and then it will decompose. Grid decomposition however is both time consuming and requires (temporarily) quite a lot of memory.</p>
<h3><a class="anchor" id="autotoc_md884"></a>
Load balancing settings (best practices)</h3>
<p>While ExaHyPE makes it relatively straightforward to parallelise a code, the tuning of a particular experiment is often tricky. As ExaHyPE is an engine supporting multiple application (domains) and as the `&lsquo;perfect&rsquo;' load balancing strategy depends strongly on the application type plus the chosen experiments plus the machine used, it can only provide vague heuristics of settings that work in most of the cases. To get really good performance, you will have to play around with the load balancing settings.</p>
<p>Here are some recommendations if you use the recursive load balancing. The recommendations describe how to tweak the three parameters that the ExaHyPE configuration offers:</p>
<ul>
<li>Start with the strategy toolbox::loadbalancing::SpreadOut. This should give you first feeling if your code is MPI-/threading-ready.</li>
<li>Do not set the load balancing quality too high. I am usually fine if the balancing between the ranks is about 80%-90% accurate. First get something up and running and test it. After that, you might want to increase the quality closer to 100%. However, the higher this quality threshold the longer your grid setup and balancing time.</li>
<li>If your code tends to hang in MPI, try to kick the simulation off with only one partition per rank, i.e. set the maximum number of trees for a partition to 1. Once this passes through, increase the last counter to at most the number of cores per rank.</li>
<li>If you work without periodic boundary conditions, the initial load balancing will likely be poor if the mesh is too shallow: The code cannot deploy cells along the periodic boundary to other ranks. These always have to be handled by rank 0. So it makes sense to set the minimal mesh size (second argument) to at least \( 3^d+1 \). This prolongs the load distribution sufficiently long until enough cells are available. The knock-on problem then is that we have a lot of cells and the load balancing tries to split them up evenly - unaware that all the boundary cells can't be distributed. So you will have to restrict the number of cells per inter-rank balancing. I recommend to to add $3^d$ as fourth argument to ExaHyPE's load balancing configuration.</li>
<li>Once MPI+X is up and running, study the ExaHyPE/Peano performance analysis remarks so you obtain an understanding of your code's behaviour.</li>
</ul>
<h2><a class="anchor" id="autotoc_md885"></a>
Task parallelism</h2>
<p>Some ExaHyPE solvers add further task parallelism to this decomposition. In general, the enclave solvers tend to perform better on massively parallel systems.</p>
<h2><a class="anchor" id="autotoc_md886"></a>
Writing your own parallel extensions</h2>
<p>Most users that write extensions to ExaHyPE which need some global data exchange are users which add new fields to their solver. Examples are global statistics that they want to track over the solution or global variables that they control.</p>
<p>Each MPI rank holds one instance of the solver. All threads per MPI rank share the same instance of the solver. Peano splits up the domain into chunks along the space-filling curve. If you use an enclave solver, it then splits up these chunks further into tasks. That is, operations per cell such as the Riemann solves and the patch postprocessing can run in parallel on each thread.</p>
<p>If you add new attributes to your solver, this attribute exists on each solver on each rank. You therefore have to</p>
<ul>
<li>ensure that no two threads access the attribute at the same time;</li>
<li>ensure that the attributes of the individual solver instances per rank remain consistent.</li>
</ul>
<p>The first item is relatively simple: You might, for example, decide to protect all accesses to your own variables via a semaphore. There is no specific place to take care of the protection: Just protect the actual data access.</p>
<p>The second item requires slightly more work, as you have to globally reduce the attribute: After each time step, you have to ensure that all ranks exchange their attributes with each other, and you then have to merge these data. I recommend not to use MPI's data exchange routine directly, but to use Peano's wrappers around these routines.</p>
<p>The actual data exchange should be done at the end of a each time step. For this, you add</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> finishTimeStep() <span class="keyword">override</span>;</div>
</div><!-- fragment --><p>to your solver. The implementation should first invoke the superclass and then add the additional data exchange.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> mynamespace::MyFancySolver::finishTimeStep() {</div>
<div class="line">  MyFancyAbstractSolver::finishTimeStep();</div>
<div class="line"><span class="preprocessor">  #ifdef Parallel</span></div>
<div class="line">  <span class="comment">// additional data exchange</span></div>
<div class="line"><span class="preprocessor">  #endif</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>ExaHyPE internally realises these two steps for all of its solver attributes such as the maximum mesh size or the admissible time step sizes. This is the reason why you have to call the superclass implementation, too.</p>
<p><a class="anchor" id="autotoc_md887"></a> </p><h5>Writing your own parallel extensions</h5>
<p>Most users that write extensions to  which need some global data exchange are users which add new fields to their solver. Examples are global statistics that they want to track over the solution or global variables that they control.</p>
<p>Each MPI rank holds one instance of the solver. All threads per MPI rank share the same instance of the solver.</p>
<p> splits up the domain into chunks along the space-filling curve. If you use an enclave solver, it then splits up these chunks further into tasks. That is, operations per cell such as the Riemann solves and the patch postprocessing can run in parallel on each thread.</p>
<p>If you add new attributes to your solver, this attribute exists on each solver on each rank. You therefore have to</p>
<ul>
<li>ensure that no two threads access the attribute at the same time;</li>
<li>ensure that the attributes of the individual solver instances per rank remain consistent.</li>
</ul>
<p>The first item is relatively simple: You might, for example, decide to protect all accesses to your own variables via a semaphore. These techniques are discussed in Section \[section:parallel-programming:shared-mem:protect\]{reference-type="ref" reference="section:parallel-programming:shared-mem:protect"}. There is no specific place to take care of the protection: Just protect the actual data access.</p>
<p>The second item requires slightly more work, as you have to globally reduce the attribute: After each time step, you have to ensure that all ranks exchange their attributes with each other, and you then have to merge these data. I recommend not to use MPI's data exchange routine directly, but to use 's wrappers around these routines. These wrappers are discussed in Section \[section:parallel-programming:shared-mem:reductions\]{reference-type="ref" reference="section:parallel-programming:shared-mem:reductions"}. The actual data exchange should be done at the end of a each time step. For this, you add</p>
<p>void finishTimeStep() override;</p>
<p>to your solver. The implementation should first invoke the superclass and then add the additional data exchange.</p>
<p>void mynamespace::MyFancySolver::finishTimeStep() MyFancyAbstractSolver::finishTimeStep(); #ifdef Parallel // additional data exchange #endif</p>
<p> internally realises these two steps for all of its solver attributes such as the maximum mesh size or the admissible time step sizes. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:04 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
