<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dc/de6/tutorials_documentation_multigrid_petsc_continuous_galerkin_poisson.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Continuous Galerkin for the Poisson equation with PETSc</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md622">Code usage</a><ul><li class="level2"><a href="#autotoc_md623">Create a project</a></li>
<li class="level2"><a href="#autotoc_md624">Add the solver</a></li>
<li class="level2"><a href="#autotoc_md625">Generate a Peano project and the C++ code</a></li>
<li class="level2"><a href="#autotoc_md626">Add numerics</a></li>
<li class="level2"><a href="#autotoc_md627">Visualisation</a></li>
<li class="level2"><a href="#autotoc_md628">What happens under the hood</a></li>
<li class="level2"><a href="#autotoc_md629">Libraries</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md630">Internal workflow</a></li>
</ul>
</div>
<div class="textblock"><p>This simple example discusses the steps from the file benchmarks/multigrid/petsc/poisson/fem.py. We omit some technical details (such as the parsing of the command line) and focus on key ingredients. Therefore, it is reasonable to study this description in combination with the actual script.</p>
<h1><a class="anchor" id="autotoc_md622"></a>
Code usage</h1>
<h2><a class="anchor" id="autotoc_md623"></a>
Create a project</h2>
<p>First, we have to create a multigrid project.</p>
<div class="fragment"><div class="line">project = <a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a>.Project(project_name = <span class="stringliteral">&quot;Poisson&quot;</span>, </div>
<div class="line">                        <span class="keyword">namespace</span> = [ <span class="stringliteral">&quot;multigrid&quot;</span>, <span class="stringliteral">&quot;petsc&quot;</span>, <span class="stringliteral">&quot;poisson&quot;</span> ]</div>
<div class="line">                        ) </div>
<div class="ttc" id="anamespacepetsc_html"><div class="ttname"><a href="../../dc/d24/namespacepetsc.html">petsc</a></div><div class="ttdef"><b>Definition</b> <a href="../../db/d10/LinearEquationSystem_8h_source.html#l00019">LinearEquationSystem.h:19</a></div></div>
</div><!-- fragment --><p>This is kind of an empty hull until we befill it with some global information (such as the domain size) and also tell the API to scan the global Makefile.</p>
<div class="fragment"><div class="line">cube_size = 1.0</div>
<div class="line">project.set_global_simulation_parameters(</div>
<div class="line">  dimensions            = 2,</div>
<div class="line">  offset                = [0.0, 0.0, 0.0],</div>
<div class="line">  domain_size           = [ cube_size, cube_size, cube_size],</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">project.set_Peano4_installation( args.peanodir, </div>
<div class="line">                                 build_mode = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../df/da1/namespacepeano4_1_1output.html">output</a>.<a class="code hl_namespace" href="../../d9/d5b/namespacepeano4_1_1output_1_1CompileMode.html">CompileMode</a>.Asserts</div>
<div class="line">                                 )</div>
<div class="ttc" id="anamespacepeano4_1_1output_1_1CompileMode_html"><div class="ttname"><a href="../../d9/d5b/namespacepeano4_1_1output_1_1CompileMode.html">peano4.output.CompileMode</a></div><div class="ttdef"><b>Definition</b> <a href="../../d1/d84/CompileMode_8py_source.html#l00001">CompileMode.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1output_html"><div class="ttname"><a href="../../df/da1/namespacepeano4_1_1output.html">peano4.output</a></div><div class="ttdef"><b>Definition</b> <a href="../../d2/d45/python_2peano4_2output_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --><p>The routine petsc.Project.set_Peano4_installation() will parse all the settings that you used for configure (autotools) or cmake. From hereon, these settings will be used by the Python API as well.</p>
<h2><a class="anchor" id="autotoc_md624"></a>
Add the solver</h2>
<p>We use one of the simplest solvers that we have for the examples here:</p>
<div class="fragment"><div class="line">solver = <a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a>.solvers.CollocatedLowOrderDiscretisation(<span class="stringliteral">&quot;Poisson&quot;</span>, </div>
<div class="line">                                                       1, # <a class="code hl_variable" href="../../d0/de2/hydro__iact_8h.html#a8cbb00f59bca2c48d4560b23f07a4de2">a</a> scalar</div>
<div class="line">                                                       0.01,</div>
<div class="line">                                                       0.01</div>
<div class="line">                                                       )</div>
<div class="line"> </div>
<div class="line">project.add_solver( solver )</div>
<div class="ttc" id="ahydro__iact_8h_html_a8cbb00f59bca2c48d4560b23f07a4de2"><div class="ttname"><a href="../../d0/de2/hydro__iact_8h.html#a8cbb00f59bca2c48d4560b23f07a4de2">a</a></div><div class="ttdeci">const float const float const float struct part *restrict struct part *restrict const float a</div><div class="ttdef"><b>Definition</b> <a href="../../d0/de2/hydro__iact_8h_source.html#l00055">hydro_iact.h:55</a></div></div>
</div><!-- fragment --><p>The solver knows, by definition, which data objects it has to build up internally and to which grid entities these data objects are associated to. As we use a collocated solver here, the scalar is attached to the mesh vertices. The call of petsc.Project.add_solver() will ensure that this solver's data structures are tied to the mesh and that the solver enriches all the algorithmic steps with the required operations.</p>
<h2><a class="anchor" id="autotoc_md625"></a>
Generate a Peano project and the C++ code</h2>
<p>We close the solver construction by asking the multigrid API to create a Peano 4 Python project for us, and subsequently ask this Peano 4 project to generate all C++ code and the Makefile:</p>
<div class="fragment"><div class="line">peano4_project = project.generate_Peano4_project(args.verbose)</div>
<div class="line">peano4_project.generate()</div>
</div><!-- fragment --><p>After this last step, we can either invoke peano4.Project.build() on the peano4_project object, or we can simply type in make on the command line. Before we do this, we have to add the actual numerics:</p>
<h2><a class="anchor" id="autotoc_md626"></a>
Add numerics</h2>
<p>Now it is time to build your code. The Python API will never overwrite your user code, i.e. alter the <a class="el" href="../../d5/d80/Poisson_8h.html">Poisson.h</a> and <a class="el" href="../../d9/d85/Poisson_8cpp.html">Poisson.cpp</a> file. So you are save when you rerun the Python script once more and make it call </p><pre class="fragment">   peano4_project.build()
</pre><p> As it is some overhead to regenerate all of that glue code, just type in make on the terminal, and everything should be fine. Our implementation of the Poisson setup is really simplistic. As we want to solve</p>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000044">Todo</a></b></dt><dd>Sean can you write down stuff here?</dd></dl>
<h2><a class="anchor" id="autotoc_md627"></a>
Visualisation</h2>
<p>Once you have built your code and invoked it, you should see an output similar to</p>
<div class="fragment"><div class="line">00:00:11    rank:0  ::::main()  info    terminated successfully</div>
<div class="line">00:00:11    rank:0  ::::<a class="code hl_function" href="../../d4/d76/benchmarks_2other_2noh2d_2main_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()  info    grid construction:           5.43634s   (avg=0.339771,<span class="preprocessor">#measurements=16,max=0.745847(value #10),min=0.000293452(value #1),+119.514%,-99.9136%,std-deviation=0.316354)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    enumerate:                   0.589898s  (avg=0.589898,<span class="preprocessor">#measurements=1,max=0.589898(value #0),min=0.589898(value #0),+0%,-0%,std-deviation=3.4285e-09)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    init (setup PETSc):          4.52e-07s  (avg=4.52e-07,<span class="preprocessor">#measurements=1,max=4.52e-07(value #0),min=4.52e-07(value #0),+0%,-0%,std-deviation=3.45865e-15)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    assemble:                    0.591637s  (avg=0.591637,<span class="preprocessor">#measurements=1,max=0.591637(value #0),min=0.591637(value #0),+0%,-0%,std-deviation=1.74537e-09)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    solve:                       4.3e-07s   (avg=4.3e-07,<span class="preprocessor">#measurements=1,max=4.3e-07(value #0),min=4.3e-07(value #0),+0%,-0%,std-deviation=3.29368e-15)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    map solution back onto mesh: 0.575858s  (avg=0.575858,<span class="preprocessor">#measurements=1,max=0.575858(value #0),min=0.575858(value #0),+0%,-0%,std-deviation=3.90214e-09)</span></div>
<div class="line">00:00:11    rank:0  ::::main()  info    plotting:                    1.03918s   (avg=1.03918,<span class="preprocessor">#measurements=1,max=1.03918(value #0),min=1.03918(value #0),+0%,-0%,std-deviation=7.62111e-09)</span></div>
<div class="ttc" id="abenchmarks_2other_2noh2d_2main_8cpp_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="../../d4/d76/benchmarks_2other_2noh2d_2main_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d76/benchmarks_2other_2noh2d_2main_8cpp_source.html#l00321">main.cpp:321</a></div></div>
</div><!-- fragment --><p>Furthermore, there should be patch files in our execution directory. One of them is called solution-Poisson.peano-patch-file and it is a meta file, i.e. it links to all the other files written by different ranks and threads on your parallel computer. You can inspect patch files in a text editor, and their format is described in the patch file format section.</p>
<p>To visualise the outcome, you can go down different paths. I have pvpython installed, i.e. Paraview with the Python terminal. In this case, we can type in</p>
<div class="fragment"><div class="line">/opt/paraview/bin/pvpython ~/git/Peano/python/<a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>/visualisation/render.py --filter-fine-grid solution-Poisson.peano-patch-file</div>
</div><!-- fragment --><p>which converts the patch files into a pvd file which we can open in Paraview.</p>
<h2><a class="anchor" id="autotoc_md628"></a>
What happens under the hood</h2>
<p>The multigrid project will yield a Peano project which in turn will create</p>
<ul>
<li>all the C++ code;</li>
<li>a main file;</li>
<li>a Makefile</li>
</ul>
<p>The main file realises one by one the different steps of a PETSc-based multigrid solver and therefore follows exactly <a class="el" href="../../d7/d01/peano_main.html">the vanilla Peano main file structure</a>. It runs through the algorithmic steps <br  />
 Per algorithmic step that we <a class="el" href="../../d2/d05/documentation_multigrid_petsc.html">find in any PETSc</a> project one by one. Per step, it issues one mesh traversal (besides for the actual solve, which is a single PETSc call). Per traversal, it hands in an observer.</p>
<p>The observers are created by the multigrid project petsc.Project. This class speaks of steps which is really what they are. The observer is the realisation of these steps. The steps that petsc.Project creates are more or less empty. When we invoke petsc.Project.add_solver(), the project takes the solver as passed as an argument and asks the solver to add action sets, i.e. activities, to each step. Each activity is a subclass of <a class="el" href="../../d8/d95/namespacepeano4_1_1solversteps_1_1ActionSet.html">peano4.solversteps.ActionSet</a>.</p>
<dl class="section see"><dt>See also</dt><dd>peano4.petsc.actionsets.InitVertexDoFs <a class="el" href="../../de/df3/CustomRiemann_8template_8h.html#a10aa502896b834c0d9eaeb3e8c8ab187">for</a> the actual initialisation phase.</dd></dl>
<h2><a class="anchor" id="autotoc_md629"></a>
Libraries</h2>
<p>We compile with flag -lpetsc to ensure that the PETSc-specific libraries are available to us. (not to be confused with -lPETSc). To ensure these are visible to the compiler, we must add</p>
<div class="fragment"><div class="line">-I$PETSC_DIR/include -I$PETSC_DIR/$PETSC_ARCH/include</div>
</div><!-- fragment --><p>to the CXXFLAGS. This assumes that PETSc is installed locally, and these environment variables are set up. Furthermore. we add the following to the LDFLAGS:</p>
<div class="fragment"><div class="line">-Wl,-rpath,$PETSC_DIR/$PETSC_ARCH/lib -L$PETSC_DIR/$PETSC_ARCH/lib -L/usr/lib/gcc/x86_64-linux-gnu</div>
</div><!-- fragment --><p>At time of writing, these can be seen in lines 788-815 of configure.ac, at the top level of Peano.</p>
<h1><a class="anchor" id="autotoc_md630"></a>
Internal workflow</h1>
<p>During EnumerateAndInit stage, we request one index in the LocalToGlobalMap for each degree of freedom. Each time this occurs, we increase the index count on each subtree. At the end of the traversal, we merge the LocalToGlobalMaps from each subtree back into the main map. We keep a std::map which tracks how many indices were used up by each subtree, so we can issue global Indices sequentially.</p>
<p>During InitVertexDof stage, we store each Value and Rhs that we encounter. When it comes to the InitPetsc stage, we send these values to PetscData class, which then uses these values to initialise two Petsc vectors. So far, we have implemented a method to return the values from the solution vector from PETSc back to C++. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/da3/page_multigrid_home.html">MGHyPE</a></li><li class="navelem"><a class="el" href="../../d4/d49/page_mghype_tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:59 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
