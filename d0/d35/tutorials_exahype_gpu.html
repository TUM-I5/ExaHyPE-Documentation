<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d0/d35/tutorials_exahype_gpu.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Adding GPU support</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md564">Compile with GPU support</a></li>
<li class="level1"><a href="#autotoc_md565">Pick a task-based solver</a></li>
<li class="level1"><a href="#autotoc_md566">Assess suitability</a></li>
<li class="level1"><a href="#autotoc_md567">Enable stateless compute kernels</a></li>
<li class="level1"><a href="#autotoc_md568">Provide the additional PDE terms without state</a></li>
<li class="level1"><a href="#autotoc_md569">Compile, run and check</a></li>
<li class="level1"><a href="#autotoc_md570">Tailor kernel choice</a></li>
<li class="level1"><a href="#autotoc_md571">Fuse tasks</a></li>
<li class="level1"><a href="#autotoc_md572">Advanced techniques</a><ul><li class="level2"><a href="#autotoc_md573">Select which octants (cells or patches) to ship to the GPU and back</a></li>
<li class="level2"><a href="#autotoc_md574">Write your own orchestration</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md575">Further reading</a></li>
</ul>
</div>
<div class="textblock"><div class="image">
<img src="../../gpus.png" alt=""/>
</div>
<p>ExaHyPE uses GPUs in a classic <em><b>offloading</b></em> mode: It takes particular tasks, ships them to the GPU and then ships them back. This happens under the hood, and neither does data reside on the accelerator permanently nor is the accelerator used all the time.</p>
<p>The whole approach assumes that there are computations (cell/patch updates) which can be done without any effect on global variables. It works if and only if we can ship a task to the GPU, and then get the solution data for this task back and no other global variabled changes. We furthermore assume that the computations that fit onto the GPU have no state. They can use some global, static variables, but they cannot access the solver's state which can change over time. We rely on code parts which <em>have no side effects and do not depend on the solver state</em> (minus global variables).</p>
<p>Working without side-effects might not work for all patches (Finite Volumes and Finite Differences) or octants (RKDG and ADER-DG) in your mesh: There are pieces of the mesh which evaluate and analyse some global data, or build up global data structures. In this case, ExaHyPE only offloads the remaining, simple patches/cotants to the GPU. That is, having a solver that supports patches/cells without side effects does not mean that all cells have to be side effect-free.</p>
<p>The second things to keep in mind is that ExaHyPE never offloads a single patch to the GPU. It can do, but this is then a degenerated variant of something way more generic: The code takes a set of octants from the mesh and moves them en bloc to the accelerator. There, one compute kernel updates all of these guys in one rush. We refer to this as <em><b>fused</b></em> updates.</p>
<p>The description above gives us a clear roadmap how to offload code in ExaHyPE to the accelerator:</p>
<h1><a class="anchor" id="autotoc_md564"></a>
Compile with GPU support</h1>
<p>Configure ExaHyPE with the argument <code>--with-gpu=xxx</code> and select an appropriate GPU programming model. Rebuild the whole Peano core. This includes the ExaHyPE libraries.</p>
<p>If you want to profile or optimise your code further, you might want to pick a particular vendor toolchain. See configure's help on &ndash;with-toolchain. The <a class="el" href="../../d1/d9e/tarch_logging.html">logging section</a> discusses variations of the toolchain support.</p>
<h1><a class="anchor" id="autotoc_md565"></a>
Pick a task-based solver</h1>
<p>The particular tasking concept that we implement in ExaHyPE is called enclave tasking. You find the vanilla paper of this idea in</p>
<div class="fragment"><div class="line">@article{doi:10.1137/19M1276194,</div>
<div class="line">  author = {Charrier, Dominic Etienne and Hazelwood, Benjamin and Weinzierl, Tobias},</div>
<div class="line">  title = {Enclave Tasking <span class="keywordflow">for</span> DG Methods on Dynamically Adaptive Meshes},</div>
<div class="line">  journal = {SIAM Journal on Scientific Computing},</div>
<div class="line">  volume = {42},</div>
<div class="line">  number = {3},</div>
<div class="line">  pages = {C69-C96},</div>
<div class="line">  year = {2020},</div>
<div class="line">  doi = {10.1137/19M1276194}</div>
<div class="line">}</div>
</div><!-- fragment --><p>Alternatively, each lowering into Peano yields a README-xxxxx.md file. In this markup file, you also find all the information of papers that have an influence on your chosen solver configuration. Solvers that support enclave tasking typically have a distinct name. exahype2.solvers.fv.godunov.GlobalAdaptiveTimeStepWithEnclaveTasking is for example a solver which yields tasks.</p>
<p>Once you have chosen such a solver and compile the code, there should be a tasks subdirectory after you've lowered your code to C++. It makes sense to look into this C++ code from time to time to check if the generated code does make sense.</p>
<h1><a class="anchor" id="autotoc_md566"></a>
Assess suitability</h1>
<p>Before we look into generated code or even start to implement something for GPUs, we should assess if there are any tasks that could, in theory, go to the accelerator.</p>
<div style="background-color: #fcc ; padding: 10px; border: 1px solid green;"> Many developers jump straight into accelerator programming and then are frustrated if ExaHyPE does not use the GPU and blame the code. Most of their time, they haven't done their homework: Peano always tries to maximise the CPU usage first before it offloads to the GPU. For tiny problems or unfortunate load balancing, the code hence might not use the GPU even though the code is, in principle, GPU-ready. This is a natural consequence of our aim to <b>minimise data movements</b>. If we don't have to ship data to the GPU, we don't do it! </div><p>Peano provides an ecosystem to assess to which degree a code might be suitable for an accelerator even before we start the porting:</p>
<ol type="1">
<li>Compile in the <a class="el" href="../../d1/d9e/tarch_logging.html">statistics mode</a>. This requires you to switch to <div class="fragment"><div class="line">project.set_Peano4_installation(..., <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../df/da1/namespacepeano4_1_1output.html">output</a>.<a class="code hl_namespace" href="../../d9/d5b/namespacepeano4_1_1output_1_1CompileMode.html">CompileMode</a>.Stats)</div>
<div class="ttc" id="anamespacepeano4_1_1output_1_1CompileMode_html"><div class="ttname"><a href="../../d9/d5b/namespacepeano4_1_1output_1_1CompileMode.html">peano4.output.CompileMode</a></div><div class="ttdef"><b>Definition</b> <a href="../../d1/d84/CompileMode_8py_source.html#l00001">CompileMode.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1output_html"><div class="ttname"><a href="../../df/da1/namespacepeano4_1_1output.html">peano4.output</a></div><div class="ttdef"><b>Definition</b> <a href="../../d2/d45/python_2peano4_2output_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --></li>
<li>Run the code. I recommend that you use a fairly short run, i.e. only a few time steps. The code will provide a statistics file: <div class="fragment"><div class="line"><a class="code hl_function" href="../../d7/d06/classtarch_1_1logging_1_1Statistics.html#a75a2d3245350032d8f5e8616b3493d8e">tarch::logging::Statistics::writeToCSV</a>(<span class="keywordtype">string</span>)          write statistics to file statistics-rank-0.csv (total no of entries=117)</div>
<div class="ttc" id="aclasstarch_1_1logging_1_1Statistics_html_a75a2d3245350032d8f5e8616b3493d8e"><div class="ttname"><a href="../../d7/d06/classtarch_1_1logging_1_1Statistics.html#a75a2d3245350032d8f5e8616b3493d8e">tarch::logging::Statistics::writeToCSV</a></div><div class="ttdeci">void writeToCSV(std::string filename=&quot;statistics&quot;)</div><div class="ttdoc">Write data to csv file.</div><div class="ttdef"><b>Definition</b> <a href="../../d6/da8/tarch_2logging_2Statistics_8cpp_source.html#l00169">Statistics.cpp:169</a></div></div>
</div><!-- fragment --></li>
<li>Peano's postprocessing comes along with several scripts to inspect and to postprocess the outcome. Inspect the statistics file <div class="fragment"><div class="line">python3 ~/git/Peano/python/<a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>/postprocessing/inspect-statistics.py statistics-rank-0.csv </div>
<div class="line">Column  | Counter</div>
<div class="line">--------|----------------</div>
<div class="line">0   |  time (always used to <a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>)</div>
<div class="line">2   |  mpi <a class="code hl_function" href="../../d9/d6d/exahype2_2solvers_2fv_2godunov_2kernels_2sycl_2Loop_8template_8h.html#a559a611b323ad3a61cfaf0ad580b6a29">wait</a> times</div>
<div class="line">3   |  tarch::multicore::bsp-concurrency-level</div>
<div class="line">4   |  tarch::multicore::spawned-tasks</div>
<div class="line">5   |  tarch::multicore::taskfusion::process-fused-tasks</div>
<div class="line">6   |  tarch::multicore::taskfusion::submit-fused-tasks</div>
<div class="line">7   |  grid-control-events</div>
<div class="ttc" id="aexahype2_2solvers_2fv_2godunov_2kernels_2sycl_2Loop_8template_8h_html_a559a611b323ad3a61cfaf0ad580b6a29"><div class="ttname"><a href="../../d9/d6d/exahype2_2solvers_2fv_2godunov_2kernels_2sycl_2Loop_8template_8h.html#a559a611b323ad3a61cfaf0ad580b6a29">wait</a></div><div class="ttdeci">event wait()</div></div>
<div class="ttc" id="anamespaceplot_html"><div class="ttname"><a href="../../de/d73/namespaceplot.html">plot</a></div><div class="ttdoc">-lift-drop-statistics</div></div>
</div><!-- fragment --> to find out which column gives you information about spawned tasks and all the fused tasks.</li>
<li>Visualise the number of tasks over time: <div class="fragment"><div class="line">python3 ~/git/Peano/python/<a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>/postprocessing/<a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>-statistics.py -c 4,5,6 -o pdf statistics-rank-0.csv</div>
<div class="line">python3 ~/git/Peano/python/<a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>/postprocessing/<a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>-statistics.py -c 5 -pt <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a> -o pdf statistics-rank-0.csv</div>
<div class="ttc" id="aMatrixFreeMain_8template_8cpp_html_ac6bf1a12c5c98ddec5b65e07fe74cabe"><div class="ttname"><a href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a></div><div class="ttdeci">void step()</div><div class="ttdef"><b>Definition</b> <a href="../../d5/db2/MatrixFreeMain_8template_8cpp_source.html#l00184">MatrixFreeMain.template.cpp:184</a></div></div>
</div><!-- fragment --></li>
</ol>
<p>If we get pictures similar to</p>
<div class="image">
<img src="../../gpu-statistics-00.png" alt=""/>
</div>
 <div class="image">
<img src="../../gpu-statistics-01.png" alt=""/>
</div>
<p>we face issues: Apparently the code does spawn a lot of tasks which could, in theory, be fused, but the fusion only ever takes one task at a time and deploys it. Consult the @tarch_logging "statistics page" for some more information on the plots.</p>
<p>In this example, we clearly don't produce tasks quickly enough. There are always some cores idling which snap away fusable tasks before they can accumulate on the host. Further to that, the scheduler changes its behaviour after some time and no tasks are produced at all anymore. These effects have to be studied and sorted out first, before we continue to try to offload to the GPU.</p>
<h1><a class="anchor" id="autotoc_md567"></a>
Enable stateless compute kernels</h1>
<p>You next have to instruct your solver that you plan to have patch or cell updates without (write) access to the solver's internal state. They also don't alter the global state. Obviously, you can weaken these assumptions later on, but this then requires further manual work.</p>
<p>The Finite Volume enclave solvers for example all support stateless kernels, but the versions without enclave tasking do not support them. The solver documentation should clarify which one to select. For most of these GPU-enabled solvers, it is sufficient to pass an additional flag</p>
<div class="fragment"><div class="line">pde_terms_without_state=True</div>
</div><!-- fragment --><p>into the constructor that tells the solver that we have <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> terms which have no side effect which also do not need the solver object. Consult the documentation of the respective solvers. Again, exahype2.solvers.fv.godunov.GlobalAdaptiveTimeStepWithEnclaveTasking is a good prototype to study:</p>
<div class="fragment"><div class="line">my_solver = <a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d0/d4e/namespaceexahype2_1_1solvers.html">solvers</a>.<a class="code hl_namespace" href="../../de/d1e/namespaceexahype2_1_1solvers_1_1fv.html">fv</a>.<a class="code hl_namespace" href="../../dc/d57/namespaceexahype2_1_1solvers_1_1fv_1_1godunov.html">godunov</a>.GlobalAdaptiveTimeStepWithEnclaveTasking(</div>
<div class="line">            name= <span class="stringliteral">&quot;GPUFVSolver&quot;</span>,</div>
<div class="line">            patch_size=18,</div>
<div class="line">            min_volume_h=0.0001,</div>
<div class="line">            max_volume_h=0.01,</div>
<div class="line">            pde_terms_without_state=True, # This <a class="code hl_struct" href="../../d3/d20/structpart.html">part</a> is the relevant one here</div>
<div class="line">        )</div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_1_1fv_1_1godunov_html"><div class="ttname"><a href="../../dc/d57/namespaceexahype2_1_1solvers_1_1fv_1_1godunov.html">exahype2.solvers.fv.godunov</a></div><div class="ttdef"><b>Definition</b> <a href="../../da/dfd/python_2exahype2_2solvers_2fv_2godunov_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_1_1fv_html"><div class="ttname"><a href="../../de/d1e/namespaceexahype2_1_1solvers_1_1fv.html">exahype2.solvers.fv</a></div><div class="ttdef"><b>Definition</b> <a href="../../d6/d91/python_2exahype2_2solvers_2fv_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_html"><div class="ttname"><a href="../../d0/d4e/namespaceexahype2_1_1solvers.html">exahype2.solvers</a></div><div class="ttdef"><b>Definition</b> <a href="../../d8/d91/python_2exahype2_2solvers_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_html"><div class="ttname"><a href="../../dd/d6c/namespaceexahype2.html">exahype2</a></div><div class="ttdoc">For the generic kernels that I use here most of the time.</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d65/CellAccess_8h_source.html#l00013">CellAccess.h:13</a></div></div>
<div class="ttc" id="astructpart_html"><div class="ttname"><a href="../../d3/d20/structpart.html">part</a></div><div class="ttdoc">Particle fields for the SPH particles.</div><div class="ttdef"><b>Definition</b> <a href="../../d8/d86/hydro__part_8h_source.html#l00099">hydro_part.h:99</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md568"></a>
Provide the additional PDE terms without state</h1>
<p>To faciliate the offloading, we have to create alternative versions of our <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> term functions that can work independent of the solver object (and in return cannot modify it). Depending on which terms we have, we'll need stateless versions of the flux, the non-conservative product and the source term. We'll always needs the eigenvalue function. Per function, keep the original one and add a second one which is</p>
<ul>
<li>static;</li>
<li>accepts an additional flag of type <code>Offloadable</code>. This is the last argument, i.e. a static version of a function has exactly the same arguments as the non-static, default variant but then has one more argument. The last argument is solely there to be able to distinguish the static version from the normal one, as C++ cannot overload w.r.t. static vs. not static. <code>Offloadable</code> is automatically defined in the abstract base class which 's Python API generates.</li>
<li>is embedded into <div class="fragment"><div class="line"><span class="preprocessor">#if defined(OpenMPGPUOffloading) </span></div>
<div class="line"><span class="preprocessor">#pragma omp declare target</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">my <span class="keyword">new</span> <span class="keyword">static</span> function variants</div>
<div class="line"><span class="preprocessor">#if defined(OpenMPGPUOffloading) #pragma omp end declare target</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --> Though you can leave the declare annotations away if you use SYCL only.</li>
</ul>
<p>Very often, the standard flux and eigenvalue routines can invoke the static variants and you can thus eliminate code redundancies. For example, you might have the normal flux function and a static flux function with the additional <code>Offloadable</code> parameter, but the normal function just invokes the static cousin.</p>
<p>In many of our codes, we take a function like</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> examples::exahype2::SSInfall::SSInfall::flux( ... ) {</div>
<div class="line">  <a class="code hl_define" href="../../d1/d45/Log_8h.html#a7875e6edbdc4665a08c6a2e36e45ec86">logTraceInWith4Arguments</a>( <span class="stringliteral">&quot;flux(...)&quot;</span>, x, h, t, normal );</div>
<div class="line"> </div>
<div class="line">  compute something;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="../../d1/d45/Log_8h.html#aa0dd74b7ec0d5a30f0254f28e16611de">logTraceOutWith4Arguments</a>( <span class="stringliteral">&quot;flux(...)&quot;</span>, x, h, t, normal );</div>
<div class="line">}</div>
<div class="ttc" id="aLog_8h_html_a7875e6edbdc4665a08c6a2e36e45ec86"><div class="ttname"><a href="../../d1/d45/Log_8h.html#a7875e6edbdc4665a08c6a2e36e45ec86">logTraceInWith4Arguments</a></div><div class="ttdeci">#define logTraceInWith4Arguments(methodName, argument0, argument1, argument2, argument3)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d45/Log_8h_source.html#l00373">Log.h:373</a></div></div>
<div class="ttc" id="aLog_8h_html_aa0dd74b7ec0d5a30f0254f28e16611de"><div class="ttname"><a href="../../d1/d45/Log_8h.html#aa0dd74b7ec0d5a30f0254f28e16611de">logTraceOutWith4Arguments</a></div><div class="ttdeci">#define logTraceOutWith4Arguments(methodName, argument0, argument1, argument2, argument3)</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d45/Log_8h_source.html#l00383">Log.h:383</a></div></div>
</div><!-- fragment --><p>and simply split it into two variants:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> examples::exahype2::SSInfall::SSInfall::flux( ... ) {</div>
<div class="line">  <a class="code hl_define" href="../../d1/d45/Log_8h.html#a7875e6edbdc4665a08c6a2e36e45ec86">logTraceInWith4Arguments</a>( <span class="stringliteral">&quot;flux(...)&quot;</span>, x, h, t, normal );</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../db/dc1/GenericRusanov_8template_8h.html#a8601275e9edc6c7ee34fb2aeb1ee71f5">flux</a>(Q,x,h,t,normal,F,Offloadable::Yes);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="../../d1/d45/Log_8h.html#aa0dd74b7ec0d5a30f0254f28e16611de">logTraceOutWith4Arguments</a>( <span class="stringliteral">&quot;flux(...)&quot;</span>, x, h, t, normal );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> examples::exahype2::SSInfall::SSInfall::flux( ..., Offloadable ) {</div>
<div class="line">  compute something;</div>
<div class="line">}</div>
<div class="ttc" id="aGenericRusanov_8template_8h_html_a8601275e9edc6c7ee34fb2aeb1ee71f5"><div class="ttname"><a href="../../db/dc1/GenericRusanov_8template_8h.html#a8601275e9edc6c7ee34fb2aeb1ee71f5">flux</a></div><div class="ttdeci">solver flux(QInGatheredRight, volumeCentreRight, volumeSize, timeStamp, timeStepSize, normal, fluxGatheredRight)</div></div>
</div><!-- fragment --><p>The static version is used on the GPU. The normal one is used on the CPU yet defers immediately to the static version. Please note that GPUs are quite restrictive w.r.t. terminal outputs and assertions. You will have to remove both from your static routine versions. In the example above, the non-static version wraps the core functionality into assertions. Therefore, we have the assertions on the CPU, but the core part that goes to the GPU is free of assertions. The same holds for the logging.</p>
<div style="background-color: #cfc ; padding: 10px; border: 1px solid green;"> Most ExaHyPE solvers allow you to insert the realisation of a routine directly from the Python code. In this case, both calls end up the AbstractMySolver class: the default variant and the stateless variant, too. </div><h1><a class="anchor" id="autotoc_md569"></a>
Compile, run and check</h1>
<p>In principle, the code is now GPU ready. Compile and run.</p>
<h1><a class="anchor" id="autotoc_md570"></a>
Tailor kernel choice</h1>
<p>Most ExaHyPE solvers employ at least three different kernel variations: a normal one, one that vectorises aggressively on the host, and one that offloads to the GPU. If you use the default configuration, all should be set to some reasonable defaults. If this is not the case, you can manually alter </p><pre class="fragment">    self._fused_compute_kernel_call_cpu
    self._fused_compute_kernel_call_gpu
</pre><p> These values hold C++ strings, which are typically method invocations to the corresponding computing kernels. If you play around with these values, you might want to study <a class="el" href="../../d1/d26/page_exahype_gpu.html">further GPU realisation details</a> and dive into the code.</p>
<h1><a class="anchor" id="autotoc_md571"></a>
Fuse tasks</h1>
<p>Finally, we might want to tailor the fusion of tasks. For example, you might want to offload to the GPU if and only if there are enough tasks that you can bundle (fuse) into one meta task. Of you might want to use different GPUs depending on the task context. These decisions are made by the multithreading orchestration (among other things).</p>
<p>You can switch the orchestration manually in your C++ file. By default, the initialisation of ExaHyPE does this:</p>
<div class="fragment"><div class="line">tarch::multicore::setOrchestration( tarch::multicore::orchestration::createDefaultStrategy() );</div>
</div><!-- fragment --><p>You can alter this one. A more elegant variant is likely that you use exahype2.Project.set_multicore_orchestration() to let the lowering into Peano automatically insert an appropriate setOrchestration() call. The namespace tarch::multicore::orchestration holds a bundle of different orchestration strategies that you can use to tweak your code. A good starting point is</p>
<div class="fragment"><div class="line">my_project.set_multicore_orchestration( <span class="stringliteral">&quot;new otherOrchestration(...)&quot;</span> )</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md572"></a>
Advanced techniques</h1>
<h2><a class="anchor" id="autotoc_md573"></a>
Select which octants (cells or patches) to ship to the GPU and back</h2>
<p>If only some patches/cells can be offloaded to the GPU, then you can redefine the routine</p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">bool</span> patchCanUseStatelessPDETerms( </div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_struct" href="../../d7/d26/structtarch_1_1la_1_1Vector.html">tarch::la::Vector&lt;Dimensions,double&gt;</a>&amp;  x, </div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_struct" href="../../d7/d26/structtarch_1_1la_1_1Vector.html">tarch::la::Vector&lt;Dimensions,double&gt;</a>&amp;  h, </div>
<div class="line">  <span class="keywordtype">double</span> t, </div>
<div class="line">  <span class="keywordtype">double</span> dt </div>
<div class="line">) <span class="keyword">const</span>;</div>
<div class="ttc" id="astructtarch_1_1la_1_1Vector_html"><div class="ttname"><a href="../../d7/d26/structtarch_1_1la_1_1Vector.html">tarch::la::Vector</a></div><div class="ttdoc">Simple vector class.</div><div class="ttdef"><b>Definition</b> <a href="../../d6/dbe/Vector_8h_source.html#l00084">Vector.h:84</a></div></div>
</div><!-- fragment --><p>in your solver. By default, this routine returns <code>true</code>. This default is written in the AbstractXXX solver. But nothing stops you from redefining the function in your particular solver subclass.</p>
<h2><a class="anchor" id="autotoc_md574"></a>
Write your own orchestration</h2>
<p>Very advanced codes write their own orchestration which ships particular tasks specifically to the GPU. Through this, you can tailor the task execution pattern towards your specific needs. Notably, the orchestration is asked per task type whether and where to ship the task.</p>
<h1><a class="anchor" id="autotoc_md575"></a>
Further reading</h1>
<ul>
<li>Switch to a toolchain for your particular GPU backend. Information on this can be found at <a class="el" href="../../d1/d9e/tarch_logging.html">Logging, tracing, statistics, profiling and assertions</a>.</li>
<li>Consult the <a class="el" href="../../d7/dfe/page_exahype_performance_optimisation.html">The code does not use all cores</a> discussion.</li>
<li><a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html">The multicore layer in the technical architecture</a></li>
<li><a class="el" href="../../d1/d26/page_exahype_gpu.html">GPU support (and aggressive vectorisation)</a> provides a more technical discussion of the GPU offloading </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li><li class="navelem"><a class="el" href="../../d8/d60/page_exahype2_tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:58 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
