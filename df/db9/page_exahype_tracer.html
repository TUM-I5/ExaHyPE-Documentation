<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('df/db9/page_exahype_tracer.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tracers</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ExaHyPE's tracers rely on Peano's particle and particle-in-dual-tree mechanism. They connect ExaHyPE with a completely different toolbox of Peano. To add tracer support for , you first have to reconfigure our run and add the</p>
<div class="fragment"><div class="line">./configure ... --enable-particles</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md914"></a>
Add tracers to project</h2>
<p>Adding tracers is fairly simple. Each tracer has to have a name, and you also have to inform the project how many attributes you plan to track per tracer:</p>
<div class="fragment"><div class="line">tracer_particles = project.add_tracer( name=<span class="stringliteral">&quot;MyFancyParticle&quot;</span> )</div>
</div><!-- fragment --><p>Study the in-code documentation of the involved classes. The exahype2.Project.add_tracer() factory method ensure that ExaHyPE keeps track of it and that it also is printed whenever we write a snapshot. Tracers can track only some attributes, they can move or stay at one place, and they can also interact with each other.</p>
<p>Next, you have add a few action sets to ExaHyPE's solver steps:</p>
<div class="fragment"><div class="line">project.add_action_set_to_initialisation( <a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d6/d49/namespaceexahype2_1_1tracer.html">tracer</a>.<a class="code hl_namespace" href="../../d1/d1e/namespaceexahype2_1_1tracer_1_1InsertParticlesByCoordinates.html">InsertParticlesByCoordinates</a>( </div>
<div class="line">  particle_set=tracer_particles, </div>
<div class="line">  coordinates=[ [x,x,x], [x,x,x] ]</div>
<div class="line">  ))</div>
<div class="ttc" id="anamespaceexahype2_1_1tracer_1_1InsertParticlesByCoordinates_html"><div class="ttname"><a href="../../d1/d1e/namespaceexahype2_1_1tracer_1_1InsertParticlesByCoordinates.html">exahype2.tracer.InsertParticlesByCoordinates</a></div><div class="ttdef"><b>Definition</b> <a href="../../d1/d04/exahype2_2tracer_2InsertParticlesByCoordinates_8py_source.html#l00001">InsertParticlesByCoordinates.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1tracer_html"><div class="ttname"><a href="../../d6/d49/namespaceexahype2_1_1tracer.html">exahype2.tracer</a></div><div class="ttdef"><b>Definition</b> <a href="../../d9/dbc/python_2exahype2_2tracer_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_html"><div class="ttname"><a href="../../dd/d6c/namespaceexahype2.html">exahype2</a></div><div class="ttdoc">For the generic kernels that I use here most of the time.</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d65/CellAccess_8h_source.html#l00013">CellAccess.h:13</a></div></div>
</div><!-- fragment --><p>In this example, we add the actual tracer insertion to the initialisation. There are different inserters shipped with ExaHyPE. Alternatively, you might want to write your own, bespoke particle seed. There are seeds which insert tracers along a Cartesian topology, adds some random noise, or read tracer positions from a file.</p>
<p>Once inserted, you can run your code and visualise the particles. However, these particles do not track the actual data of interest. To facilitate this, you have to map your solution onto the particle first.</p>
<div class="fragment"><div class="line">my_tracing = <a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d6/d49/namespaceexahype2_1_1tracer.html">tracer</a>.<a class="code hl_namespace" href="../../d4/d81/namespaceexahype2_1_1tracer_1_1FiniteVolumesTracing.html">FiniteVolumesTracing</a>(tracer_particles,</div>
<div class="line">                                                thesolver,</div>
<div class="line">                                                project_on_tracer_properties_kernel=<span class="stringliteral">&quot;::exahype2::fv::projectAllValuesOntoParticle_piecewiseLinear&quot;</span></div>
<div class="line">                                                )</div>
<div class="line">project.add_action_set_to_timestepping( my_tracing )</div>
<div class="line">project.add_action_set_to_initialisation( my_tracing )                                                </div>
<div class="ttc" id="anamespaceexahype2_1_1tracer_1_1FiniteVolumesTracing_html"><div class="ttname"><a href="../../d4/d81/namespaceexahype2_1_1tracer_1_1FiniteVolumesTracing.html">exahype2.tracer.FiniteVolumesTracing</a></div><div class="ttdef"><b>Definition</b> <a href="../../dd/d97/FiniteVolumesTracing_8py_source.html#l00001">FiniteVolumesTracing.py:1</a></div></div>
</div><!-- fragment --><p>Let <code>thesolver</code> be your  solver instance in the Python script. Not all solvers currently support tracers (efficiently), but we are continuously improving the tracer support. With the solver instance and the tracers, we can couple the two ingredients. You have to pick different coupling schemes depending on the type of your solver. Again, there are different interpolation schemes shipped with ExaHyPE. Please note that you will have to pick an interpolation that fits to your solver. In the snippet above, we use a Finite Volume solver and therefore pick a projection from the <code><a class="el" href="../../d5/dd9/namespaceexahype2_1_1fv.html">exahype2::fv</a></code> namespace. Other discretisations will require other interpolation schemes.</p>
<p>It is clear that you have to add the tracing to the time stepping. After each step, you want to have an updated solution dumped into the tracer. Further to that, we add the tracing to the initialisation. If we forget to do this, we will have garbage within the tracer prior to the first time step. If we don't dump the initial conditions, you don't have to care about this step.</p>
<ul>
<li>See <a class="el" href="../../d2/d29/exahype2_2fv_2Tracer_8h.html">exahype2/fv/Tracer.h</a> for an overview of pre-defined routines that map the solution data from Finite Volumes onto particles. As our Finite Differences scheme is a cell-centered block-structured discretisation, these routines all work for fd / Finite Differences, too.</li>
<li>See <a class="el" href="../../d0/d7b/exahype2_2dg_2Tracer_8h.html">exahype2/dg/Tracer.h</a> for an overview of pre-defined routines that map the solution data from Discontinuous Galerkin solvers onto particles. These routines also work for ADER-DG.</li>
</ul>
<h2><a class="anchor" id="autotoc_md915"></a>
Dump tracer data into CSV database</h2>
<p>ExaHyPE's particle handling comes along with a set of standard postprocessing scripts. As we rely on this toolbox, you can use those scripts straightaway. They can be found in the directory peano4/toolbox/particles/postprocessing. To use it, you have to track data.</p>
<p>The likely most important tool for many developers using only few particles is the fact that particles can dump their solution into a database:</p>
<div class="fragment"><div class="line">project.add_action_set_to_timestepping(<a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d6/d49/namespaceexahype2_1_1tracer.html">tracer</a>.<a class="code hl_namespace" href="../../d1/dca/namespaceexahype2_1_1tracer_1_1DumpTracerIntoDatabase.html">DumpTracerIntoDatabase</a>(</div>
<div class="line">  particle_set=tracer_particles,</div>
<div class="line">  solver=self,</div>
<div class="line">  filename=<span class="stringliteral">&quot;Tracer-&quot;</span> + name,</div>
<div class="line">  number_of_entries_between_two_db_flushes=5000,</div>
<div class="line">  output_precision=10,</div>
<div class="line">  data_delta_between_two_snapsots=1e16,</div>
<div class="line">  time_delta_between_two_snapsots=0.01</div>
<div class="line">  ))</div>
<div class="ttc" id="anamespaceexahype2_1_1tracer_1_1DumpTracerIntoDatabase_html"><div class="ttname"><a href="../../d1/dca/namespaceexahype2_1_1tracer_1_1DumpTracerIntoDatabase.html">exahype2.tracer.DumpTracerIntoDatabase</a></div><div class="ttdef"><b>Definition</b> <a href="../../d0/d6e/DumpTracerIntoDatabase_8py_source.html#l00001">DumpTracerIntoDatabase.py:1</a></div></div>
</div><!-- fragment --><p>Dumping tracers into a (CSV) database is attractive, as these files are easier to parse/postprocess than mesh data files. At the same time, you can dump particles more often than you plot data snapshots, and these dumps can even be adaptive, i.e. you dump if and only if a particle actually moves. The <a class="el" href="../../d1/dca/namespaceexahype2_1_1tracer_1_1DumpTracerIntoDatabase.html">exahype2.tracer.DumpTracerIntoDatabase</a> documentation provides more detail.</p>
<p>The data format within the csv file is rather self-explaining.</p>
<ul>
<li>Each particle has a unique two-tuple of indices. We do not enumerate the particles globally, but instead give them two numbers. The first one is the tree that has originally generated a particle, and the second number then is a continuous number, i.e. counts the particles per tree. As we have two numbers, we don't have to synchronise any global particle generation. Note that the two-tuple stays invariant per particle. Therefore, a particle might be the 12th that's generated on tree 7, and hence carry the index (7,11). If it moves around, it might as well end up on three 4.</li>
<li>Each particle entry is equipped with a time stamp.</li>
<li>Each particle entry is equipped with the coordinates of the particle per particle dump. If particles do not move, this is redundant information.</li>
<li>Each particle entry then enlists all the particle's data values at the time when we dump.</li>
</ul>
<p>As we rely on Peano's infrastructure, you can use the script <a class="el" href="../../d7/dc1/convert_8py.html">python/peano4/toolbox/particles/postprocessing/convert.py</a> to convert the output files or to produce seismograms, e.g. Please note that each rank potentially writes sequences of databases, i.e. whenever we dump a csv file, we clear the internal database. So when you visualise the data, you have to concatenate databases first. This is also explained in the underlying C++ class <a class="el" href="../../dc/d84/classtoolbox_1_1particles_1_1TrajectoryDatabase.html" title="A simple particle database.">toolbox::particles::TrajectoryDatabase</a>. As the <a class="el" href="../../d7/dc1/convert_8py.html">convert.py</a> script above does support multiple input files, the merge itself is already supported by premanufactured tools.</p>
<h2><a class="anchor" id="autotoc_md916"></a>
Make tracers move</h2>
<p>Every tracer particle has a unique position identified by a tracer argument x of type <a class="el" href="../../d7/d26/structtarch_1_1la_1_1Vector.html" title="Simple vector class.">tarch::la::Vector</a>. In ExaHyPE, the project_on_tracer_properties_kernel argument within the tracer projection is allowed to alter the particle data as well as the particle position. You can make the particles move.</p>
<p>To achieve this, you have to create your own project_on_tracer_properties_kernel. You then pass in this kernel instead of a premanufactured one:</p>
<div class="fragment"><div class="line">project.add_action_set_to_timestepping(<a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d6/d49/namespaceexahype2_1_1tracer.html">tracer</a>.<a class="code hl_namespace" href="../../d4/d81/namespaceexahype2_1_1tracer_1_1FiniteVolumesTracing.html">FiniteVolumesTracing</a>(tracer_particles,</div>
<div class="line">                                                self,</div>
<div class="line">                                                project_on_tracer_properties_kernel=<span class="stringliteral">&quot;::mynamespace::mykernel&quot;</span></div>
<div class="line">                                                ))</div>
</div><!-- fragment --><p>If the arguments that the default kernel accepts are not sufficient or a fit, you can define your own arguments by setting the tracer action set's projection_kernel_arguments string. This notably allows you to read out the time stamp associated with a cell:</p>
<div class="fragment"><div class="line">project.add_action_set_to_timestepping(<a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d6/d49/namespaceexahype2_1_1tracer.html">tracer</a>.<a class="code hl_namespace" href="../../d4/d81/namespaceexahype2_1_1tracer_1_1FiniteVolumesTracing.html">FiniteVolumesTracing</a>(tracer_particles,</div>
<div class="line">                                                self,</div>
<div class="line">                                                project_on_tracer_properties_kernel=<span class="stringliteral">&quot;::mynamespace::mykernel&quot;</span>,</div>
<div class="line">                                                projection_kernel_arguments=<span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">  other args,                                             </span></div>
<div class="line"><span class="stringliteral">  fineGridCell{{SOLVER_NAME}}CellLabel.getTimeStepSize()</span></div>
<div class="line"><span class="stringliteral">  &quot;</span><span class="stringliteral">&quot;&quot;</span></div>
<div class="line">                                                ))</div>
</div><!-- fragment --><p>It would be possible to provide a lot of pre-manufactured kernels, but I do not do this, as any sophisticated time stepping for example requires the update to query the underlying solution field multiple times at different positions, and this is something that cannot be covered in a generic way.</p>
<p>The only exception to the rule are a few extensions of the generic mapping routines with an explicit Euler which takes mapped data values on the particle and reads them as velocities. This is a very simple, special case. See the files <a class="el" href="../../d2/d29/exahype2_2fv_2Tracer_8h.html">exahype2/fv/Tracer.h</a> and <a class="el" href="../../d0/d7b/exahype2_2dg_2Tracer_8h.html">exahype2/dg/Tracer.h</a>.</p>
<p>We emphasise that nothing stops users from additing additional fields to the particles such as mass and acceleration, and to implement a time stepping using those quantities. Basically, nothing from the infrastructure's point of view stops users from implementing their Particle-in-Cell code.</p>
<h3><a class="anchor" id="autotoc_md917"></a>
Encourage particles to spread out evenly</h3>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000070">Todo</a></b></dt><dd>Requires update/revision</dd></dl>
<p>You can make particles interact with eac other. This allows you, for example, to realise some SPH on top of the code. One of the most convenient features is to encourage tracers to align in a quasi-uniform way, i.e. they do follow the solution characteristics but at the same time try to space out evenly. This is allowed via a modified, inverted Lennard-Jones potential which is parameterised with a distance. If two particles are closer than that distance, they repulse each other. If they are further away than that distance, they attract each other.</p>
<p>There are further particle-particle interaction scripts in the repository. If you want your particles to move, you have to ensure that they are sorted into the mesh properly, and that they are exchanged between subpartitions via MPI and shared memory. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:04 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
