<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d2/d05/documentation_multigrid_petsc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Peano 4 PETSc projects</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A PETSc project is a wrapper around Peano 4 project, i.e. it holds a Peano 4 Python project. Each call to the PETSc API builds up an internal data representation which is eventually mapped onto a native Peano 4 project. To use PETSc with Peano, you need to configure it with</p>
<div class="fragment"><div class="line">./configure --enable-finiteelements --with-<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a></div>
<div class="ttc" id="anamespacepetsc_html"><div class="ttname"><a href="../../dc/d24/namespacepetsc.html">petsc</a></div><div class="ttdef"><b>Definition</b> <a href="../../db/d10/LinearEquationSystem_8h_source.html#l00019">LinearEquationSystem.h:19</a></div></div>
</div><!-- fragment --><p>and you will need to make additions to CXXFLAGS and LDFLAGS to ensure that we can compile with PETSc and link appropriately:</p>
<div class="fragment"><div class="line">./configure CXXFLAGS=<span class="stringliteral">&quot;... -I$PETSC_DIR/include&quot;</span> LDFLAGS=<span class="stringliteral">&quot;... -Wl,-rpath,$PETSC_DIR/lib -L$PETSC_DIR/lib&quot;</span> $LIBS=<span class="stringliteral">&quot;... -lpetsc&quot;</span></div>
</div><!-- fragment --><p>Where PETSC_DIR points to your PETSc installation as passed into prefix (see remarks below). Alteratively, replace PETSC_DIR with the path from above directly. Please do not omit the -Wl,... parts. If you do so, your code will link, but you'll get seg fault the very moment you try to allocate any PETSc object. Once the flags are in, any Peano Python script will pick up the right paths automatically.</p>
<p>Please note that most off-the-shelf PETSc packages in mainstream Linux distributions such as Ubuntu are compiled with MPI. That is, you will have to use MPI for Peano as well, as PETSc otherwise will complain.</p>
<p>In principle, that's all you have to do. In practice, getting PETSc to work can be cumbersome. The flag above assumes that you have PETSc ready-to-use on your system (through a module file, e.g.). If this is not the case or if you want to use another software stack than the one used by PETSc (different compiler, e.g., or no MPI), you will need to follow some of the steps below.</p>
<h1><a class="anchor" id="autotoc_md979"></a>
Preparing PETSc on your system</h1>
<h2><a class="anchor" id="autotoc_md980"></a>
Downloading PETSc for your distribution</h2>
<p>Most Linux distribution offer PETSc off-the-shelf through their package managers. These versions should be absolutely sufficient for our work within Peano.</p>
<ul>
<li>Ubuntu: Install <pre class="fragment">    apt install petsc-dev
</pre> and then set <pre class="fragment">    export PETSC_DIR=/usr/lib/petscdir/petsc3.15/x86_64-linux-gnu-real
</pre> or similar. <br  />
</li>
</ul>
<p>The problem with these pre-manufactured PETSc installations is that they are built against one specific MPI implementation picked by the distribution. If you want to use a different MPI (or no MPI at all), you will likely run into problems and have to build your own PETSc version at one point.</p>
<h2><a class="anchor" id="autotoc_md981"></a>
Build PETSc locally</h2>
<p>Alternatively, you can grab PETSc directly from the sources. The steps are summarised on their website (<a href="https://petsc.org/release/install/download/">https://petsc.org/release/install/download/</a>), but we will summarise the important ones here.</p>
<ol type="1">
<li><p class="startli">Clone their repo. It's best to do this somewhere away from the Peano directory.</p>
<div class="fragment"><div class="line">git clone -b release https:<span class="comment">//gitlab.com/petsc/petsc.git petsc</span></div>
</div><!-- fragment --></li>
<li><p class="startli">Change into this directory.</p>
<div class="fragment"><div class="line">cd <a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a></div>
</div><!-- fragment --></li>
<li><p class="startli">Run the configure script inside the PETSc directory:</p>
<div class="fragment"><div class="line">./configure --with-cc=(C-COMPILER) --with-cxx=(C++-COMPILER) --with-fc=0  --with-mpi=0 --prefix=/opt/<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a></div>
</div><!-- fragment --><p class="startli">The command above disables the Fortran support and also MPI. The prefix</p>
</li>
<li><p class="startli">Compile the actual code:</p>
<div class="fragment"><div class="line">make</div>
</div><!-- fragment --></li>
<li><p class="startli">Install PETSc:</p>
<div class="fragment"><div class="line">make install</div>
</div><!-- fragment --></li>
</ol>
<p>PETSc's documentation makes a lot of fuss around various architectures and systems, but I usually keep things simple. You might however prefer more sophisticated calls such as</p>
<div class="fragment"><div class="line">make PETSC_DIR=/path/to/<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a> PETSC_ARCH=system_architecture all</div>
</div><!-- fragment --><p>\but most of the time, I don't need these.</p>
<p>From hereon, we will use a variable PETSC_DIR which is the prefix directory. In the example above we would have</p>
<div class="fragment"><div class="line"><span class="keyword">export</span> PETSC_DIR=/opt/<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a></div>
</div><!-- fragment --><p>Whenever we use PETSC_DIR, you can replace it with the real path if you don't want to work with additional variables. However, the PETSc guidelines recommend that you stick to the variable. As we need it all the time, it might even be worth adding PETSC_DIR and PETSC_ARCH to .bashrc / .bash_profile.</p>
<h2><a class="anchor" id="autotoc_md982"></a>
Amend libraries and search paths</h2>
<p>On most systems, the simple manipulation of the three flags CXXFLAGS, LDFLAGS and LIBS should be sufficient. However, you might need some more complex manipulations. Key insight here is that, depending on how PETSc itself is built, it will itself need further libraries. You can find a lot of these in the file $PETSC_DIR/lib/petsc/conf/variables. The build command also reports on those just after the compile has finished.</p>
<p>If you need further flags, you typically add</p>
<div class="fragment"><div class="line">CXXFLAGS=<span class="stringliteral">&quot;(...) -I$PETSC_DIR/include -I$PETSC_DIR/$PETSC_ARCH/include&quot;</span></div>
<div class="line">LDFLAGS=<span class="stringliteral">&quot;(...) -lpetsc -Wl,-rpath,$PETSC_DIR/$PETSC_ARCH/lib -L$PETSC_DIR/$PETSC_ARCH/lib -L/path/to/gcc/libraries  &quot;</span></div>
</div><!-- fragment --><p>The first flag here comes from PETSc itself, and requires PETSC_DIR and PETSC_ARCH to be established already. The last flag is the path to the gcc runtime libraries. As an example, on a local machine, this libary looks like:</p>
<div class="fragment"><div class="line">-L/usr/lib/gcc/x86_64-linux-gnu</div>
</div><!-- fragment --><p>We can then put these together:</p>
<div class="fragment"><div class="line">./configure ... --enable-finiteelements --with-<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a> CXXFLAGS=$(CXXFLAGS) LDFLAGS=$(LDFLAGS)</div>
</div><!-- fragment --><p>The following is an example call to the configure script that works on cosma (assuming the environment variables are present). We use the intel compiler.</p>
<div class="fragment"><div class="line">./configure CC=icc CXX=icpx --enable-loadbalancing --enable-exahype --enable-blockstructured --enable-finiteelements --with-mpi=mpiicpc --with-multithreading=omp --with-<a class="code hl_namespace" href="../../dc/d24/namespacepetsc.html">petsc</a> CXXFLAGS=<span class="stringliteral">&quot;--std=c++20 -w -fopenmp -g -funroll-loops -O3 -g3 -I$PETSC_DIR/include -I$PETSC_DIR/$PETSC_ARCH/include&quot;</span> LDFLAGS=<span class="stringliteral">&quot;-fopenmp -Wl,-rpath,$PETSC_DIR/$PETSC_ARCH/lib -L$PETSC_DIR/$PETSC_ARCH/lib -L/cosma/local/gcc/11.1.0/lib64 -lpetsc&quot;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md983"></a>
Typical PETSc code structure</h1>
<h2><a class="anchor" id="autotoc_md984"></a>
Algorithmic steps</h2>
<p>Each PETSc project consists of the following steps:</p>
<ol type="1">
<li>Create the mesh. The mesh construction (and the associated load balancing) can require multiple mesh sweeps, so this logical step can be realised through multiple grid traversals.</li>
<li>Enumerate all the grid entities, i.e. assign each vertex/face/cell (depending on solver type) a unique number. This step is realised through petsc.actionsets.EnumerateDoFs. This one realises the <a class="el" href="../../d8/d87/documentation_multigrid_boundary_conditions.html">boundary conditions</a>. Once complete, we know the dimensions of the global matrices and vectors.</li>
<li>Initialise the mesh, i.e. assign each vertex/face/cell a value if the value is fixed and otherwise a right-hand side and material parameters. Depending on the discretisation, the steps are realised by different action sets such as petsc.actionsets.InitVertexDoFs.</li>
<li>Initialise PETSc. Inform the library on the size of the required matrices and vectors. This step does not require a mesh traversal of its own.</li>
<li>Assemble the linear equation system and the right-hand side. This is the tricky part and depends strongly the solver type chosen. Therefore, the assembly is typically tied to the particular solver class, i.e. can be found in the same source code file.</li>
<li>Invoke PETSc's solver. This step does not require a mesh traversal.</li>
<li>Run over the mesh and copy the outcome of the PETSc solve into the mesh, so we can create a geometric model with the results.</li>
<li>Visualise the outcome.</li>
</ol>
<p>Details on these steps are given in the class description of petsc.Project. It maps each step on to an observer, despite the fact that two steps do not require a mesh traversal.</p>
<h2><a class="anchor" id="autotoc_md985"></a>
Code structure</h2>
<ul>
<li>petsc.Project Base class behind any PETSc project. This class holds one observer per algorithm step, it holds some global properties (such as the domain size), and it administers a <a class="el" href="../../d1/df8/namespacepeano4_1_1Project.html">peano4.Project</a>. It also holds an instance of petsc.PETScMain.</li>
<li>petsc.PETScMain represents the main C++ file. It is responsible to pick the reight sequence of the calculations.</li>
<li>The project holds an arbitrary number of <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> solvers.</li>
</ul>
<p>When we add a solver to the PETSc project via petsc.Project.add_solver(), the project memorises this solver, but also asks the solver to add its actions to each observer. So the project holds for example an observer for the plotting. Its main will invoke this plotting as very last step. However, the project cannot know what to plot actually. When you add a solver, the project takes this solver object and asks it "hey, can you please add whatever you want to do to this observer so 
we get a meaningful output". This means that the solver adds its action set to the observer.</p>
<p>When we invoke petsc.Project.generate_Peano4_project(), we obtain one Peano 4 project which hosts all of these observers and action sets, and the main, and so forth. The original hierarchical information on the number of solvers and so forth are lost. This is a realisation representation, not a logical representation of our project. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/da3/page_multigrid_home.html">MGHyPE</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:05 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
