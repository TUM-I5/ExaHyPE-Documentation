<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/d8c/tutorials_exahype2_coupling.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coupling of various solvers and additional mesh traversals</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md538">Preparing the PDEs to be coupled</a></li>
<li class="level1"><a href="#autotoc_md539">Coupling the solution data</a></li>
<li class="level1"><a href="#autotoc_md540">Coupling the time step sizes</a></li>
<li class="level1"><a href="#autotoc_md541">Localisation</a><ul><li class="level2"><a href="#autotoc_md542">Localisation guided by a marker</a></li>
<li class="level2"><a href="#autotoc_md543">Avoid that solver data is held everywhere</a></li>
<li class="level2"><a href="#autotoc_md544">The actual solution coupling</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>If you want to solve systems of PDEs where some PDEs advance on different time scales, solve different problems, are active in different domains, and so forth, you have two options on the table: You can model the solvers as one big system or you can logically code the solvers as two totally separate things and couple them. If you have to run some postprocessing, you also have two options: Either make the postprocessing a "real" postprocessing by adding it as postprocessing step to your solvers of choice, or you add separate mesh sweeps which perform the postprocessing.</p>
<p>The former version is faster, as you read/write data only once and you do not impose additional mesh traversals. The latter version is the way to go if you need some boundary exchange prior such that halos, for example, are up-to-date. It might also be appropriate if you want to couple the hyperbolic solvers to other solvers, such as an elliptic term or a solid in a fluid-structure interaction scenario. When it comes to the coupling of two solvers, the first approach sketched is simple: If the two solvers feature \( N_1 \) and \( N_2 \) unknowns, you simply create one new solver with \( N_1+N_2 \) unknowns and you provide flux functionsm, ncps, ...for all of the components. The big disadvantage of this approach is that all solvers have to advance in time at the same speed, that you might replicate code if you have already two existing solvers, and that you also might run a lot of unneeded calculations if only some <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> equations evolve actually in time. Technically, the implementation of this variant however is straightforward and we will not discuss it further here, i.e. our description from hereon assumes that you work with two solvers and/or separate mesh sweeps.</p>
<p>Using multiple solvers within ExaHyPE is, in principle, straightforward, too. You create two solver instances and you add them to your project. Both solvers then will be embedded into the mesh and run independently. They will hence interact through the adaptive mesh refinement - if one solver refines, the other one will follow - but otherwise be totally independent. While this approach allows us to have a clear separation-of-solvers, the coupling of the two systems is not that straightforward. And we have to couple them if we want to solver our initial setup phrased as system of PDEs.</p>
<h1><a class="anchor" id="autotoc_md538"></a>
Preparing the PDEs to be coupled</h1>
<p>How to couple the PDEs depends upon the fact if you want to directly project the solutions onto each other of if you make one <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> feed into the other one via the right-hand side (or in general some "material" parameters within its <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> other than the evolution unknowns). If you coupld PDEs directly, you can use your <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> solvers as they stand.</p>
<p>To prepare the system of PDEs in the other case, I recommend to add new material (auxiliary) parameters to each <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> which contain the cooupling term. That is, if you have two solver A and B and B has an impact on A through a scalar and A influences B through a vector, thend you add one material parameter to A and three to B.</p>
<p>Those material parameters are not material parameters in the traditional sense. They change over time. B will set the material parameters of A and vice versa.</p>
<h1><a class="anchor" id="autotoc_md539"></a>
Coupling the solution data</h1>
<p>There are two places where we can add coupling, i.e. map solution data onto each other: It can either be a preprocessing step of the time step or a postprocessing step. While, in principle, both approaches do work here, there's a delicate difference: In the pre-processing step, we have access to the patch data plus the halo. In the post-processing step, we have only access to the patch content.</p>
<p>We note that we exclusively discuss volumetric mapping in this section. This is the only coupling we support at the moment within ExaHyPE, i.e. we do not support mapping of face data onto each other (anymore). Besides volumetric coupling, you can obviously "only" couple global properties with each other. This is however similar to the time step synchronisation as discussed below and therefore not subject of further discussion.</p>
<h1><a class="anchor" id="autotoc_md540"></a>
Coupling the time step sizes</h1>
<p>Unless you use fixed time stepping schemes with hard-coded time step sizes that match, any two solvers with ExaHyPE run at their own speed. Even more, each individual cell runs at its own speed and hosts its own time stamp. For local timestepping, different cells may advance at different speed in time. For adaptive timestepping, all cells <em><b>of one solver</b></em> will advance with the same time step size.</p>
<p>For most solvers, it is therefore sufficient to plug into getAdmissibleTimeStepSize() of the superclass. Overwrite it, call the superclass' variant and then alter the returned value.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>mynamespace::MySolver: <span class="keyword">public</span> MyBaseClass {</div>
<div class="line">  ... </div>
<div class="line">  getAdmissibleTimeStepSize() <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;repositories/SolverRepository.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> mynamespace::MySolvergetAdmissibleTimeStepSize()<span class="keyword"> const </span>{</div>
<div class="line">  <span class="comment">// get vanilla version of time step size, i.e. only the one computed</span></div>
<div class="line">  <span class="comment">// by our solver</span></div>
<div class="line">  <span class="keywordtype">double</span> myTimeStepSize = MyBaseClass::getAdmissibleTimeStepSize();</div>
<div class="line">  <span class="keywordtype">double</span> otherTimeStepSize = repositories::MyOtherSolver.getAdmissibleTimeStepSize();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// now we combine it with each other and return result</span></div>
<div class="line">} </div>
</div><!-- fragment --><p>This is the approach used in Euler example with self-gravitation via the Poisson equation. If you want to use local time stepping or run checks on the timestamp per cell, you will have to alter the cell's meta data holding its time stamp. Things in this case become more involved, i.e. you will have to study the underlying action sets and change the generated source code in there.</p>
<h1><a class="anchor" id="autotoc_md541"></a>
Localisation</h1>
<p>ExaHyPE couples volumetrically. That does not mean that all solvers have to be solved everywhere. Indeed, the idea to offer support for multiple solvers arose originally from the a posteriori limiting of Dumbser et al where a Finite Volume solver complements ADER-DG solutions where shocks arise.</p>
<p>Most projects that follow these rationale realise the same pattern: We define two different solvers, and we couple them with each other. The coupling (and solve) however are local operations:</p>
<ul>
<li>The low-order (typically Finite Volume - we therefore always refer to Finite Volumes or FV from hereon) solver is our fallback strategy and we therefore neither solve with Finite Volumes everywhere in the computational domain nor should do we store the corresponding data.</li>
<li>The higher-order scheme is used everywhere where the FV is not applied or labelled as valid.</li>
<li>The FV and the higher-order solver are not coupled everywhere but only in boundary regions.</li>
</ul>
<p>We will effectively end up with a domain decomposition where parts of the computational domain are handled by the higher-order solver and the other parts are handled with FV. To realise this, we need a marker or oracle, i.e. a magic function per cell which tells us, similar to a multi-phase flow, which solver rules in this particular cell. The marker will guide us which solver is "valid" in which cell, where one solver overrules the other one, and where we do not have to store one solver's data or the other.</p>
<p>The image below illustrates the core idea behind typically coupling approaches in ExaHyPE. The sizes of the overlap might differ, but the principle is always the same. The illustration shows the minimal overlap that we can typically use. Both the upper and the lower mesh illustrate the same mesh. I use colours to show which solver exists in which mesh cell.</p>
<div class="image">
<img src="../../coupling.png" alt=""/>
</div>
<ul>
<li>Solver A is running within the filled cells visualised on the the top. In empty cells, A neither solves anything nor does it hold data.</li>
<li>Solver B is running within the filled cells visualised on the bottom. In empty cells, B neither solves anything nor does it hold data.</li>
<li>Consequently, dark red cells are exclusively solved by A, whereas dark green cells are exclusively B.</li>
<li>In orange cells, A solves its <a class="el" href="../../da/db8/namespacePDE.html">PDE</a>. Afterwards, A's updated solution is projected onto B's solution. That is, the blue cells hold B's data, but they are not updated by B but instead hold projections of A's data. They kind of serve as boundary layer for B.</li>
<li>In the yellow cells, A does not solve its <a class="el" href="../../da/db8/namespacePDE.html">PDE</a> but holds A's data. After each step, the cell's solution by B (light green) is written into A's data. The yellow cells serve as Dirichlet boundary data for A's solve.</li>
</ul>
<p>Starting from this description, sophisticated coupling equations can be realised, where you exploit the fact that we have a volumetric overlap.</p>
<h2><a class="anchor" id="autotoc_md542"></a>
Localisation guided by a marker</h2>
<p>Skip this section if you prefer a hard-coded marking of active regions.</p>
<h2><a class="anchor" id="autotoc_md543"></a>
Avoid that solver data is held everywhere</h2>
<p>Once you know where a solver is valid, it makes sense also to only store the solver's data in the valid region. Otherwise, a lot of memory is "wasted" which furthermore will be moved/accessed in each and every grid sweep, as the mesh management of Peano so far does not know that ExaHyPE might not need the data. ExaHyPE has to let Peano know.</p>
<p>The technical principles behind such a localisation <a class="el" href="../../d5/d5f/page_peano_localisation.html">are discussed on a generic Peano page of its own</a>. ExaHyPE builds up pretty deep inheritance hierarchy where every subclass specialises and augments the basic numerical scheme, and also implements additional guards when data is stored or not. However, most of these subclasses rely on only six routines to control the data flow:</p>
<ul>
<li>_provide_cell_data_to_compute_kernels_default_guard(),</li>
<li>_load_cell_data_default_guard(),</li>
<li>_store_cell_data_default_guard(),</li>
<li>_provide_face_data_to_compute_kernels_default_guard(),</li>
<li>_load_face_data_default_guard(),</li>
<li>_store_face_data_default_guard(),</li>
</ul>
<p>The implementation then uses these predicates to puzzle the actual storage scheme together via calls similar to</p>
<div class="fragment"><div class="line">self._patch.generator.load_store_compute_flag = <span class="stringliteral">&quot;::peano4::grid::constructLoadStoreComputeFlag({},{},{})&quot;</span>.format(</div>
<div class="line">    self._provide_cell_data_to_compute_kernels_default_guard(),</div>
<div class="line">    self._load_cell_data_default_guard(),</div>
<div class="line">    self._store_cell_data_default_guard(),</div>
<div class="line">)</div>
</div><!-- fragment --><p>By default, most solvers only store data for unrefined cells. They mask coarser levels with in the tree out. <br  />
 Subclasses such as enclave tasking variations augment the guards further such that not all data are stored all the time. Nothing stops you from adding further constraints and to use a solver only in a certain subdomain for example.</p>
<h2><a class="anchor" id="autotoc_md544"></a>
The actual solution coupling</h2>
<p>For the actual solver coupling, four hook-in points are available:</p>
<ol type="1">
<li>The dedicated solver preprocessing action set.</li>
<li>The hook-in preprocess_reconstructed_patch, which injects code right before the actual compute kernel (Finite Volume scheme, e.g.) is triggered.</li>
<li>The hook-in postprocess_updated_patch, which injects code right after updated time-step data. This snippet is called after the compute kernel has terminated. For Runge-Kutta style solvers, aka multi-step solvers, there are two of these hook-ins: One called after every intermediate step and one called once we compute the final linear combination of these intermediate outcomes.</li>
<li>The dedicated solver postprocessing action set.</li>
</ol>
<p>These steps all have differen properties. The global preprocessing precedes any solver routine, i.e. it is called before any compute kernel on any solver is launched. It also is guaranteed to run sequentially, i.e. there is nothing running in parallel to the preprocess actino set. For the postprocessing, similar arguments hold. These steps come after all solvers have updated their solution. The kernel hook-ins (2) and (3) in contrast can run in parallel.</p>
<p><a class="el" href="../../db/d37/structAny.html">Any</a> coupling can be arbitrary complicated, but there are several off-the-shelf routines offered in <a class="el" href="../../d1/d28/namespacetoolbox_1_1blockstructured.html">toolbox::blockstructured</a>. Interesting variants include <a class="el" href="../../d1/d28/namespacetoolbox_1_1blockstructured.html#ae6c4f15775aaf77e873fbacfeabfd458" title="Copy one unknown from one patch to the other.">toolbox::blockstructured::copyUnknown()</a> and <a class="el" href="../../d1/d28/namespacetoolbox_1_1blockstructured.html#a3e89f5f775094b1fa16bee2bc4f9f4cf">toolbox::blockstructured::computeGradientAndReturnMaxDifference()</a>. Besides those guys, you might also want to use the AMR routines within the blockstructured toolbox and the ExaHyPE folders, where you find, for example, linear interpolation and restriction.</p>
<p>Important: If you couple two solvers, you have to carefully take into account</p>
<ol type="1">
<li>in which order these solvers run; If that makes a difference, you might want to use the dedicated post- and pre-processing action sets.</li>
<li>wheather or not you use enclave solvers. The later ones take the data out of the mesh after their primary sweep and insert it back into the mesh. This has to be taken into account when you interpolate: data might be extracted from the mesh and then be put back in;</li>
<li>if you localise a solver, i.e. store it only in some places, you will have garbage on faces around this localised area.</li>
</ol>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="../../df/d5e/Copy_8h.html">toolbox/blockstructured/Copy.h</a> </dd>
<dd>
<a class="el" href="../../d5/d5b/Derivative_8h.html">toolbox/blockstructured/Derivative.h</a> </dd>
<dd>
<a class="el" href="../../df/d2a/Interpolation_8h.html">toolbox/blockstructured/Interpolation.h</a> </dd>
<dd>
<a class="el" href="../../dc/de8/Restriction_8h.html">toolbox/blockstructured/Restriction.h</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li><li class="navelem"><a class="el" href="../../d8/d60/page_exahype2_tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:58 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
