<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/d91/page_toolbox_particles_mesh_consistency.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Sorting: Preserving the mesh-particle data consistency</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>If a particle moves or changes its search radius, it might be associated to the wrong vertex. Consequently, it is important to be always aware of situations when the mesh-particle association is not consistent and to understand how you can minimise the time spans in which data remains messed up.</p>
<h1><a class="anchor" id="autotoc_md1224"></a>
Particle sorting</h1>
<p>The particle sorting is realised through <a class="el" href="../../db/de5/namespacepeano4_1_1toolbox_1_1particles_1_1api_1_1AbstractUpdateParticleGridAssociation.html">peano4.toolbox.particles.api.AbstractUpdateParticleGridAssociation</a> and subclasses of this type. In principle all flavours work in a similar way and spread up the sorting over at least two mesh traversals. That is, once you have updated either a particle position or a particle's search radius, you have to ensure that there are two consecutive mesh traversals which integrate a sorting action set. In the ideal case, you add this action set directly to the mesh traversal where you alter the particle state, and then you also add the sorting action set to the subsequent mesh sweep.</p>
<p>It is important that you merge the two update action sets into the action set where you change the particle position (in the last access of a vertex) plus into the subsequent grid sweep: Once the particle position has changed, Peano tries to associate the particle again to the right vertex. If the associativity however has changed, it might (temporarily) move particles to a coarser level. It is the subsequent grid sweep that then sorts the particles again into the right resolution of the mesh plus associates it with the right vertex. So it needs access to UpdateParticleGridAssocation.</p>
<p>Please note that you will need potentially multiple follow-up action sets aka mesh sweeps: In the first sweep, all particles are put into the right place in space and the mesh hierarchy yet may be on a too coarse level. In the second sweep, we drop them. Throughout the drop, we might drop them through a horizontal tree cut. We cannot handle this, so have to send out the particle through message passing and then drop once more.</p>
<p>While both a position update of a particle and an alteration of the search radius require resorts, mesh rebalancing does not require you to resort as Peano automatically transfers all data in sync. Dynamic mesh refinement also does not mean that you have to resort: Particles residing within erased fine grid partitions are automatically lifted to a coarser level. If you have added new AMR levels, the particles will simply reside on the coarser level until you decide to issue a new sort anyway.</p>
<h1><a class="anchor" id="autotoc_md1225"></a>
Particle storage</h1>
<p>The way how we sort particles is not decoupled from the way that we store the particles. If the particles are all scattered over the memory, you can sort in various ways. However, if you want to store particles en bloc (to vectorise, e.g.) then it is important to understand that your sorting will likely destory your nice memory layout. You will have to reconsolidate (move memory around) after the sorting. Some of these aspects are discussed on <a class="el" href="../../db/d9c/toolbox_particles_memorypool.html">in the context of memory pools</a>.</p>
<h1><a class="anchor" id="autotoc_md1226"></a>
Timing of particle changes</h1>
<p>I recommend that you never alter the particle positions throughout the traversal. The only time you should set a new position is within touchVertexLastTime(). This gives Peano's particle toolbox the time to re-sort the particles in-between two traversals as long as you ensure that every mesh sweep where you alter the particle position also resorts.</p>
<p>As long as you alter particle positions only in touchVertexLastTime(), you can then assume that the mesh topology is consistent throughout the traversal. That is, all particles within the search readius are properly indexed and available. This implies that you also should not alter the search radius throughout the mesh traversal. You can do so, but you have to accept that the mesh then becomes inconsistent, i.e. you might see more or less particles than what you actually would require, as the particle-mesh association is not updated yet.</p>
<h1><a class="anchor" id="autotoc_md1227"></a>
Uniqueness of particle changes</h1>
<p>Most codes move a particle in touchVertexLastTime(). This is convenient as we know that any particle associated with the respective vertex also has been touched for the last time. We can safely update it. However, if we change a particle's position and merge UpdateParticleGridAssociation into the respective algorithmic step, then the particle might immediately be associated to another vertex after it has been updated and this vertex might later on become subject of touchVertexLastTime().</p>
<p>If you update particles with touchCell, you face a similar dilemma: A particle might reside in up to \( 2^d \) cells, as we work with floating point data and hence the association with cells is not unique.</p>
<p>Consequently, it can happen that a particle is updated multiple times. To avoid this, I recommend that you add a boolean to each vertex:</p>
<div class="fragment"><div class="line">particle.data.add_attribute( <a class="code hl_namespace" href="../../d6/d7b/namespacedastgen2.html">dastgen2</a>.<a class="code hl_namespace" href="../../d6/ddd/namespacedastgen2_1_1attributes.html">attributes</a>.<a class="code hl_namespace" href="../../d9/d9c/namespacedastgen2_1_1attributes_1_1Enumeration.html">Enumeration</a>(<span class="stringliteral">&quot;MoveState&quot;</span>,[<span class="stringliteral">&quot;New&quot;</span>,<span class="stringliteral">&quot;NotMovedYet&quot;</span>,<span class="stringliteral">&quot;Moved&quot;</span>]) )</div>
<div class="ttc" id="anamespacedastgen2_1_1attributes_1_1Enumeration_html"><div class="ttname"><a href="../../d9/d9c/namespacedastgen2_1_1attributes_1_1Enumeration.html">dastgen2.attributes.Enumeration</a></div><div class="ttdef"><b>Definition</b> <a href="../../d9/de7/Enumeration_8py_source.html#l00001">Enumeration.py:1</a></div></div>
<div class="ttc" id="anamespacedastgen2_1_1attributes_html"><div class="ttname"><a href="../../d6/ddd/namespacedastgen2_1_1attributes.html">dastgen2.attributes</a></div><div class="ttdef"><b>Definition</b> <a href="../../d8/d78/python_2dastgen2_2attributes_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacedastgen2_html"><div class="ttname"><a href="../../d6/d7b/namespacedastgen2.html">dastgen2</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/dd5/python_2dastgen2_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
</div><!-- fragment --><p>You can then set the value of MoveState to NotMovedYet in touchVertexFirstTime(), set it to <code>Moved</code> once we update the position, but only update its position as long as it has not been moved yet. Peano's built-in re-assignment of positions does only move particles around when vertices are touched for the last time, so there's no risk here that you update a particle in touchVertexLastTime(), assign it to a particle which has not been used yet and then reset it wrongly to not moved again. Similar patterns hold for other state updates.</p>
<p>Further to that, I recommend that you work with special care in any parallel simulations: Particles then have a parallel state which indicated whether they are halo particles (virtual ones) or real ones. I recommend only to alter the positions of real particles:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (</div>
<div class="line">  particle-&gt;getMoveState()==std::remove_pointer&lt;typename ParticleContainer::value_type&gt;::type::MoveState::NotMovedYet</div>
<div class="line">  and</div>
<div class="line">  particle-&gt;getParallelState()==std::remove_pointer&lt;typename ParticleContainer::value_type&gt;::type::ParallelState::Local</div>
<div class="line">) {</div>
<div class="line">  <span class="comment">// update position</span></div>
<div class="line"> </div>
<div class="line">  particle-&gt;setMoveState( std::remove_pointer&lt;typename ParticleContainer::value_type&gt;::type::MoveState::Moved );</div>
<div class="line">}  </div>
</div><!-- fragment --><p>Keeping track of parallel states is not totally straightforward, as there are numerous pitfalls. Study the documentation of peano4.toolbox.particles.UpdateParallelState for details on these pitfalls. Once again however, I maintain two different particle states, i.e. a parallel state and a new parallel state. You may assume that the parallel state as used above is always consistent throughout one mesh sweep, but might change between two sweeps.</p>
<h1><a class="anchor" id="autotoc_md1228"></a>
Tunneling</h1>
<p>Tunneling means that a particle moves more than one mesh cell per time step. They <em><b>jump</b></em> or <em><b>tunnel</b></em> through cells. In the context of Peano's multiscale tree structure, this is equivalent to particles which travel more than their search radius per step.</p>
<p>Tunneling arises whenever search radii change suddenly, meshes are extremely refined where they should likely not refine, and particles suddenly accelerate or are inserted. It also arises if you have particles which do not or only weakly interact with neighbours or the environment and hence have velocities which are higher than the maximum signal velocity otherwise.</p>
<p>Peano does support tunneling in principle, but you can tell the update script if you want to get a warning if particles tunnel - in some applications, this is unphysical. Tunneling is not handled separatedly. Instead, we simply lift a particle to a coarser level on which we can accommodate the movement by just pushing the particle one cell. After it is pushed, we drop the particle again.</p>
<h1><a class="anchor" id="autotoc_md1229"></a>
Parallelisation</h1>
<p>Peano's sorting in the context is shaped by the observation that we only ever let particles move one cell at a time. If this is violated, we first lift particles to a coarser level and then drop them again (this is not totally true - see below - but overall indeed a guiding principle).</p>
<p>If two cells are held by different trees and a particle leaves the domain of tree A, we send it out at the end of the traversal. In the next traversal, it will be received by B (and subsequently dropped within the tree hierarchy).</p>
<h1><a class="anchor" id="autotoc_md1230"></a>
Sieving</h1>
<p>Sieving is Peano's word for global sorting: There are cases, where we might not be able to lift particles easily, or we might not want to. In this case, we move the particle into the sieve set. The sieve set is the set of particles that we cannot push into the right cell in an iteration.</p>
<p>In the subsequent mesh traversal, the particles from the sieve set are sieved straight into the right cell. Sieving means bucket sorting. While this is a robust way to handle particle sorting, it can become very expensive if the sieve sets grow large.</p>
<p>Each particle type has a sieve set tied to it. So you can tell any particle set that one if its particles has to be lifted (moved) into the sieve set and you can ask the global sieve set tied to a particle at any point if there are still particles within that set that have to be dumped into the domain. <br  />
 All of this is realised through a static attribute <a class="el" href="../../d5/ddd/classtoolbox_1_1particles_1_1ParticleSet.html#ad04361110d45f7e98debdbb72f26cf74" title="Map of persistent particles that have to be sieved.">toolbox::particles::ParticleSet::_sieveParticles</a> which holds and instance of <a class="el" href="../../dd/d6b/classtoolbox_1_1particles_1_1SieveParticles.html" title="Utility class for global sorting for all flavours of particle sets.">toolbox::particles::SieveParticles</a>.</p>
<p>Various sieving strategies exist. They are realised by the different subclasses of peano4.toolboxes.particles.api.AbstractUpdateParticleGridAssociation. However, this superclass holds all the relevant docu and an overview of the usage of the sieve set. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d7/d66/page_toolbox_home.html">Toolbox</a></li><li class="navelem"><a class="el" href="../../d0/d9e/toolbox_particles.html">Particles</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:07 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
