<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/d9c/toolbox_particles_memorypool.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Particle memory pools</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a discussion around the data storage of particles within Peano. Peano's particle toolbox works with pointers to individual particles on the heap. It makes no assumptions where the particles are and simply moved pointers around. By default, all creational routines allocate particles via a simple new. This can lead to memory fragmentation. It also means that compute kernels over lists of particles might induce scattered memory accesses.</p>
<p>The toolbox therefore offers action sets which take the particles and consolidate them into larger, continuous chunks of memory. They employ a memory pool. The idea of a memory pool is that we try to store (parts of) the particles consecutively in memory. By default, Peano's particle toolbox scatters data over the memory:</p>
<div class="image">
<img src="../../ParticleSetGenerator_ScatteredOnHeap.png" alt=""/>
</div>
<p>You can alter the storage by picking a particular particle set generator. Consult <a class="el" href="../../d7/d5c/namespacepeano4_1_1toolbox_1_1particles_1_1ParticleSet.html">peano4.toolbox.particles.ParticleSet</a> for details.</p>
<p>The intention behind the continuous, compact storage is not only a more efficient memory handling and a reduction of fragmentation. It also enables the code to efficiently encode the active and local lists and, eventually, to vectorise. toolbox.particles.UpdateParticle_MultiLevelInteraction_StackOfLists is the prime example of such a tree walker which uses the fact that particles are stored an bloc.</p>
<h1><a class="anchor" id="autotoc_md278"></a>
Realisation</h1>
<p>There are different ways to realise memory pools. Originally, I considered overloading the new and delete operator, i.e. to plug into the native C++ memory management. In such a case, we would generate a C++ particle class, overwrite its generated new and delete operator, and therefore bind the particle species to a memory pool. However, there were all kind of issues when I studied this approach en detail, so I eventually gave up on this idea.</p>
<p>The new version now is a little bit more down to the ground: Each individual vertex hosts a set of pointers administered through a memory pool object. By default, its particles are not tied to pool, i.e. roam on th heap. When I touch a vertex for the first time, I know a couple of facts:</p>
<ul>
<li>This vertex data is now on the local call stack. It has been loaded from the input stack into the local call stack before Peano invokes touchVertexFirstTime(). Notably, this vertex data is not a copy on a communication stack and it had not yet been moved over into some other temporary stack.</li>
<li>All the pointers that I host in the vertex are unique. This is likely the first and last time, when I know for sure that noone else holds references to my particle, too.</li>
</ul>
<p>I therefore can do a couple of things:</p>
<ol type="1">
<li>Make a vertex untied to the pool by default (default constructor).</li>
<li>If the vertex is not yet tied to a memory pool entry and hosts some particles, reserve space for that many particles in the pool, copy the particles from the global heap over and make the individual pointers that the vertex holds point to these particles.</li>
<li>Overwrite the insertion routines for the particle. If the user inserts a particle into a vertex which is untied, just add it to the list. If the vertex however is already tied to a memory pool, ensure that this memory pool is large enough, and copy the particle into this location.</li>
<li>If a particle is extracted from a tied vertex, copy it into a real heap location first and then release the corresponding entry. We ensure that the particle is on the heap and the user can do whatever they want (and notably call delete) first and then we mark this memory location internally to be reused.</li>
</ol>
<p>We have to overwrite/redefine a few routines of a std::vector. However, the C++ container offers quite a lot of ways to manipulate its entries. I don't want to feature-proof all of them. Therefore, it is natural to use private inheritance and to expose the routines of which I'm sure that they work via wrappers.</p>
<p>The most important exception is the fact that we do not(!) overwrite erase but instead eliminate it from the signature. erase() is very dangerous. We provide a routine grabParticle() which returns the "extracted" particle which is actually now a copy from the vertex data onto the heap and removes the pointer from the underlying vertex.</p>
<p>If we erase data from a memory block tied to a vertex, it is important that we do not alter the total underlying memory arrangement. Other vertices and data blocks might have access to this one. We close the discussion with a final observation which is over relevance for some codes:</p>
<p>When we encounter touchVertexLastTime() we may not(!) assume that noone else keeps the pointers to vertex data. Data might be used afterwards to lift particles to other levels. I am not sure if this might be too pessimistic, but one is definitely on the safe side not assuming anything about the particle ordering in this event.</p>
<p>By default, particles are managed via a particle set as produced by <a class="el" href="../../d7/d5c/namespacepeano4_1_1toolbox_1_1particles_1_1ParticleSet.html">peano4.toolbox.particles.ParticleSet</a>. That is, it is this Python class which decides which particle set flavour to produce. Please study</p>
<ul>
<li><a class="el" href="../../d9/d04/structtoolbox_1_1particles_1_1memorypool_1_1VertexWiseContinuousMemoryPool.html" title="Memory pool offering continuous global memory for a particle species.">toolbox::particles::memorypool::VertexWiseContinuousMemoryPool</a></li>
<li><a class="el" href="../../d5/d4c/classtoolbox_1_1particles_1_1memorypool_1_1GlobalContinuousMemoryPool.html" title="Memory pool offering continuous global memory for a particle species.">toolbox::particles::memorypool::GlobalContinuousMemoryPool</a></li>
</ul>
<p>for examples of different pool realisations (in C++) and study the various generators shipped with <a class="el" href="../../d7/d5c/namespacepeano4_1_1toolbox_1_1particles_1_1ParticleSet.html">peano4.toolbox.particles.ParticleSet</a> for further flavours.</p>
<h1><a class="anchor" id="autotoc_md279"></a>
Gather</h1>
<p>Enabling a particle pool is only the first step. You still have to ensure that a mesh traversal takes the data scattered all over the heap and dumps it into the memory pool. As we use a <a class="el" href="../../d0/d45/page_toolbox_particles_mesh_storage.html">vertex-centred storage</a>, we have to ensure that the mesh traversal invokes gather() on the vertices; and in return also calls scatter if particles leave their position in the mesh aka memory.</p>
<p>Within the Python API, you can use toolbox.particles.GatherParticlesInMemoryPool to inject the gather behaviour. Scattering should be realised automatically, as the particle set generator ensures that scatter is invoked every time you lift of drop particles.</p>
<h1><a class="anchor" id="autotoc_md280"></a>
Resorting</h1>
<p>You can trigger the resorting in various places. I do recommend to use the parallel state update. Swift for example implements it there as documented in swift2.graphcompiler.AMRLogic.add_dynamic_mesh_refinement_and_particle_resorting().</p>
<h1><a class="anchor" id="autotoc_md281"></a>
Efficient compute kernels</h1>
<p>Efficient tree traversals which exploit the optimised storage are <a class="el" href="../../db/d5c/namespacepeano4_1_1toolbox_1_1particles_1_1UpdateParticle__MultiLevelInteraction__StackOfLists__ContiguousParticles.html">peano4.toolbox.particles.UpdateParticle_MultiLevelInteraction_StackOfLists_ContiguousParticles</a> and <a class="el" href="../../d3/d07/namespacepeano4_1_1toolbox_1_1particles_1_1UpdateParticle__SingleLevelInteraction__ContiguousParticles.html">peano4.toolbox.particles.UpdateParticle_SingleLevelInteraction_ContiguousParticles</a>. Please consult their documentation re what happens if data are scattered over the memory, i.e. if vertices have not been gathered yet or if particles have changed their position or cut-off radius. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d7/d66/page_toolbox_home.html">Toolbox</a></li><li class="navelem"><a class="el" href="../../d0/d9e/toolbox_particles.html">Particles</a></li><li class="navelem"><a class="el" href="../../db/dba/page_toolbox_particles_realisation.html">Realisation details</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:58 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
