<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d42/page_exahype_checkpointing.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Checkpointing</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md865">Using checkpointing and restarting</a></li>
<li class="level1"><a href="#autotoc_md866">Add Checkpoint Feature to a Solver</a><ul><li class="level2"><a href="#autotoc_md867">New Checkpoint Stage</a></li>
<li class="level2"><a href="#autotoc_md868">Tuning Initial Condtion Stage</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md869">Checkpoint Loading Strategy</a></li>
</ul>
</div>
<div class="textblock"><p>The ExaHyPE provide a checkpoint feature in its framework, and allow users to restart from any checkpoint, resuming their simulations. This feature is based on the peano-patch-file output (the default grid-plot file type of ExaHyPE), no support for particle data yet.</p>
<p>The checkpoint feature hijack the initial condition stage of ExaHyPE simulation and loads the domain grid data directly from existing checkpoint files, therefore, you can change running configuration (rank numbers, thread numbers, etc) freely. On the other hand, the grid strucutre (AMR pattern) need to be identical. This limit will be removed in the future version, when a intepolator for reading domain value is implemented.</p>
<h1><a class="anchor" id="autotoc_md865"></a>
Using checkpointing and restarting</h1>
<p>Every solver in ExaHyPE manages its output seperately, and so does the checkpointing. Currently, the FV (Finite Volume) and RKFD (Runge-Kutta Finite Difference) solver have implemented checkpoint infrastructure. Enable checkpointing with these two solvers is therefore quite easy. To ask the code checkpoint at certain timestamps, you can pass arguments to <code>set_global_simulation_parameters()</code> </p>
<div class="fragment"><div class="line">project = <a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d8/df9/namespaceexahype2_1_1Project.html">Project</a>( [<span class="stringliteral">&quot;applications&quot;</span>, <span class="stringliteral">&quot;exahype2&quot;</span>, <span class="stringliteral">&quot;MyApplication&quot;</span>], <span class="stringliteral">&quot;MyApplication&quot;</span>, executable=exe)</div>
<div class="line">......</div>
<div class="line">project.set_global_simulation_parameters(</div>
<div class="line">  ......,</div>
<div class="line">  first_checkpoint_time_stamp=5.0,</div>
<div class="line">  time_in_between_checkpoints=3.0</div>
<div class="line">)</div>
<div class="ttc" id="anamespaceexahype2_1_1Project_html"><div class="ttname"><a href="../../d8/df9/namespaceexahype2_1_1Project.html">exahype2.Project</a></div><div class="ttdef"><b>Definition</b> <a href="../../d4/dcd/python_2exahype2_2Project_8py_source.html#l00001">Project.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_html"><div class="ttname"><a href="../../dd/d6c/namespaceexahype2.html">exahype2</a></div><div class="ttdoc">For the generic kernels that I use here most of the time.</div><div class="ttdef"><b>Definition</b> <a href="../../d0/d65/CellAccess_8h_source.html#l00013">CellAccess.h:13</a></div></div>
</div><!-- fragment --><p>The previous example will ask all solvers supporting checkpointing in this project to checkpoint every 3.0 codetime after code timestamp 5.0, i.e., dumping data of the whole domain at those timestamps. Once you have those checkpoint files ready, restarting from certain checkpoint can be set via</p>
<div class="fragment"><div class="line">project.set_restart_from_checkpoint(expected_restart_timestamp=args.restart_timestamp, checkpoint_path=cpath) </div>
</div><!-- fragment --><p><code>checkpoint_path</code> is where your checkpoint files are stored, we recommend to keep the checkpoint files with your regular output files under the same folder to avoid unpredicted index file error. <code>expected_restart_timestamp</code> is the timestamp you would like simulation to resume from. Notice the actual restarting time will be the timestamp recorded by checkpoint files. The code will try to restart from the very first checkpoint after your specified timestamp and is usually not exactly equal to your input time.</p>
<p>If you restart the simulation from non-latest checkpoint, the checkpoints after that one will be erase from index file as they may be not valid anymore (e.g., due to potential change of running configuration or domain solution). The code will record new checkpoints after restarting. If you hope to restart from a checkpoint at later timestamp after current restarting, we recommend to duplicate the checkpoint files for your interested timestep(both index meta file, with a name of <code>checkpoint-MySolver.peano-patch-file</code>, and actual patch data files, with names of <code>checkpoint-MySolver-X</code>[-rank-Y].peano-patch-file) and use them seperately.</p>
<h1><a class="anchor" id="autotoc_md866"></a>
Add Checkpoint Feature to a Solver</h1>
<p>Adding the checkpoint feature to a solver involves two steps: introduce a new checkpoint stage in algorithm steps, and adjust the initial condition stage to restart from checkpoints.</p>
<h2><a class="anchor" id="autotoc_md867"></a>
New Checkpoint Stage</h2>
<p>The checkpoint stage is actually another plot solution stage, but without any further postprocessing of spatial or solution filter. The whole domain data will be dumped onto the disk in this stage. In your solver class, add a function responsible for action set in this new stage</p>
<div class="fragment"><div class="line"> def add_actions_to_checkpoint_solution(self, <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>, output_path, restart_from_checkpoint=False):</div>
<div class="line">        d = {}</div>
<div class="line">        self._init_dictionary_with_default_parameters(d)</div>
<div class="line">        self.add_entries_to_text_replacement_dictionary(d)</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>.add_action_set(</div>
<div class="line">            self._action_set_couple_resolution_transitions_and_handle_dynamic_mesh_refinement</div>
<div class="line">        )</div>
<div class="line">        <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>.add_action_set(self._action_set_update_face_label)</div>
<div class="line">        <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>.add_action_set(self._action_set_update_cell_label)</div>
<div class="line"> </div>
<div class="line">        checkpoint_patches_action_set = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d5/d91/namespacepeano4_1_1toolbox.html">toolbox</a>.<a class="code hl_namespace" href="../../d7/dfc/namespacepeano4_1_1toolbox_1_1blockstructured.html">blockstructured</a>.<a class="code hl_namespace" href="../../df/db6/namespacepeano4_1_1toolbox_1_1blockstructured_1_1PlotPatchesInPeanoBlockFormat.html">PlotPatchesInPeanoBlockFormat</a>(</div>
<div class="line">            filename=output_path + <span class="stringliteral">&quot;checkpoint-&quot;</span> + self._name,</div>
<div class="line">            patch=self._patch,</div>
<div class="line">            dataset_name=self._unknown_identifier(),</div>
<div class="line">            description=self._plot_description,</div>
<div class="line">            guard=self._load_cell_data_default_guard(),</div>
<div class="line">            additional_includes=<span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">#include &quot;</span>../repositories/SolverRepository.h<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">            precision=<span class="stringliteral">&quot;PlotterPrecision&quot;</span>,</div>
<div class="line">            time_stamp_evaluation=<span class="stringliteral">&quot;0.5*(repositories::getMinTimeStamp()+repositories::getMaxTimeStamp())&quot;</span>,</div>
<div class="line">            select_dofs=None,</div>
<div class="line">            restart_preprocess=restart_from_checkpoint</div>
<div class="line">        )</div>
<div class="line">        checkpoint_patches_action_set.descend_invocation_order = self._baseline_action_set_descend_invocation_order</div>
<div class="line">        <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>.add_action_set(checkpoint_patches_action_set)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> self._plot_grid_properties:</div>
<div class="line">            checkpoint_grid_action_set = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d5/d91/namespacepeano4_1_1toolbox.html">toolbox</a>.<a class="code hl_namespace" href="../../df/d7c/namespacepeano4_1_1toolbox_1_1PlotGridInPeanoBlockFormat.html">PlotGridInPeanoBlockFormat</a>(</div>
<div class="line">                filename=output_path + <span class="stringliteral">&quot;grid-&quot;</span> + self._name,</div>
<div class="line">                cell_unknown=None,</div>
<div class="line">                guard=self._load_cell_data_default_guard(),</div>
<div class="line">                additional_includes=<span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">#include &quot;</span>../repositories/SolverRepository.h<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">            )</div>
<div class="line">            checkpoint_grid_action_set.descend_invocation_order = self._baseline_action_set_descend_invocation_order</div>
<div class="line">            <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>.add_action_set(checkpoint_grid_action_set)</div>
<div class="line"> </div>
<div class="line">        pass</div>
<div class="ttc" id="aMatrixFreeMain_8template_8cpp_html_ac6bf1a12c5c98ddec5b65e07fe74cabe"><div class="ttname"><a href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a></div><div class="ttdeci">void step()</div><div class="ttdef"><b>Definition</b> <a href="../../d5/db2/MatrixFreeMain_8template_8cpp_source.html#l00184">MatrixFreeMain.template.cpp:184</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_1_1PlotGridInPeanoBlockFormat_html"><div class="ttname"><a href="../../df/d7c/namespacepeano4_1_1toolbox_1_1PlotGridInPeanoBlockFormat.html">peano4.toolbox.PlotGridInPeanoBlockFormat</a></div><div class="ttdef"><b>Definition</b> <a href="../../d2/d0f/PlotGridInPeanoBlockFormat_8py_source.html#l00001">PlotGridInPeanoBlockFormat.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_1_1blockstructured_1_1PlotPatchesInPeanoBlockFormat_html"><div class="ttname"><a href="../../df/db6/namespacepeano4_1_1toolbox_1_1blockstructured_1_1PlotPatchesInPeanoBlockFormat.html">peano4.toolbox.blockstructured.PlotPatchesInPeanoBlockFormat</a></div><div class="ttdef"><b>Definition</b> <a href="../../da/d90/PlotPatchesInPeanoBlockFormat_8py_source.html#l00001">PlotPatchesInPeanoBlockFormat.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_1_1blockstructured_html"><div class="ttname"><a href="../../d7/dfc/namespacepeano4_1_1toolbox_1_1blockstructured.html">peano4.toolbox.blockstructured</a></div><div class="ttdef"><b>Definition</b> <a href="../../d3/d3e/python_2peano4_2toolbox_2blockstructured_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_html"><div class="ttname"><a href="../../d5/d91/namespacepeano4_1_1toolbox.html">peano4.toolbox</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/db6/python_2peano4_2toolbox_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --><p>Once <code>first_checkpoint_time_stamp</code> or <code>time_in_between_checkpoints</code> in <code>project.set_global_simulation_parameters()</code> above are set to be non-zero, the code will call this action set function to prepare the ploting code for checkpointing stage. The new argument <code>restart_from_checkpoint</code> is required for pre-processing of the existing index meta file to avoid error, and you will need them in your action set function for plotsolution as well (Once the restart is enabled this argument will be set True during function call)</p>
<div class="fragment"><div class="line">def add_actions_to_plot_solution(self, <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>, output_path, restart_from_checkpoint=False):</div>
<div class="line">......</div>
<div class="line">    plot_patches_action_set = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d3/dd9/namespacetoolbox.html">toolbox</a>.blockstructured.PlotPatchesInPeanoBlockFormat(</div>
<div class="line">        ......</div>
<div class="line">        restart_preprocess=restart_from_checkpoint</div>
<div class="line">    )</div>
<div class="ttc" id="anamespacetoolbox_html"><div class="ttname"><a href="../../d3/dd9/namespacetoolbox.html">toolbox</a></div><div class="ttdef"><b>Definition</b> <a href="../../d7/d07/InterpolationRestriction_8h_source.html#l00010">InterpolationRestriction.h:10</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md868"></a>
Tuning Initial Condtion Stage</h2>
<p>First we also need to add the <code>restart_from_checkpoint</code> argument to corresponding action set function to initial condtion stage:</p>
<div class="fragment"><div class="line">def add_actions_to_init_grid(self, <a class="code hl_function" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step</a>, restart_from_checkpoint=False)</div>
<div class="line">......</div>
<div class="line">    <span class="keywordflow">if</span> restart_from_checkpoint:</div>
<div class="line">        self._action_set_initial_conditions = (</div>
<div class="line">            <a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>.<a class="code hl_namespace" href="../../d0/d4e/namespaceexahype2_1_1solvers.html">solvers</a>.<a class="code hl_namespace" href="../../d4/d74/namespaceexahype2_1_1solvers_1_1rkfd.html">rkfd</a>.<a class="code hl_namespace" href="../../d0/dbc/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets.html">actionsets</a>.<a class="code hl_namespace" href="../../d3/d6f/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_1_1InitialCondition.html">InitialCondition</a>(</div>
<div class="line">                self, self._store_cell_data_default_guard(), <span class="stringliteral">&quot;true&quot;</span>, restart_from_checkpoint=True)</div>
<div class="line">        )</div>
<div class="line">.......</div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_1_1InitialCondition_html"><div class="ttname"><a href="../../d3/d6f/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_1_1InitialCondition.html">exahype2.solvers.rkfd.actionsets.InitialCondition</a></div><div class="ttdef"><b>Definition</b> <a href="../../d5/da2/rkfd_2actionsets_2InitialCondition_8py_source.html#l00001">InitialCondition.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_html"><div class="ttname"><a href="../../d0/dbc/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets.html">exahype2.solvers.rkfd.actionsets</a></div><div class="ttdef"><b>Definition</b> <a href="../../d9/d61/python_2exahype2_2solvers_2rkfd_2actionsets_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_1_1rkfd_html"><div class="ttname"><a href="../../d4/d74/namespaceexahype2_1_1solvers_1_1rkfd.html">exahype2.solvers.rkfd</a></div><div class="ttdef"><b>Definition</b> <a href="../../da/d1d/python_2exahype2_2solvers_2rkfd_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespaceexahype2_1_1solvers_html"><div class="ttname"><a href="../../d0/d4e/namespaceexahype2_1_1solvers.html">exahype2.solvers</a></div><div class="ttdef"><b>Definition</b> <a href="../../d8/d91/python_2exahype2_2solvers_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
</div><!-- fragment --><p>In the initial condition action set, you need to add several pieces of code for restarting process, the first part is the file loading</p>
<div class="fragment"><div class="line">def get_body_of_prepareTraversal(self):</div>
<div class="line">    result = <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line"> </div>
<div class="line">    if self._restart_from_checkpoint:</div>
<div class="line">      d = {}</div>
<div class="line">      self._solver._init_dictionary_with_default_parameters(d)</div>
<div class="line">      self._solver.add_entries_to_text_replacement_dictionary(d)</div>
<div class="line">      d[ <span class="stringliteral">&quot;PREDICATE&quot;</span> ]           = self.guard      </div>
<div class="line">      d[ <span class="stringliteral">&quot;GRID_IS_CONSTRUCTED&quot;</span> ] = self.grid_is_constructed</div>
<div class="line">      d[ <span class="stringliteral">&quot;CHECKPOINTFILELIST&quot;</span>] = <span class="stringliteral">&quot;CheckpointFilesOf&quot;</span> + self._solver._name</div>
<div class="line">      result = jinja2.Template( self.get_template_for_restart_preprocessing() ).render(**d)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> result</div>
<div class="line"> </div>
<div class="line"> def get_template_for_restart_preprocessing(self):</div>
<div class="line">    return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;        </span></div>
<div class="line"><span class="stringliteral">      tarch::reader::readInCheckpointFiles(CheckpointFilesOf{{SOLVER_NAME}}, domainDataFromFiles, offsetIndex,</span></div>
<div class="line"><span class="stringliteral">                                             {{NUMBER_OF_UNKNOWNS}}, {{NUMBER_OF_AUXILIARY_VARIABLES}}, Dimensions, {{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}});</span></div>
<div class="line"><span class="stringliteral">      #if Dimensions==2</span></div>
<div class="line"><span class="stringliteral">      domainPatchCount=offsetIndex.size()/2;</span></div>
<div class="line"><span class="stringliteral">      #elif Dimensions==3</span></div>
<div class="line"><span class="stringliteral">      domainPatchCount=offsetIndex.size()/3;</span></div>
<div class="line"><span class="stringliteral">      #endif</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
</div><!-- fragment --><p>and related data structure declaration and initialization:</p>
<div class="fragment"><div class="line">def get_includes(self):</div>
<div class="line">    return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">#include &lt;functional&gt;</span></div>
<div class="line"><span class="stringliteral">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="stringliteral">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="stringliteral">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#include &quot;</span><a class="code hl_namespace" href="../../dd/d6c/namespaceexahype2.html">exahype2</a>/fd/PatchUtils.h<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">#include &quot;</span><a class="code hl_namespace" href="../../da/d6a/namespacetarch.html">tarch</a>/reader/PeanoTextPatchFileReader.h<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span> + self._solver._get_default_includes() + self._solver.user_action_set_includes </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  def get_static_initialisations(self,full_qualified_classname):</div>
<div class="line">    if self._restart_from_checkpoint:</div>
<div class="line">      return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">std::vector&lt;double&gt; &quot;</span><span class="stringliteral">&quot;&quot;</span> + full_qualified_classname + <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;::domainDataFromFiles;</span></div>
<div class="line"><span class="stringliteral">std::vector&lt;double&gt; &quot;</span><span class="stringliteral">&quot;&quot;</span> + full_qualified_classname + <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;::offsetIndex;</span></div>
<div class="line"><span class="stringliteral">int &quot;</span><span class="stringliteral">&quot;&quot;</span> + full_qualified_classname + <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;::domainPatchCount=0;</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
<div class="line">    else:</div>
<div class="line">      return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;\n&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  def get_attributes(self):</div>
<div class="line">    if self._restart_from_checkpoint:</div>
<div class="line">      return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">    static std::vector&lt;double&gt; domainDataFromFiles;</span></div>
<div class="line"><span class="stringliteral">    static std::vector&lt;double&gt; offsetIndex;</span></div>
<div class="line"><span class="stringliteral">    static int domainPatchCount;</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
<div class="line">    else:</div>
<div class="line">      return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;\n&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
<div class="ttc" id="anamespacetarch_html"><div class="ttname"><a href="../../da/d6a/namespacetarch.html">tarch</a></div><div class="ttdoc">tarch denotes the Technical Architectures.</div><div class="ttdef"><b>Definition</b> <a href="../../db/d46/accelerator_8h_source.html#l00018">accelerator.h:18</a></div></div>
</div><!-- fragment --><p>and finally the restarting kernel, where the code search for corresponding data for current cell according to coordinates. We implement an exact comparison of coodinates thus the domain structure must be identical, or there will be NaN in the domain.</p>
<div class="fragment"><div class="line">  def get_body_of_operation(self,operation_name):</div>
<div class="line">    result = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">    if operation_name==<a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.solversteps.ActionSet.OPERATION_TOUCH_CELL_FIRST_TIME:</div>
<div class="line">      d = {}</div>
<div class="line">      self._solver._init_dictionary_with_default_parameters(d)</div>
<div class="line">      self._solver.add_entries_to_text_replacement_dictionary(d)</div>
<div class="line">      d[ <span class="stringliteral">&quot;PREDICATE&quot;</span> ]           = self.guard      </div>
<div class="line">      d[ <span class="stringliteral">&quot;GRID_IS_CONSTRUCTED&quot;</span> ] = self.grid_is_constructed</div>
<div class="line">      d[ <span class="stringliteral">&quot;CHECKPOINTFILELIST&quot;</span>] = <span class="stringliteral">&quot;CheckpointFilesOf&quot;</span> + self._solver._name</div>
<div class="line">      <span class="keywordflow">if</span> self._restart_from_checkpoint:</div>
<div class="line">        result = jinja2.Template(self.get_template_for_restarting()).render(**d)</div>
<div class="line">      <span class="keywordflow">else</span>:</div>
<div class="line">        result = jinja2.Template( self.TemplateInitialCondition ).render(**d)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> result</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  def get_template_for_restarting(self):</div>
<div class="line">    return <span class="stringliteral">&quot;&quot;</span><span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">//loading-scheme: global-loading</span></div>
<div class="line"><span class="stringliteral">if ({{PREDICATE}}) { </span></div>
<div class="line"><span class="stringliteral">  logTraceIn( &quot;</span>touchCellFirstTime(...)---RestartingFromCheckpoint<span class="stringliteral">&quot; );</span></div>
<div class="line"><span class="stringliteral">  </span></div>
<div class="line"><span class="stringliteral">  #if Dimensions==2</span></div>
<div class="line"><span class="stringliteral">    tarch::la::Vector&lt;2,double&gt; offset;</span></div>
<div class="line"><span class="stringliteral">    const int totalCellCount={{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}}*{{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}};</span></div>
<div class="line"><span class="stringliteral">  #elif Dimensions==3</span></div>
<div class="line"><span class="stringliteral">    tarch::la::Vector&lt;3,double&gt; offset;</span></div>
<div class="line"><span class="stringliteral">    const int totalCellCount={{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}}*{{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}}*{{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}};</span></div>
<div class="line"><span class="stringliteral">  #endif</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">  for (int i=0;i&lt;domainPatchCount;i++) {</span></div>
<div class="line"><span class="stringliteral">    bool FoundCell = false;</span></div>
<div class="line"><span class="stringliteral">    #if Dimensions==2</span></div>
<div class="line"><span class="stringliteral">    offset[0]=offsetIndex[i*2+0];</span></div>
<div class="line"><span class="stringliteral">    offset[1]=offsetIndex[i*2+1];</span></div>
<div class="line"><span class="stringliteral">    #elif Dimensions==3</span></div>
<div class="line"><span class="stringliteral">    offset[0]=offsetIndex[i*3+0];</span></div>
<div class="line"><span class="stringliteral">    offset[1]=offsetIndex[i*3+1];</span></div>
<div class="line"><span class="stringliteral">    offset[2]=offsetIndex[i*3+2];</span></div>
<div class="line"><span class="stringliteral">    #endif</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">    if ( tarch::la::equals( marker.x() - 0.5*marker.h(), offset, 1e-5) ) { FoundCell=true; }</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">    if (FoundCell){</span></div>
<div class="line"><span class="stringliteral">      dfor(volume, {{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}}) {</span></div>
<div class="line"><span class="stringliteral">        int index = peano4::utils::dLinearised(volume,{{NUMBER_OF_GRID_CELLS_PER_PATCH_PER_AXIS}}) * ({{NUMBER_OF_UNKNOWNS}} + {{NUMBER_OF_AUXILIARY_VARIABLES}});</span></div>
<div class="line"><span class="stringliteral">        for (int k=0; k&lt;=({{NUMBER_OF_UNKNOWNS}} + {{NUMBER_OF_AUXILIARY_VARIABLES}}); k++){</span></div>
<div class="line"><span class="stringliteral">          fineGridCell{{UNKNOWN_IDENTIFIER}}.value[index+k]=domainDataFromFiles[i*({{NUMBER_OF_UNKNOWNS}} + {{NUMBER_OF_AUXILIARY_VARIABLES}})*totalCellCount+index+k];</span></div>
<div class="line"><span class="stringliteral">        }</span></div>
<div class="line"><span class="stringliteral">      }</span></div>
<div class="line"><span class="stringliteral">      break;</span></div>
<div class="line"><span class="stringliteral">    }</span></div>
<div class="line"><span class="stringliteral">  }</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">  fineGridCell{{SOLVER_NAME}}CellLabel.setTimeStamp(CheckpointTimeStamp);</span></div>
<div class="line"><span class="stringliteral">  fineGridCell{{SOLVER_NAME}}CellLabel.setHasUpdated(true);</span></div>
<div class="line"><span class="stringliteral">  logTraceOut( &quot;</span>touchCellFirstTime(...)---RestartingFromCheckpoint<span class="stringliteral">&quot; );</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral">&quot;</span><span class="stringliteral">&quot;&quot;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md869"></a>
Checkpoint Loading Strategy</h1>
<p>The current implemented strategy for loading checkpoint files is the <code>global-loading</code>. In this strategy, each rank loads all files into its memory and let cell search through it. It is the fastest approach but also expensive in memory. For large-scale simulation using dozens of nodes, this strategy may also leads to a memory error.</p>
<p>To avoid this potential issue, users can try the other load strategy, called as <code>local-loading</code>. In this strategy, the rank only loads an index list of coorinates, pointing to the checkpoint subfiles they belong to. The cell first search the index list and load the corresponding subfile for reading its data. If the total size of already-opened files exceed a user-defiend limit, the oldest file will be removed from memory to release space for new one. In principle, this strategy will only slightly slower than <code>global-loading</code> but significantly reduce the memory pressure. Unfortunately this strategy is still buggy and gives segmentation fault from time to time. Further tests are required. Interested users are referred to the implemented code of <code>local-loading</code> in <code>/src/tarch/reader/PeanoTextPatchFileReader</code>.h, <code>/src/tarch/reader/PeanoTextPatchFileReader</code>.cpp and <code>/python/exahype2/solvers/rkfd/actionsets/InitialCondition</code>.py. You can change load strategy easily by change the argument in the action set. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:04 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
