<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/d44/swift_graph_compiler.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SWIFT's task graph compiler</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>SWIFT's graph compiler takes the <a class="el" href="../../d2/daf/swift_particle_new_solver.html">lifecycle of all particle species</a> and maps them onto mesh traversals. That is, it takes the lifecycles and answers the following questions:</p>
<ol type="1">
<li>How many times do we have to run through the mesh per time step?</li>
<li>What steps does each run-through have to complete?</li>
</ol>
<p>We create the <a class="el" href="../../db/d3f/page_architecture_home.html">Peano action sets</a> required to realise the SPH algorithm that's specific to the chosen number of species and their character. The clear separation of a specification of the particles' lifecycle (what is to be done in which order per particle) from its realisation allows us to swap different realisation paradigms. The translation logic from specification into realisation is encapsuled in our <em><b>graph compilers</b></em> which take the lifecycle graph and yield a compute graph.</p>
<h1><a class="anchor" id="autotoc_md1105"></a>
Graph translator flavours</h1>
<h2><a class="anchor" id="autotoc_md1106"></a>
A direct 1:1 mapping</h2>
<p>The simplest graph compilers do not use any task graph as output. They simply take the lifecycle per species and map each step there onto one mesh traversal.</p>
<div class="image">
<img src="../../particle-lifecycle.png" alt=""/>
</div>
<p>The above lifecycle will consequently be mapped onto six separate mesh traversals. Depending on the data layout you want to use (see the documentation on <a class="el" href="../../d3/dc8/page_swift_performance_optimisation.html">various optimisation approaches</a>), the graph compiler might add additional mesh sweeps on top of this.</p>
<p>All the direct translators are held within python/swift2/graphcompiler/Sequential.py. The file name reflects that the fact that we do not exploit any additional (task) parallelism besides the core domain decomposition coming along with Peano anyway.</p>
<h2><a class="anchor" id="autotoc_md1107"></a>
Task tree</h2>
<p>A more sophisticated of the task tree recognises that each and every step which does not change the particles' position or its radius works with invariant sets of active and local particles: The sets are built up top-down throughout the mesh traversal but do not change. We therefore can create a producer-consumer pattern, where we still run trough the mesh once per species per lifecycle step. However, the mesh traversals do not issue any operations. Instead, they create tasks.</p>
<p>The hope here is that few mesh traversals serve as task producers and the tasks are then consumed by all the other (idle) threads. The resulting task graph resembles a tree. It is not really a tree, as the updates plug into touchVertexFirstTime(), touchCellFirstTime() and touchVertexLastTime(). The dependency graph hence resembles a superposition of a tree task graph with a (multiscale) Cartesian mesh where cell tasks are connected via two types (touch first vs touch last) of vertex tasks. <br  />
</p>
<p>This whole approach has to be used with care:</p>
<ul>
<li><p class="startli">If an algorithm step changes a particle's position, the touchVertexLastTime() step will trigger a resort. This resort will potentially affect the subsequent construction of active and local sets. Therefore, the task generation has to be disabled for steps which alter the particles.</p>
<p class="startli">This is not a problem for sweeps following a resort. We might still drop particles and sort them into the vertices, but this happens before we build up the active sets and trigger any action for a vertex in a preamble. So all particles are in the right place once we think about constructing the graph.</p>
</li>
<li>For a vertex which is adjacent to an MPI boundary, we may not just fire a task and continue. The outcome of this task feeds into MPI directly and we therefore have to wait for it to complete.</li>
</ul>
<p>The latter observation is one similar to the idea of enclave tasking in ExaHyPE. However, it refers to vertices and has nothing to do with AMR. So it is another materialisation of the same observation/rationale but something different to enclave tasking.</p>
<p>As the arising task graph reflects the multiscale mesh 1:1, we can kind of hard-code the task graph management into the mesh:</p>
<ul>
<li>There is a global task pool of task indices (positive integers). Depending on your back-end, these integers map onto memory locations (OpenMP), TBB tasks, or SYCL events.</li>
<li>Each vertex is assigned two indices when we hit it for the first time. One index corresponds to touchVertexFirstTime(), one to touchVertexLastTime().</li>
</ul>
<div class="image">
<img src="../../task-graph-tree.png" alt=""/>
</div>
<p>We see that this scheme basically throws away the (partial) serialisation with the space-filling curves for which Peano is built. However, we might argue that the serialisation is preserved along the subdomain boundaries and reflected in the task creation pattern, where it might serve as task scheduling/optimisation heuristics as long as the scheduler has some notion of FIFO.</p>
<p>The tree translators are held within python/swift2/graphcompiler/TaskTree.py.</p>
<h1><a class="anchor" id="autotoc_md1108"></a>
Different particle species</h1>
<p>SWIFT supports multiple particle species. There are two fundamentally different ways to handle the species:</p>
<ol type="1">
<li>Run the species one by one after each other.</li>
<li>Merge the update of the species.</li>
</ol>
<p>The two approaches have their pros and cons. If you run the species one by one, it is possible to skip whole species whenever you know that they won't be updated. This is very useful for local time stepping for example. At the same time, merging multiple species is advantageous whenever we frequently update multiple species: In this case, the arising concurrency level and work per cell will be higher as we fuse multiple species updates.</p>
<p>We support both flavours in SWIFT 2 through two mechanisms. Both are realised within swift2/graphcompiler/SpeciesStepOrdering.py.</p>
<ol type="1">
<li>The graph compiler supports a list of tuples of species plus steps. By resorting this list, you can generate steps.</li>
<li>A step can completely be left out in the total scheme if a step will not perform any operations anyway.</li>
</ol>
<p>If you append all steps for species 2 to all steps of 1, i.e. if you merely concatenate the sequences, the result will resemble an outer loop looping through the species. If you zip the steps of the different particles, you get a mixture of different particle updates, and potentially fewer mesh traversals with more operations.</p>
<p>There is a disadvantage though: If a species is not updated at all, the zipper version might still check each and every cell if the species is to be updated. In the worst case, there are three species per traversal as none of them does anything.</p>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000087">Todo</a></b></dt><dd>Skip mechanism does not exist yet I think. Not sure if we need it at all. Not sure if the disadvantage is still there.</dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d6/dba/page_swift2_home.html">Swift 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:06 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
