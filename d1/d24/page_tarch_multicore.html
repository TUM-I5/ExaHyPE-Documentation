<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/d24/page_tarch_multicore.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Multicore programming</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1167">Administering the multithreaded environment</a></li>
<li class="level1"><a href="#autotoc_md1168">Avoid race conditions</a><ul><li class="level2"><a href="#autotoc_md1169">Atomics</a></li>
<li class="level2"><a href="#autotoc_md1170">Special semaphores</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1171">Write bespoke multithreaded variants</a></li>
<li class="level1"><a href="#autotoc_md1172">Tasks</a><ul><li class="level2"><a href="#autotoc_md1173">Task types</a><ul><li class="level3"><a href="#autotoc_md1174">Tasks with dependencies</a></li>
<li class="level3"><a href="#autotoc_md1175">Task fusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1176">Implementation</a></li>
</ul>
</div>
<div class="textblock"><p>To compile with multicore support, you have to invoke the configure script with the option</p>
<div class="fragment"><div class="line">--with-multithreading=value </div>
</div><!-- fragment --><p>where value is</p>
<ul>
<li><code>cpp</code>. This adds support through C++14 threads.</li>
<li><code>tbb</code>. This adds support through Intel's Threading Building Blocks. If you use this option, you first have to ensure that your CXXFLAGS and LDFLAGS point to the right include or library, respectively, directories. LDFLAGS also has to compromise either -ltbb or -tbb_debug.</li>
<li><code>tbb_extension</code>. Is an alternative TBB version that does not require the very latest TBB extensions.</li>
<li><code>openmp</code>. This adds OpenMP support. We currently develop against OpenMP 4.x though some of our routines use OpenMP target and thus are developed against OpenMP 5.</li>
<li><code>sycl</code>. We have a SYCL support for the multithreading, through, within the Intel toolchain, it might be more appropriate to combine sycl on the GPU with the tbb backend for multithreading.</li>
</ul>
<p>Our vision is that each code should be totally independent of the multithreading implementation chosen. Indeed, Peano 4 itself does not contain any direct multithreading library calls. It solely relies on the classes and functions from <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html" title="This page describes Peano 4&#39;s multithreading namespace.">tarch::multicore</a>.</p>
<p><br  />
<br  />
 </p><div style="background-color: #fcc ; padding: 10px; border: 1px solid green;"> As of today (2025-03-29), OpenMP's tasking implementation is not 100% stable. As long as you don't use task dependencies excessively, you should be fine, but if you use complex task graphs, you might run into occasional seg faults in the OpenMP runtime.</div><div style="background-color: #fcc ; padding: 10px; border: 1px solid green;">As of today (2025-03-29), TBB's dynamic task graphs are only available as preview in UXL's internal repositories. So you either have to install those extensions, or you pick <code>tbb_extension</code>. </div><h1><a class="anchor" id="autotoc_md1167"></a>
Administering the multithreaded environment</h1>
<p>The central instance managing the threads on a system is <a class="el" href="../../dd/d55/classtarch_1_1multicore_1_1Core.html" title="Core.">tarch::multicore::Core</a>. This is a singleton and the name thus is slightly wrong. It does not really represent one core but rather represents the landscape of cores. You can setup the multithreading environment through Core's configure() routine, but this is optional. Indeed, multithreading should work without calling configure() at all. Each multitheading backend offers its own realisation of the Core class.</p>
<h1><a class="anchor" id="autotoc_md1168"></a>
Avoid race conditions</h1>
<p>For multithreaded code, it is important that the code can lock (protect) code regions and free them. For this, the multithreading layer offers different semaphores. Each multithreading backend maps these logical concepts onto its internal synchronisation mechanism. Usually, I use the semaphores through lock objects. As they rely on the semaphore implementations, they are generic and work for any backend.</p>
<p>So the standard use is that you have</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code hl_class" href="../../da/d3f/classtarch_1_1multicore_1_1BooleanSemaphore.html">tarch::multicore::BooleanSemaphore</a> myFancySemaphore;</div>
<div class="ttc" id="aclasstarch_1_1multicore_1_1BooleanSemaphore_html"><div class="ttname"><a href="../../da/d3f/classtarch_1_1multicore_1_1BooleanSemaphore.html">tarch::multicore::BooleanSemaphore</a></div><div class="ttdef"><b>Definition</b> <a href="../../da/d95/multicore_2tbb_2BooleanSemaphore_8h_source.html#l00021">BooleanSemaphore.h:21</a></div></div>
</div><!-- fragment --><p>and then you use it by locking it:</p>
<div class="fragment"><div class="line">{ <span class="comment">// scope starts</span></div>
<div class="line">  <a class="code hl_class" href="../../d2/df3/classtarch_1_1multicore_1_1Lock.html">tarch::multicore::Lock</a> lock(myFancySemaphore);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// [all of this is protected]</span></div>
<div class="line">  </div>
<div class="line">} <span class="comment">// end of scope destroys lock object and therefore frees semaphore  </span></div>
<div class="ttc" id="aclasstarch_1_1multicore_1_1Lock_html"><div class="ttname"><a href="../../d2/df3/classtarch_1_1multicore_1_1Lock.html">tarch::multicore::Lock</a></div><div class="ttdoc">Create a lock around a boolean semaphore region.</div><div class="ttdef"><b>Definition</b> <a href="../../de/d9c/multicore_2Lock_8h_source.html#l00019">Lock.h:19</a></div></div>
</div><!-- fragment --><p>The class <a class="el" href="../../da/d3f/classtarch_1_1multicore_1_1BooleanSemaphore.html">tarch::multicore::BooleanSemaphore</a> should be studied for a more detailed documentation of the thread locks.</p>
<p>The plain semaphore does not work recursively, i.e. if a thread locks a semaphore and then locks again, it deadlocks itself. You can avoid this by switching to a recursive semaphore. They are more expensive yet allow that a thread locks the same semaphore repeatedly.</p>
<p>Each semaphore also supports a try_lock() operation, so you can do busy polling. try_lock's are not supported by the <a class="el" href="../../d2/df3/classtarch_1_1multicore_1_1Lock.html" title="Create a lock around a boolean semaphore region.">tarch::multicore::Lock</a> object. You have to access the semaphore directly and manually free it later, whereas the Lock object automatically frees the semaphore in its destructor (unless you do so before that manually).</p>
<h2><a class="anchor" id="autotoc_md1169"></a>
Atomics</h2>
<p>At the moment, the tarch does <em><b>not</b></em> provide a backend-independent abstraction of atomics. We hope that such a thing would be obsolete anyway, as C++'s std::atomic works with all backends. If this is not the case and if you need atomics, you have to write backend-specific variants protected by preprocessor macros (see below).</p>
<h2><a class="anchor" id="autotoc_md1170"></a>
Special semaphores</h2>
<p>If you have a piece of code that locks a sempahore recursively, the second call to lock will deadlock. You will have to use the <a class="el" href="../../d4/df5/classtarch_1_1multicore_1_1RecursiveLock.html" title="Create a lock around a boolean semaphore region.">tarch::multicore::RecursiveLock</a>.</p>
<p>Sometimes, it is fine for many threads to access a code block concurrently as they only read data. At the same time, if one thread writes some data, noone else should read or write concurrently. In this case, you have to use <a class="el" href="../../d7/df8/classtarch_1_1multicore_1_1MultiReadSingleWriteSemaphore.html" title="Read/write Semaphore.">tarch::multicore::MultiReadSingleWriteSemaphore</a>.</p>
<h1><a class="anchor" id="autotoc_md1171"></a>
Write bespoke multithreaded variants</h1>
<p>The namespace <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html" title="This page describes Peano 4&#39;s multithreading namespace.">tarch::multicore</a> provides a set of preprocessor macros and further information how to write bespoke code for codes that have to distinguish single-threaded realisation from bespoke variants.</p>
<h1><a class="anchor" id="autotoc_md1172"></a>
Tasks</h1>
<p>All the tasking is modelled through the class <a class="el" href="../../dd/dd7/classtarch_1_1multicore_1_1Task.html" title="Abstract super class for a job.">tarch::multicore::Task</a>. That is, Peano expects each task to be a subclass of this guy. However, there's already a specialisation of the class accepting a functor if you prefer to work with lambdas.</p>
<p>The actually task submission, dependency tracking, and synchronisation then is all realised through functions within the namespace <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html" title="This page describes Peano 4&#39;s multithreading namespace.">tarch::multicore</a>. Consult the function <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html#aaa35c88b83cdb143a96270e52a5a3d89" title="Spawns a single task in a non-blocking fashion.">tarch::multicore::spawnTask()</a>.</p>
<h2><a class="anchor" id="autotoc_md1173"></a>
Task types</h2>
<p>Peano models all of its interna as tasks. Each Peano 4 task is a subclass of <a class="el" href="../../dd/dd7/classtarch_1_1multicore_1_1Task.html" title="Abstract super class for a job.">tarch::multicore::Task</a>. However, these classes might not be mapped 1:1 onto native tasks. In line with other APIs such as OneTBB, we distinguish different task types or task graph types, respectively:</p>
<ul>
<li><em><b>Tasks</b></em>. The most generic type of tasks is submitted via spawnTask(). Each task can be assigned a unique number and incoming dependencies. The number in return can be used to specify outgoing dependencies. These generic normal tasks are spawned through <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html#aaa35c88b83cdb143a96270e52a5a3d89" title="Spawns a single task in a non-blocking fashion.">tarch::multicore::spawnTask()</a>.</li>
<li><em><b>Fork-join tasks</b></em>. These are created via tarch::multicore::spawnAndWait() which accepts a sequence of tasks. They are all run in parallel but then wait for each other, i.e. we define a tree (sub)task graph. With fork-join calls, we mirror the principles behind bulk-synchronous programming (BSP).</li>
<li><em><b>Fusable tasks</b></em>. A subtype of the normal tasks.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1174"></a>
Tasks with dependencies</h3>
<p>In Peano, task DAGs are built up along the task workflow. That is, each task that is not used within a fork-join region or is totally free is assigned a unique number when we spawn it.</p>
<p>Whenever we define a task, we can also define its dependencies. This is a sole completion dependency: you tell the task system which task has to be completed before the currently submitted one is allowed to start. A DAG thus can be built up layer by layer. We start with the first task. This task might be immediately executed - we do not care - and then we continue to work our way down through the graph adding node by node.</p>
<p>In line with OpenMP and TBB - where we significantly influenced the development of the dynamic task API - outgoing dependencies should be declared before we use them.</p>
<h3><a class="anchor" id="autotoc_md1175"></a>
Task fusion</h3>
<p>The core idea behind task fusion is that there's no right, generic, global task granularity on modern HPC systems. Instead, we may assume that</p>
<ul>
<li>too small tasks are bad as they induce too much of an overhead. Nevertheless, they might be the right modelling tool/language;</li>
<li>smallish tasks perform good on CPUs;</li>
<li>GPUs require rather huge tasks.</li>
</ul>
<p>In Peano, we try to use as small tasks as possible, but equip the runtime to bundle (fuse) these tasks later on at runtime. This is different to other codes which require codes to come up with the large, fused tasks a priori - for example by working with larger patches.</p>
<p>Tasks that can be fused have to implement the canFuse() predicate, and they have to provide a function which can handle a set of tasks of the same type. Details on how the fusion is implemented are provided by tarch::multicore::taskfusion.</p>
<h1><a class="anchor" id="autotoc_md1176"></a>
Implementation</h1>
<p>Most implementation details can be found in the <a class="el" href="../../d6/d43/namespacetarch_1_1multicore.html">namespace documentation</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../dd/d46/page_tarch_home.html">Technical Architecture (tarch)</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:06 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
