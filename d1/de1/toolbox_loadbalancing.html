<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/de1/toolbox_loadbalancing.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Load Balancing (Domain Decomposition)</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md1199">Usage through Python API</a></li>
<li class="level2"><a href="#autotoc_md1200">Overview over some pre-manufactured load balancing strategies</a></li>
</ul>
<li class="level1"><a href="#autotoc_md1201">Implementation remarks</a><ul><li class="level2"><a href="#autotoc_md1202">Load balancing variations</a></li>
<li class="level2"><a href="#autotoc_md1203">Rebalancing, joins and AMR</a></li>
<li class="level2"><a href="#autotoc_md1204">Performance flaws</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1205">Tuning and Tailoring the domain decomposition</a><ul><li class="level2"><a href="#autotoc_md1206">Load balancing throughout mesh construction</a></li>
<li class="level2"><a href="#autotoc_md1207">Domain decomposition for existing partitions or late throughout the mesh construction</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1208">Formalisation of load balancing</a></li>
</ul>
</div>
<div class="textblock"><p>Load balancing toolbox for Peano 4</p>
<ul>
<li>You tell Peano to run through the mesh.</li>
<li>Every now and then, you invoke the load balancing toolbox which might, hidden away from you, trigger rebalancing.</li>
<li>You continue to invoke mesh traversals, and these will then somehow realise additional splits (as well as joins).</li>
</ul>
<h2><a class="anchor" id="autotoc_md1199"></a>
Usage through Python API</h2>
<p>Many extensions, such as ExaHyPE 2, not only use the load balancing toolbox, they also offer a tailored ExaHyPE 2 load balancing configuration, i.e. they provide means for users to employ the toolbox without interfering with the main functions or calling the load balancing manually. Indeed,the toolbox follows the philosophy that the chosen load balancing determines the load balancing strategy, while the configuration object tailors this strategy to your experimental setup and machine.</p>
<ul>
<li>See more on how to <a class="el" href="../../d3/d21/page_exahype_multicore.html">configure load balancing within ExaHyPE 2</a>.</li>
<li>There's a dedicated page on <a class="el" href="../../dc/d3c/swift_parallelisation.html">the parallelisation aspects within Swift 2</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1200"></a>
Overview over some pre-manufactured load balancing strategies</h2>
<ul>
<li>toolbox::loadbalancing::strategies::Hardcoded Don't do any analysis but hand out the partitioning instructions following a rulebook. This version allows you to create a reproducible load balancing scheme or to manually determine the splitting.</li>
<li>toolbox::loadbalancing::strategies::SpreadOut Ensure that, if the problem is large enough, each thread on each rank gets one partition.</li>
<li>toolbox::loadbalancing::strategies::RecursiveBipartition As the name suggests, the load balancing tries to identify oversized partitions and then splits these guys into two.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1201"></a>
Implementation remarks</h1>
<p>The toolbox's strategies typically have a</p>
<ul>
<li>blacklist (<a class="el" href="../../dd/d58/classtoolbox_1_1loadbalancing_1_1Blacklist.html" title="Blacklisting.">toolbox::loadbalancing::Blacklist</a>)</li>
<li>configuration (<a class="el" href="../../d2/d2f/classtoolbox_1_1loadbalancing_1_1Configuration.html" title="Abstract interface to tweak the behaviour of the load balancer.">toolbox::loadbalancing::Configuration</a>)</li>
<li>cost metrics (toolbox::loadbalancing::CostMetrics)</li>
<li>state (<a class="el" href="../../d2/d1a/namespacetoolbox_1_1loadbalancing.html#ae6ed09ab548ea9230112680042a6d5ef" title="State descriptor of load balancing.">toolbox::loadbalancing::State</a>)</li>
<li>statistics (<a class="el" href="../../d5/dbe/classtoolbox_1_1loadbalancing_1_1Statistics.html" title="Statistics helper routine for load balancing.">toolbox::loadbalancing::Statistics</a>)</li>
</ul>
<p>These are generic properties modelled as attributes of toolbox::loadbalancing::AbstractLoadBalancing. Each attribute is in turn a class of its own. They have all different jobs. Please consult the individual class documentations for further details.</p>
<h2><a class="anchor" id="autotoc_md1202"></a>
Load balancing variations</h2>
<p>Besides "primitive" generic load balancing strategies realising one particular approach, you can also design cascades of load balancing strategies. Cascades are chains of different strategies. Whenever the Nth strategy comes to the conclusion that its load balancing has either terminated or stagnated, a cascade switches to the N+1th strategy to continue.</p>
<p>A lot of strategies have default settings. All the load balancing strategies work against some cost metrics metrics and the default here for example is loadbalancing::metrics::CellCount. But you can create your own cost metric and use this one instead, which might give you better balanced subdomains.</p>
<div class="image">
<img src="../../tree-topology.png" alt=""/>
</div>
<p>Of particular relevance is not only the decision when to split and where, but also how to split up the domain further. Peano supports two different split modes: bottom-up along the space-filling curve, and top-down within the spacetree. The latter approach is similar to recursive kd-decomposition. Each approach comes along with pros and cons. SFC-based partitioning makes it easier to have well-balanced domains, but the arising subdomain topology (who is adjacent to whom and what happens with coarser levels) can become tricky. Furthermore, you will have to know your mesh structure completely to construct good SFC subpartitions. Recursive top-down decomposition lends itself to domain decomposition which kicks in directly while we create the tree.</p>
<p>Not all strategies support both domain splitting schemes. You have to consult their documentation. Before you do so, I strongly recommend to read through <a class="el" href="../../d4/d00/page_peano_domain_decomposition.html">Peano's domain decomposition remarks</a>, and maybe even to read the paper</p>
<div class="fragment"><div class="line">@article{Weinzierl:2019:Peano,</div>
<div class="line">  author =       {T. Weinzierl},</div>
<div class="line">  title =        {The Peano software---<a class="code hl_namespace" href="../../d1/d80/namespaceparallel.html">parallel</a>, automaton-based, dynamically adaptive grid traversals},</div>
<div class="line">  journal =      {ACM Transactions on Mathematical Software},</div>
<div class="line">  year =         {2019},</div>
<div class="line">  <a class="code hl_function" href="../../d2/d45/namespacetarch_1_1la.html#a0652bd2078150d09c0cb5eed30291804">volume</a> =       {45},</div>
<div class="line">  number =       {2},</div>
<div class="line">  pages =        {14}</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceparallel_html"><div class="ttname"><a href="../../d1/d80/namespaceparallel.html">parallel</a></div><div class="ttdoc">The parallel namespace is Peano's core abstracts from both MPI and multicore parallelisation.</div></div>
<div class="ttc" id="anamespacetarch_1_1la_html_a0652bd2078150d09c0cb5eed30291804"><div class="ttname"><a href="../../d2/d45/namespacetarch_1_1la.html#a0652bd2078150d09c0cb5eed30291804">tarch::la::volume</a></div><div class="ttdeci">Scalar volume(const Vector&lt; Size, Scalar &gt; &amp;vector)</div><div class="ttdoc">Computes the volume of the tetrahedron spanned by the Cartesian unit vectors scaled by the correspond...</div><div class="ttdef"><b>Definition</b> <a href="../../d8/d88/VectorOperations_8cpph_source.html#l00175">VectorOperations.cpph:175</a></div></div>
</div><!-- fragment --><p>which is <a href="https://dl.acm.org/doi/10.1145/3319797">available through the gold access route</a>.</p>
<h2><a class="anchor" id="autotoc_md1203"></a>
Rebalancing, joins and AMR</h2>
<p>Peano does not support rebalancing with joins. That is, once a domain is split into two parts, the cuts in-between these parts will stay there forever. Almost. If a domain A splits into A and B, and if B degenerates, i.e. hosts exclusively unrefined cells, then B can be instructed to join A again.</p>
<p>This strict commitments to tree-like joins and forks makes the implementation easier - notably in a multiscale context. You can still oversubscribe the threads, i.e. create more logical subpartitions than threads, and hence mimic diffusion-based load balancing for example.</p>
<p>Dynamic AMR is no problem for the domain decomposition. That is, a refined region can ripple or propagate through a domain cut. However, Peano will never deploy a cell to another tree if that cell hosts a hanging vertex and its parent cell is not deployed to the same tree, too. This constrains notably the SFC-based bottom-up splitting. You might encounter situations where the AMR effectively "stops" the SFC decomposition from adding further cells to a new domain. The reason for this policy is that the tracking of multiscale data consistency between hanging nodes on different trees otherwise becomes unmanageable hard.</p>
<h2><a class="anchor" id="autotoc_md1204"></a>
Performance flaws</h2>
<p>Inappropriate or problematic domain decomposition decisions will always manifest in performance flaws. There are a few further resources that discuss generic details which are not tied to this toolbox. However, they are very useful to get the most out of this toolbox:</p>
<ul>
<li>Peano has a dedicated runtime analysis discussion which can help to understand the runtime behaviour shaped by the domain decomposition.</li>
<li>Peano has a dedicated page on <a class="el" href="../../da/d8a/page_peano_performance_optimisation.html">performance optimisation</a>. It discusses many flaws and how to fix them. The page below discussed more the rationale and provides background information why things work the way they do.</li>
</ul>
<p>Further to the generic Peano discussions, individual extensions have their own specific discussion of how to analyse and to understand performance characteristics, which in turn again might relate to domain decomposition decisions:</p>
<ul>
<li>Peano's <a class="el" href="../../d4/da7/page_exahype_runtime_analysis.html">runtime analysis discussion</a> and its <a class="el" href="../../d7/dfe/page_exahype_performance_optimisation.html">performance optimisation recipes</a>.</li>
<li>Swift's <a class="el" href="../../d3/dc8/page_swift_performance_optimisation.html">performance optimisation discussion</a>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1205"></a>
Tuning and Tailoring the domain decomposition</h1>
<p>While the toolbox offers some generic load balancing schemes, it will not be able to accommodate all applications. It notably will always lack domain-specific knowledge. However, there are generic tuning knobs and considerations. The page below summarises some generic rationale and lessons learned. Particular flaws and their fixes are discussed on the <a class="el" href="../../da/d8a/page_peano_performance_optimisation.html">Peano optimisation page</a>. So we get an explanation of things here, why things work the way they do. The recipes how to spot flaws and how to fix them are discussed on the generic page.</p>
<h2><a class="anchor" id="autotoc_md1206"></a>
Load balancing throughout mesh construction</h2>
<p>Every load balancing strategy in Peano 4 will have to balance two contradicting objectives:</p>
<ul>
<li>Load balancing has to happen as soon as possible throughout the grid construction process, as we want the grid construction to run in parallel. Splits in itself are also extremely memory-demanding&mdash;at least temporarily as parts of a partition have to be replicated and moved around&mdash;so we prefer setups that perform these splits before we have a lot of mesh data in place that has to be moved around.</li>
<li>Load balancing performs best if triggered for reasonably big meshes, as finer meshes allow for better tree cuts. If we know how many cells there are, we can balance these cells better, and we can subdivide cells more accurately: If we deploy a 3x3 grid to two cores, one core will get 5 and one 4 cells. If all cells refine once more, this will induce a 45 vs 36 mesh. If we cut a 9x9 mesh in a balanced way, we get a 41 vs 40 mesh. So the more we know, i.e. the closer the constructed mesh to the real final mesh, the better our domain.</li>
</ul>
<p>The first argument is a strict one. If we run out of memory, the simulation will crash. The second argument is a desirable one.</p>
<p>We derive generic guidelines for any load balancing:</p>
<ul>
<li>Split up aggressively initially such that a reasonable initial load decomposition is achieved: There are no single partitions of extreme size left over which will eventually be split up further. Such single large partitions might make us run out of memory later on.</li>
<li>Split aggressively for small partitions, split only once or twice per traversal later on when there are large partitions.</li>
<li>Fine tune a load decomposition as late as possible, when accurate SFC cuts in the mesh can be made. Keep in mind that we cannot diffuse load decompositions. We can only merge with a master and then resplit.</li>
<li>Throttle the grid construction or a grid refinement whenever we rebalance. Rebalancing is already problematic from a memory constraint point of view. <a class="el" href="../../db/d37/structAny.html">Any</a> further refinement makes this situation worse.</li>
<li>Maybe try not to use all cores immediately. Most Peano schemes (and the default configurations) try to have a most two logical subdomains per thread. If we go beyond this, they stop further decomposition. It therefore makes sense to have a few subpartitions per rank early on, so the mesh construction runs in parallel, but to spare some threads, i.e. to have fewer subdomains than threads, until the mesh is reasonably fine and accurate.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1207"></a>
Domain decomposition for existing partitions or late throughout the mesh construction</h2>
<p>It can makes sense to take into account that aggressive top-down splitting can handle AMR boundaries, while bottom-up SFC cuts struggle (see implementation). Consequently, you might want to switch between these flavours, too: SFC-based partitioning is good if a mesh is rather regular.</p>
<p>As soon as you have a mesh with a lot of AMR in it, it can be advantageous to switch to top-down domain decomposition. SFC-based approaches struggle to create subdomains spanning AMR boundaries (for technical reasons). The to-down approach basically does recursive kd-partitioning and hence is way more robust w.r.t. AMR.</p>
<p>Peano favours - due to its name - the bottom-up SFC-based decomposition, but most load balancing flavours also have a variant which uses top-down splitting. Please consult all classes within toolbox::loadbalancing::strategies.</p>
<h1><a class="anchor" id="autotoc_md1208"></a>
Formalisation of load balancing</h1>
<p>There is a dedicated subpage <a class="el" href="../../d2/d5f/page_toolbox_loadbalancing_strategies.html">Load balancing strategies</a> which describes load balancing with graph theoretic glasses on. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d7/d66/page_toolbox_home.html">Toolbox</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:07 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
