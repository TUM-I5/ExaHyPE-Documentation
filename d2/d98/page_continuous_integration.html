<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d2/d98/page_continuous_integration.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Continuous Integration (CI)</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md820">Gitlab CI</a></li>
<li class="level2"><a href="#autotoc_md821">How do I run the pipeline?</a></li>
<li class="level2"><a href="#autotoc_md822">How do I write my own tests?</a><ul><li class="level3"><a href="#autotoc_md823">Anatomy of a test</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md824">How do I add new runners to project?</a><ul><li class="level3"><a href="#autotoc_md825">Config template</a></li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><h2><a class="anchor" id="autotoc_md820"></a>
Gitlab CI</h2>
<p>For a full overview of how continuous integration works in gitlab, please consult <a href="https://docs.gitlab.com/ee/ci/">their documentation</a>. We detail here some useful info about how we use it within Peano. A few basic things to note:</p>
<ul>
<li>When a developer pushes to any remote branch, the gitlab website "runs a pipeline". This consists of running any steps in the <code>.gitlab-ci.yml</code> file. </li>
<li>Our <code>.gitlab-ci.yml</code> doesn't contain much actual stuff, but rather it redirects to further <code>.yml</code> files in the <code>.continuous_integration</code> directory. </li>
<li>We use containers to make sure we have a dependable software environment.</li>
</ul>
<h2><a class="anchor" id="autotoc_md821"></a>
How do I run the pipeline?</h2>
<p>The pipeline runs automatically for all branches and all pushes. However, it only runs fully on the protected branches. For all other branches, the pipeline only executes the build and test (unit tests) stages.</p>
<p>At time of writing, <code>gitlab-runner</code> is installed multiple nodes of DINE. The workers are kept alive by recurring slurm jobs. Peano developers should not need to do anything other than push to a branch, and <a href="https://gitlab.lrz.de/hpcsoftware/Peano/-/pipelines">check the pipelines page on the gitlab</a> to check that their code has correctly built for each compiler toolchain.</p>
<p>One unfortunate consequence of this is that if the slurm job that manages a particular runner goes down during a pipeline run, it will cause the jobs to hang until they timeout, meaning that whoever pushed needs to press the restart button on the pipeline page.</p>
<h2><a class="anchor" id="autotoc_md822"></a>
How do I write my own tests?</h2>
<p>Unfortunately, the use of the apptainer containers is not pretty, and so the best thing to do is describe your desired actions in a bash script and ask for help on the continuous-integration channel of the Slack.</p>
<h3><a class="anchor" id="autotoc_md823"></a>
Anatomy of a test</h3>
<p>It's best to copy examples, such as the ones in <code>.continuous_integration/templates/exahype2.yml</code>. But here are some general tips:</p>
<div class="fragment"><div class="line">.Test_Name:</div>
<div class="line">  stage: Test</div>
<div class="line">  needs:</div>
<div class="line">    - job: Build</div>
<div class="line">  script:</div>
<div class="line">    - apptainer exec -e --bind <span class="stringliteral">&quot;$APPTAINER_BINDDIR&quot;</span> $APPTAINER_IMAGEDIR/${IMAGE_TAG} bash &lt;&lt;&lt; <span class="stringliteral">&quot;cd to/my/directory; ./run_my_executable&quot;</span></div>
</div><!-- fragment --><p>Let's discuss this line-by-line.</p>
<p>Start by giving your test a name. Syntax is crucial here. Start with a <code>.</code> to indicate it's a template, and finish the line with a colon <code>:</code>. Every subsequent line must be indented with two spaces, python style.</p>
<p>Next, you need to give the job a stage. <code>Test</code> is a fine name.</p>
<p>Next, you need to make sure that this job depends on the build job. That way, it will run strictly after the job that checks it still compiles, and only if that succeeded. What's more, you won't have to wait for the whole of Peano to recompile; it will just fetch the compiled libraries that were cooked up a short while beforehand.</p>
<p>Finally, the script. This is very ugly. The first part <code>apptainer exec -e --bind "$APPTAINER_BINDDIR" $APPTAINER_IMAGEDIR/${IMAGE_TAG} bash</code> just transforms the standard bash terminal into one that runs under the container. The names of the environment variables are set for you. Then we need to pipe in our instructions (note the triple <code>&lt;</code> sign). Conceptually, you need to imagine that the terminal begins at the top level of Peano. So you need to <code>cd</code> into whichever directory you need to be and run whichever scripts you need to run. Note the separation with semicolon between separate statements, like in a normal bash terminal.</p>
<h2><a class="anchor" id="autotoc_md824"></a>
How do I add new runners to project?</h2>
<p>Having more runners online at once means more jobs can be run at once. Only the project owner can do these steps:</p>
<ul>
<li>Heading to Settings &gt; CI/CD &gt; Runners </li>
<li>Add a new project runner. Make sure the tag is set to <code>peano-dine-runner</code> (no other tags have been written into the repo yet), make sure the project is locked to the current project and click create.</li>
</ul>
<p>It will then show you a token. Write it down.</p>
<p>Now we need to register this runner. Log into a node where <code>gitlab-runner</code> is available, and then type <code>gitlab-runner register</code>. Type in the url and token as prompted. Pick <code>shell</code> as an executor.</p>
<p>This will then create a new config file in <code>$HOME/.gitlab-runner</code> directory. Move this to the /dine/data/do009/peano/configs directory.</p>
<p>You can then run the gitlab-runner and supply this config by calling <code>gitlab-runner run --config /path/to/config.toml</code>. This is what the slurm job is supposed to do.</p>
<h3><a class="anchor" id="autotoc_md825"></a>
Config template</h3>
<pre class="fragment">concurrent = 4
check_interval = 0
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "b101Runner"
  url = "https://gitlab.lrz.de"
  id = 35483
  token = "keep-this-token-private"
  token_obtained_at = 2024-06-19T11:16:06Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = "shell"
  builds_dir = "/dine/data/do009/peano/builds_dir"
  cache_dir  = "/dine/data/do009/peano/cache_dir"</pre><p>concurrent denotes the number of concurrent builds that can run at once. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:03 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
