<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d4/d9b/swift_initial_conditions.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Initial conditions, particle insertion and initial mesh construction</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Swift 2 always runs through the same sequence of setup steps prior to the actual calculation:</p>
<ol type="1">
<li>Create a regular mesh that is just as fine that it can accommodate the largest predicted search radius of all particles.</li>
<li>Insert the particles (initial condition).</li>
<li>Run a set of initialisation steps, where particles can define some "warm up" calculation steps and are also sorted once more, should they have been inserted into the wrong cells.</li>
</ol>
<h1><a class="anchor" id="autotoc_md1114"></a>
The initial (regular) mesh</h1>
<p>The first step is important, even though particles are allowed to change their search radius. It is important to tell the code base right from the start what the biggest and smallest radius might be, but the radius can change freely in-between those thresholds. Actually the radius might even become smaller, but the mesh width you pass in initially is used to constrain the AMR throughout the simulation.</p>
<p>The dynamic mesh refinement might decide to introduce an extremely fine mesh in some places and to erase the mesh somewhere else. However, we have to start somewhere, as we do not want to run the initial insertion of particles into a single cell, then great this initial grid (which is obviously guided by the particle distribution) and finally create the adaptive grid. Instead, the code creates some initial grid and load balances this one. After that, it inserts the particles (in parallel) and might still change both the load balancing and the mesh structure. But we have to start somewhere.</p>
<p>By default, the initial grid is a regular mesh controlled by the potential maximal particle search radius. As pointed out: this search radius can change over time and thus is solely an initial indicator. You can alter the initial mesh and hence start with an adaptive one right from the start. For this, you can take the step algorithm_step_create_grid which is an attribute of your <a class="el" href="../../d6/d70/namespaceswift2_1_1Project.html">swift2.Project</a> and add further action sets which refine your mesh according to your needs. However, the initial grid construction will try to establish a stationary grid, so ensure that you define a stationary grid, i.e. not a grid where you sometimes erase parts and sometimes add parts.</p>
<h1><a class="anchor" id="autotoc_md1115"></a>
Initial conditions</h1>
<p>The initial conditions are added by one mesh sweep modelled by the project's attribute algorithm_step_initial_conditions. It represents the grid sweep, i.e. mesh sweep, which sets up the inition condition. That is, if you want to insert particles, you have to add action sets to this algorithm step calling add_action_set(). The passed action sets have to throw all the particles you want to have into your mesh. There are three mainstream ways to implement initial conditions for the simulations:</p>
<ul>
<li>Insert particle by coordinates (<code><a class="el" href="../../dc/d65/swift2_2input_2InsertParticlesByCoordinates_8py.html">python/swift2/input/InsertParticlesByCoordinates.py</a></code>).</li>
<li>Insert particle along a regular mesh (<code><a class="el" href="../../dd/d30/InsertParticlesAlongCartesianGrid_8py.html">python/swift2/input/InsertParticlesAlongCartesianGrid.py</a></code>).</li>
<li>Insert particles from an HDF5 file (<code><a class="el" href="../../d9/d5b/InsertParticlesFromHDF5File_8py.html">python/swift2/input/InsertParticlesFromHDF5File.py</a></code>).</li>
</ul>
<p>Nothing stops you from additing further action sets to algorithm_step_initial_conditions. Some scenarios, for example, hard code the initial condition of further particles. The <a class="el" href="../../d9/d7c/tests_swift2_planet_orbit.html">planet orbit benchmark</a> is such an example, where no input files are required.</p>
<p>The particle inserters as discussed above typically only set a subset of the particle attributes. They are generic tools and thus cannot know which attributes your particle actually hosts and requires to be set. To discuss how to initialise the attributes, we have to distinguish two types of attributes:</p>
<ol type="1">
<li>There are attributes which are domain-specific and have to be set by the initial conditions to meaningful values.</li>
<li>There are attributes which have to be calculated prior to the kick off of the simulation.</li>
</ol>
<p>To set the intial conditions, it is worth looking into the documentation of your particle inserter of choice. Most of them allow you to add some further initialisation snippets or tailor the reader, such that you can set the particle attributes of interest. Alternatively, you might want to create a subclass of a generic file reader that is specific to your setup and, for example, grabs additional particle attributes from the input file.</p>
<p>If you don't want to mess with the particle reader, nothing stops you from adding an additional action set to the initial condition sweep. This set can run over all particles within a vertex - once they are inserted - and set meaningful attribute values.</p>
<p>If you have to calculate particle attributes after the particles are thrown into the domain, these calculations are best modelled as <a class="el" href="../../d2/daf/swift_particle_new_solver.html">steps within the particle lifecycle</a>.</p>
<h1><a class="anchor" id="page_swift_initial_conditions_SwiftHDF5"></a>
Insert particles from an HDF5 file</h1>
<p>A basic HDF5 reader that is compatible with IC files from the original Swift code is implemented in <code><a class="el" href="../../d9/d5b/InsertParticlesFromHDF5File_8py.html">InsertParticlesFromHDF5File.py</a></code>. In order to make use of the HDF5 Initial conditions reader, Peano must have been configured with HDF5 enabled and linked. Instructions are provided <a class="el" href="../../d6/dba/page_swift2_home.html#section_compile_swift2_with_hdf5">here</a>. Also make sure to install the <a class="el" href="../../d6/dba/page_swift2_home.html#section_swift2_python_hdf5">Python hdf5 libraries</a>, which may be required for python scripts which generate the initial conditions.</p>
<h1><a class="anchor" id="autotoc_md1116"></a>
General remarks on particle insertion</h1>
<p>There are a few key policies to follow whenever you insert particles:</p>
<ol type="1">
<li>Particles have to be created on the heap, i.e. via an explicit new</li>
<li>Every particle has to be initialised. You do this by calling <a class="el" href="../../d0/d29/namespacetoolbox_1_1particles.html#ac14ceda9c0640b68579d0c22646ad8b7" title="Init particle.">toolbox::particles::init()</a>. As you need need this helper routine, you have to include <a class="el" href="../../d7/dd9/particles_8h.html">toolbox/particles/particles.h</a>.</li>
<li>Particles have to be inserted into cells, and you should not try to do this on your own. Instead use the helper function from <a class="el" href="../../d7/dd9/particles_8h.html">particles.h</a>:</li>
</ol>
<div class="fragment"><div class="line"><a class="code hl_function" href="../../d0/d29/namespacetoolbox_1_1particles.html#a593ad6871d8a624f665e22cb5cfc0ea8">toolbox::particles::insertParticleIntoCell</a>(</div>
<div class="line">  marker,</div>
<div class="line">  particle,</div>
<div class="line">  fineGridVerticesParticleSet</div>
<div class="line">);</div>
<div class="ttc" id="anamespacetoolbox_1_1particles_html_a593ad6871d8a624f665e22cb5cfc0ea8"><div class="ttname"><a href="../../d0/d29/namespacetoolbox_1_1particles.html#a593ad6871d8a624f665e22cb5cfc0ea8">toolbox::particles::insertParticleIntoCell</a></div><div class="ttdeci">void insertParticleIntoCell(const peano4::datamanagement::CellMarker &amp;marker, Particle *newParticles, peano4::datamanagement::VertexEnumerator&lt; ParticleSet &gt; &amp;fineGridVertices, int spacetreeId)</div><div class="ttdoc">Insert particle into cell.</div><div class="ttdef"><b>Definition</b> <a href="../../d7/dfd/particles_8cpph_source.html#l00093">particles.cpph:93</a></div></div>
</div><!-- fragment --><p>Obviously, the names for the parameters for <a class="el" href="../../d0/d29/namespacetoolbox_1_1particles.html#a593ad6871d8a624f665e22cb5cfc0ea8" title="Insert particle into cell.">toolbox::particles::insertParticleIntoCell()</a> depend on the location from where you call the routine. As you insert particles into cells (even though the code will then assign them to vertices adjacent to the cells), you plug into touchCellFirstTime() or touchCellLastTime(). I recommend the former. These two events always are given a parameter</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="../../dc/d59/structpeano4_1_1datamanagement_1_1CellMarker.html">peano4::datamanagement::CellMarker</a>&amp; marker</div>
<div class="ttc" id="astructpeano4_1_1datamanagement_1_1CellMarker_html"><div class="ttname"><a href="../../dc/d59/structpeano4_1_1datamanagement_1_1CellMarker.html">peano4::datamanagement::CellMarker</a></div><div class="ttdoc">Cell marker.</div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00039">CellMarker.h:39</a></div></div>
</div><!-- fragment --><p>and you can use <a class="el" href="../../dc/d59/structpeano4_1_1datamanagement_1_1CellMarker.html#aa95cd9a5ed79cb4935a878de1fa90fed" title="Is x contained within cell identified by marker object.">peano4::datamanagement::CellMarker::isContained()</a> to check if a particle should be fitted into a cell. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d6/dba/page_swift2_home.html">Swift 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:06 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
