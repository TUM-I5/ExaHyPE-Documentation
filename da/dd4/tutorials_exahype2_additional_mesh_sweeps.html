<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('da/dd4/tutorials_exahype2_additional_mesh_sweeps.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Introducing additional mesh sweeps</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md526">Triggering the new mesh traversal</a></li>
<li class="level1"><a href="#autotoc_md527">Add behaviour</a><ul><li class="level2"><a href="#autotoc_md528">Manually implement new functionality</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md529">Switch the additional traversals on/off</a><ul><li class="level2"><a href="#autotoc_md530">Create new functionality in Python</a></li>
<li class="level2"><a href="#autotoc_md531">Use pre-defined functionality</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md532">Dynamic adaptivity</a></li>
<li class="level1"><a href="#autotoc_md533">Add new data to the mesh</a></li>
<li class="level1"><a href="#autotoc_md534">Left-over from second roder scheme</a><ul><ul><li class="level3"><a href="#autotoc_md535">Alter the main function</a></li>
<li class="level3"><a href="#autotoc_md536">Logic behind the additional mesh traversal selection</a></li>
<li class="level3"><a href="#autotoc_md537">Hijack the projection</a></li>
</ul>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Some applications of ExaHyPE have to add additional mesh sweeps. This can be due to added functionality or as they want to couple the ExaHyPE solver with another code. The latter approach is the most flexible use case. We therefore discuss this one here, as it covers the "simpler" ambition to add only an additional mesh sweep to an existing ExaHyPE solver. Therefore, our dicussions follows the <a class="el" href="../../df/db4/page_peano_merging_applications.html">Peano's generic coupling description</a>. Please read through this discussion before continuing with this section (the description actually refers back to this page at one point).</p>
<p>The way how to add steps is relatively mechanical:</p>
<ol type="1">
<li><p class="startli">Generate the <a class="el" href="../../d1/df8/namespacepeano4_1_1Project.html">peano4.Project</a> object from ExaHyPE. This is referred to as "lowering" in <a class="el" href="../../df/db4/page_peano_merging_applications.html">Merging/coupling various applications</a>.</p>
<div class="fragment"><div class="line">peano4_project = project.generate_Peano4_project()</div>
</div><!-- fragment --></li>
<li><p class="startli">Create a new algorithmic step with Peano.</p>
<div class="fragment"><div class="line">additional_step = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../dc/d5c/namespacepeano4_1_1solversteps.html">solversteps</a>.<a class="code hl_namespace" href="../../dc/d53/namespacepeano4_1_1solversteps_1_1Step.html">Step</a>( name = <span class="stringliteral">&quot;AdditionalStep&quot;</span>,</div>
<div class="line">                                           add_user_defined_actions=True,</div>
<div class="line">                                           )</div>
<div class="line">peano4_project.solversteps.add_step( additional_step )</div>
<div class="ttc" id="anamespacepeano4_1_1solversteps_1_1Step_html"><div class="ttname"><a href="../../dc/d53/namespacepeano4_1_1solversteps_1_1Step.html">peano4.solversteps.Step</a></div><div class="ttdef"><b>Definition</b> <a href="../../d4/d32/Step_8py_source.html#l00001">Step.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1solversteps_html"><div class="ttname"><a href="../../dc/d5c/namespacepeano4_1_1solversteps.html">peano4.solversteps</a></div><div class="ttdef"><b>Definition</b> <a href="../../d5/d1d/python_2peano4_2solversteps_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --><p class="startli">In this example, we plan to manually interact with the step, i.e. to insert C++ code manually into the events once the code is generated. Therefore, we pass in a True here.</p>
</li>
<li><p class="startli">Make all of ExaHyPE's data structures known to your new step. For this, you have to invoke use_cell(), use_vertex() and use_face() commands for each and every solver. As the solvers are tied to the ExaHyPE project, it offers a routine exahype2.Project.init_new_user_defined_algorithmic_step() which you can use to add the required statements.</p>
<div class="fragment"><div class="line">project.init_new_user_defined_algorithmic_step( additional_step )</div>
</div><!-- fragment --><p class="startli">This routine can also be invoked earlier. You just have to ensure that all the solvers are already properly added to the ExaHyPE project. See the method documentation.</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md526"></a>
Triggering the new mesh traversal</h1>
<p>You still have to trigger the actual mesh traversal. For this, you have to alter the main function. ExaHyPE generates a dummy main in you application's root directory which works for most plain ExaHyPE codes. However, it will never overwrite the main if you have already created a bespoke one.</p>
<p>Before you start manipulating the main, please have a look into the generated file repositories/StepRepository.h. The enum Steps should already contain an entry for your additional algorithmic step once you have followed the instructions from the previous section. That is, Peano knows that the there are all the ExaHyPE mesh traversals and then there's a new, additional one.</p>
<ol type="1">
<li><p class="startli">Scroll to the function <a class="el" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#a832439084ea25145fd3b2894160a520b">selectNextAlgorithmicStep()</a> within the main cpp file. and insert the lines as of below.</p>
<div class="fragment"><div class="line">[...]</div>
<div class="line">  <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">    repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::PlotSolution )</div>
<div class="line">  );</div>
<div class="line">  haveJustWrittenSnapshot = <span class="keyword">true</span>;</div>
<div class="line">  continueToSolve         = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line">  (</div>
<div class="line">    repositories::isLastGridSweepOfTimeStep()</div>
<div class="line">    or</div>
<div class="line">    repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() )==repositories::StepRepository::Steps::InitGrid</div>
<div class="line">  )</div>
<div class="line">  and</div>
<div class="line">  repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">) {</div>
<div class="line">  <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">    repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::AdditionalStep )</div>
<div class="line">  );</div>
<div class="line">  continueToSolve         = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> ( repositories::getMinTimeStamp()&lt;MinTerminalTime and repositories::getMaxTimeStamp()&lt;MaxTerminalTime ) {</div>
<div class="line">  <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">    repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::TimeStep )</div>
<div class="line">  );</div>
<div class="line">  continueToSolve         = <span class="keyword">true</span>;</div>
<div class="line">[...]</div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1Node_html_a7bc31c5e9f0f24785ae7e19d7add30c0"><div class="ttname"><a href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a></div><div class="ttdeci">static Node &amp; getInstance()</div><div class="ttdef"><b>Definition</b> <a href="../../dc/d73/Node_8cpp_source.html#l00077">Node.cpp:77</a></div></div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1Node_html_a8a2b782cd625b91d5fdfb97b56f18caa"><div class="ttname"><a href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">peano4::parallel::Node::setNextProgramStep</a></div><div class="ttdeci">void setNextProgramStep(int number)</div><div class="ttdoc">The user tells the set which program step to use, i.e.</div><div class="ttdef"><b>Definition</b> <a href="../../dc/d73/Node_8cpp_source.html#l00415">Node.cpp:415</a></div></div>
</div><!-- fragment --><p class="startli">We basically let all the logic when to plot and how to pick time steps in place, but before the solver wants to do the very first grid sweep of a new time step, we postpone this step and instead run our new additional step (which we creatively named AdditionalStep in this example). Nothing stops you to extend this logic such that multiple additional steps are executed in a row. You can also obviously plug into the stage just after the solver initialisation:</p>
<p class="startli">The statement </p><div class="fragment"><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line">  (</div>
<div class="line">    repositories::isLastGridSweepOfTimeStep()</div>
<div class="line">    or</div>
<div class="line">    repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() )==repositories::StepRepository::Steps::InitGrid</div>
<div class="line">  )</div>
<div class="line">  and</div>
<div class="line">  repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">) {</div>
</div><!-- fragment --><p> runs the additional step directly after the initialisation sweep and then after each time step. If you write </p><div class="fragment"><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line">  repositories::isLastGridSweepOfTimeStep()</div>
<div class="line">  and</div>
<div class="line">  repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">) {</div>
</div><!-- fragment --><p> the initialisation will be followed by a first time step (typically with time step size 0 as we have to fiddle out the admissible time step size). After this first one, it injects an additional sweep and from hereon one after each further time step.</p>
<p class="startli">The only thing you should not do is a statement similar to </p><div class="fragment"><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line">  repositories::isFirstGridSweepOfTimeStep()</div>
<div class="line">  and</div>
<div class="line">  repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">) {</div>
</div><!-- fragment --><p> The predicate isFirstGridSweepOfTimeStep() becomes true right after the first beginIteration() and stays on this value. See its documentation. That means that it is true after a primary sweep (if you have an enclave solver) or the first trial in a Runge-Kutta scheme.</p>
<p class="startli">As all solvers with a CFL evaluation will run an initial time step with time step size zero, plugging into the mesh traversal after the first time step has completed is sufficient. See remark above.</p>
</li>
<li><p class="startli">We now have to ensure that all MPI ranks and threads run this one step if we trigger it. For this, we scroll to <a class="el" href="../../d5/db2/MatrixFreeMain_8template_8cpp.html#ac6bf1a12c5c98ddec5b65e07fe74cabe">step()</a> and add a new case statement there:</p>
<div class="fragment"><div class="line"><span class="keywordflow">case</span> repositories::StepRepository::Steps::AdditionalStep:</div>
<div class="line">  {</div>
<div class="line">    <a class="code hl_function" href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#ae70e7bea503522c87e6cb0c3a2332949">tarch::logging::LogFilter::getInstance</a>().<a class="code hl_function" href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#a572ffc6edabe32f97768f80cc1005129">switchProgramPhase</a>( <span class="stringliteral">&quot;additional-step&quot;</span> );</div>
<div class="line"> </div>
<div class="line">    repositories::suspendSolversForOneGridSweep();</div>
<div class="line">    observers::AdditionalStep  observer;</div>
<div class="line">    <a class="code hl_function" href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#aaf5202ec306988b5b7a2226ef01908cc">peano4::parallel::SpacetreeSet::getInstance</a>().<a class="code hl_function" href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#af3302644e7f7848b653167f1502f3554">traverse</a>(observer);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1SpacetreeSet_html_aaf5202ec306988b5b7a2226ef01908cc"><div class="ttname"><a href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#aaf5202ec306988b5b7a2226ef01908cc">peano4::parallel::SpacetreeSet::getInstance</a></div><div class="ttdeci">static SpacetreeSet &amp; getInstance()</div><div class="ttdef"><b>Definition</b> <a href="../../d2/df0/SpacetreeSet_8cpp_source.html#l00029">SpacetreeSet.cpp:29</a></div></div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1SpacetreeSet_html_af3302644e7f7848b653167f1502f3554"><div class="ttname"><a href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#af3302644e7f7848b653167f1502f3554">peano4::parallel::SpacetreeSet::traverse</a></div><div class="ttdeci">void traverse(peano4::grid::TraversalObserver &amp;observer)</div><div class="ttdoc">Invoke traverse on all spacetrees in parallel.</div><div class="ttdef"><b>Definition</b> <a href="../../d2/df0/SpacetreeSet_8cpp_source.html#l00461">SpacetreeSet.cpp:461</a></div></div>
<div class="ttc" id="aclasstarch_1_1logging_1_1LogFilter_html_a572ffc6edabe32f97768f80cc1005129"><div class="ttname"><a href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#a572ffc6edabe32f97768f80cc1005129">tarch::logging::LogFilter::switchProgramPhase</a></div><div class="ttdeci">void switchProgramPhase(const std::string &amp;activeProgramPhase)</div><div class="ttdef"><b>Definition</b> <a href="../../df/d31/LogFilter_8cpp_source.html#l00114">LogFilter.cpp:114</a></div></div>
<div class="ttc" id="aclasstarch_1_1logging_1_1LogFilter_html_ae70e7bea503522c87e6cb0c3a2332949"><div class="ttname"><a href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#ae70e7bea503522c87e6cb0c3a2332949">tarch::logging::LogFilter::getInstance</a></div><div class="ttdeci">static LogFilter &amp; getInstance()</div><div class="ttdef"><b>Definition</b> <a href="../../df/d31/LogFilter_8cpp_source.html#l00109">LogFilter.cpp:109</a></div></div>
</div><!-- fragment --><p class="startli">The important tiny detail here is the call to suspendSolversForOneGridSweep(), which will invoke suspendSolversForOneGridSweep() on each and every ExaHyPE solver. This tells them that we have a "spare" mesh traversal - logically similar to a plot - where they don't have to compute anything.</p>
</li>
<li><p class="startli">Last but not least, add the corresponding include to your main:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;observers/AdditionalStep.h&quot;</span></div>
</div><!-- fragment --></li>
</ol>
<p>This modificated logic squeezes the additional steps in-between any two complete time steps. If a solver requires multiple mesh sweeps to realise its update, this sequence of sweeps will not be interrupted. While the realisation as sketched so far works on a single core, it very likely will crash immediately once you use domain decomposition: All ExaHyPE solvers make quite distinct decisions whether to send out data in any single grid sweep or not. <a class="el" href="../../db/d37/structAny.html">Any</a> decision has to be matched with the corresponind receive logic: If we send out data in iteration n, these data have to be reveived in iteration n+1.</p>
<p>Rather than modifying this complex logic, we observe that ExaHyPE has already defined one type of mesh traversal which can always squeeze into any two time steps: the plotting.</p>
<h1><a class="anchor" id="autotoc_md527"></a>
Add behaviour</h1>
<h2><a class="anchor" id="autotoc_md528"></a>
Manually implement new functionality</h2>
<p>In the example above, we tell the new action set that we want to manually add new behaviour, as we set the flag</p>
<div class="fragment"><div class="line">add_user_defined_actions=True</div>
</div><!-- fragment --><p>As a consequence, we will obtain a new class within our project's actionset directory. You can directly add behaviour into this class. Please note that such a class is never overwritten by subsequent Python API invocations.</p>
<p>Adding behaviour manually is only one way to inject behaviour. You might as well set</p>
<div class="fragment"><div class="line">add_user_defined_actions=False</div>
</div><!-- fragment --><p>In this case, no new class in actionsets is generated. You will have to add additional behaviour yourself as detailed below.</p>
<h1><a class="anchor" id="autotoc_md529"></a>
Switch the additional traversals on/off</h1>
<p>Some benchmarks want to enable the additional traversals for some solver choices, while they don't need it for others. In this case, we have identified some best practices. You start from a vanilla main as generated by the Python API, and then you make modifications to this main. Main files are not overwritten by the API if it already finds and existing one, so once your modified main is added to the repository, you can be sure every checkout sees this one even though glue code is to be regenerated on a new system.</p>
<p>To switch the feature no/off, I recommend that you make your Python script (the simulation driver) trigger this line</p>
<div class="fragment"><div class="line">peano4_project.constants.define( <span class="stringliteral">&quot;USE_ADDITIONAL_MESH_TRAVERSAL&quot;</span> )</div>
</div><!-- fragment --><p>whenever you need additional mesh traversals. Within the main, you can then protected the code regions of interest with</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if defined(USE_ADDITIONAL_MESH_TRAVERSAL)</span></div>
</div><!-- fragment --><p>An example for the realisation of this usage pattern is benchmarks/exahhype2/ccz4/gauge-wave. Study <a class="el" href="../../d4/d54/benchmarks_exahype2_ccz4_gauge_wave.html">RKDG Solver (Gauge Wave)</a> for a discussion of their particular algorithmic steps.</p>
<h2><a class="anchor" id="autotoc_md530"></a>
Create new functionality in Python</h2>
<p>The canonical way to add new functionality directly via Python follows always the same pattern:</p>
<ol type="1">
<li>Create a new Python class which inherits from <a class="el" href="../../d8/d95/namespacepeano4_1_1solversteps_1_1ActionSet.html">peano4.solversteps.ActionSet</a>: <div class="fragment"><div class="line"><span class="keyword">import</span> peano4</div>
<div class="line"> </div>
<div class="line"> class MyActionSet(peano4.solversteps.ActionSet):</div>
<div class="line">     def __init__(self):</div>
<div class="line">         super( MyActionSet, self ).__init__(descend_invocation_order = 0, </div>
<div class="line">                                             parallel = False,</div>
<div class="line">                                             )</div>
<div class="line">          [...]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> def user_should_modify_template(self):</div>
<div class="line">     return False</div>
</div><!-- fragment --></li>
<li>Ensure that you main script imports this <a class="el" href="../../da/d1b/peano_action_sets.html">action set</a>.</li>
<li>Add it to your new user-defined step: <div class="fragment"><div class="line">additional_mesh_traversal = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../dc/d5c/namespacepeano4_1_1solversteps.html">solversteps</a>.<a class="code hl_namespace" href="../../dc/d53/namespacepeano4_1_1solversteps_1_1Step.html">Step</a>( name = <span class="stringliteral">&quot;AdditionalMeshTraversal&quot;</span>,</div>
<div class="line">                                                     add_user_defined_actions=False,</div>
<div class="line">                                                     )</div>
<div class="line">additional_mesh_traversal.add_action_set( <a class="code hl_namespace" href="../../de/da5/namespaceComputeFirstDerivatives.html">ComputeFirstDerivatives</a>() )</div>
<div class="ttc" id="anamespaceComputeFirstDerivatives_html"><div class="ttname"><a href="../../de/da5/namespaceComputeFirstDerivatives.html">ComputeFirstDerivatives</a></div><div class="ttdef"><b>Definition</b> <a href="../../d8/db5/ComputeFirstDerivatives_8py_source.html#l00001">ComputeFirstDerivatives.py:1</a></div></div>
</div><!-- fragment --></li>
<li>Overwrite the functions from ActionSet, i.e. the superclass, which you actually want to overwrite.</li>
</ol>
<p>A classic example for a sophisticated variant of the the last step is the action set implemented within <a class="el" href="../../d8/db5/ComputeFirstDerivatives_8py.html">applications/exahype2/ccz4/ComputeFirstDerivatives.py</a>. It extends peano4.toolbox.blockstructured.ReconstructPatchAndApplyFunctor for a Finite Difference scheme. This one in turn inherits from <a class="el" href="../../d8/d95/namespacepeano4_1_1solversteps_1_1ActionSet.html">peano4.solversteps.ActionSet</a>. Once defined, we again add this to the step via add_action_set().</p>
<h2><a class="anchor" id="autotoc_md531"></a>
Use pre-defined functionality</h2>
<p>You can write your own <a class="el" href="../../da/d1b/peano_action_sets.html">action sets</a> to it (see above), and/or you can use existing action sets within your additional mesh sweep. Each additional mesh sweep has access to all ExaHyPE solver data. Nothing stops you from using and manipulating these data in your additional mesh sweeps.</p>
<p>For this, I recommend that you study your solver objects' interna. Each of them creates a whole suite of solver-specific action sets which are then added to the individual steps via add_actions_to_perform_time_step(). Each solver also creates its own distinct set of data structures and ties them to vertices, faces and cells.</p>
<p>A good example is the <a class="el" href="../../dc/db6/ccz4_8py.html">ccz4.py</a> script and the action sets within <a class="el" href="../../d8/db5/ComputeFirstDerivatives_8py.html">ComputeFirstDerivatives.py</a> which can be found in applications/exahype2/ccz4. Here, we define an additional action set which manipulates the "solution" after each time step or Runge-Kutta step, respectively. It manipulates the solver's core data structure, and is used in combination with various pre-defined action sets such as <a class="el" href="../../d8/de7/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_1_1ProjectPatchOntoFaces.html">exahype2.solvers.rkfd.actionsets.ProjectPatchOntoFaces</a>.</p>
<h1><a class="anchor" id="autotoc_md532"></a>
Dynamic adaptivity</h1>
<p>Do not coarsen or erase the mesh in the additional grid sweeps. Some ExaHyPE solvers are really picky when it comes to when they can refine or not. A refinement in-between two Runge-Kutta steps for example is not particularly helpful. If you need the additional steps to trigger mesh modifications, use the <a class="el" href="../../d7/d48/classexahype2_1_1RefinementControl.html" title="Manage refine/erase requests within ExaHyPE 2.">exahype2::RefinementControl</a> objects and add them to <a class="el" href="../../d4/df3/classexahype2_1_1RefinementControlService.html">exahype2::RefinementControlService</a>. The service serves as a middle layer in-between ExaHyPE and Peano.</p>
<h1><a class="anchor" id="autotoc_md533"></a>
Add new data to the mesh</h1>
<p>By the time we have configured the new additional steps, you are working with a plain Peano project. You consequently have quite some freedom. One of the things you can do is to add arbitrary data to the mesh vertices, face and cell which have nothing to do with the core ExaHyPE solvers in use. You can augment the whole setup with your own data.</p>
<p>While the routine init_new_user_defined_algorithmic_step() ensures that additional, user-defined algorithmic steps "know" which data ExaHyPE associates with each grid entity (face, mesh, vertex), this does not hold the other way round:</p>
<p>If you want to add further data to the mesh, you first create this data. After that, you add the corresponding use_face(), use_vertex() or use_cell() calls to your script for your new mesh traversal. At this point, you also have to notify all of ExaHyPE's mesh traversals that we have the additional data. They also traverse the mesh and if they are not aware of some user data attached to it, this might lead to data inconsistencies. For this, you have to iterate over all of the steps associated with the Peano project and add the usage information there as well.</p>
<p>Unfortunately, it becomes a little bit nasty here: By the time you add the new data, the ExaHyPE project has already lowered its data representation into Peano. That is, you cannot work with the ExaHyPE data representation anymore (with solvers and their actions), but you have to alter Peano's data representation: Basically, you have to iterate over all mesh sweeps within the Peano project, and ensure that they know about the additional data that you inject into the system.</p>
<h1><a class="anchor" id="autotoc_md534"></a>
Left-over from second roder scheme</h1>
<p>To realise the second order formulation, you have to invoke the Python script with the -so switch. If this switch is set, we add an additional mesh traversal to the arising Peano project, which we call after each and every Runge-Kutta step, as well as after the very last step.</p>
<h3><a class="anchor" id="autotoc_md535"></a>
Alter the main function</h3>
<p>We now need a main file that can both handle the additional mesh sweep as well as the version without an additional sweep. We don't want to write a main twice. Therefore, we either add</p>
<div class="fragment"><div class="line">peano4_project.constants.define( <span class="stringliteral">&quot;USE_ADDITIONAL_MESH_TRAVERSAL&quot;</span> )</div>
</div><!-- fragment --><p>or we don't. This will yield a define pragma in Constants.h (generated). We query this pragma in the code when we decide which step we pick</p>
<div class="fragment"><div class="line"><span class="preprocessor">    #if defined(USE_ADDITIONAL_MESH_TRAVERSAL)</span></div>
<div class="line">    <span class="keywordflow">if</span> (</div>
<div class="line">      repositories::isLastGridSweepOfTimeStep()</div>
<div class="line">      and</div>
<div class="line">      repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">      ) {</div>
<div class="line">        <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">        repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::AdditionalMeshTraversal )</div>
<div class="line">      );</div>
<div class="line">      continueToSolve         = <span class="keyword">true</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> </div>
<div class="line"><span class="preprocessor">    #endif</span></div>
</div><!-- fragment --><p>and also within the switch statement which runs the additional step:</p>
<div class="fragment"><div class="line"><span class="preprocessor">  #if defined(USE_ADDITIONAL_MESH_TRAVERSAL)</span></div>
<div class="line">  <span class="keywordflow">case</span> repositories::StepRepository::Steps::AdditionalMeshTraversal:</div>
<div class="line">    {</div>
<div class="line">      <a class="code hl_function" href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#ae70e7bea503522c87e6cb0c3a2332949">tarch::logging::LogFilter::getInstance</a>().<a class="code hl_function" href="../../d7/d3a/classtarch_1_1logging_1_1LogFilter.html#a572ffc6edabe32f97768f80cc1005129">switchProgramPhase</a>( <span class="stringliteral">&quot;additional-MeshTraversal&quot;</span> );</div>
<div class="line">   </div>
<div class="line">      repositories::suspendSolversForOneGridSweep();</div>
<div class="line">      observers::AdditionalMeshTraversal observer;</div>
<div class="line">      observers::AdditionalMeshTraversal::prepareTraversal();</div>
<div class="line">      <a class="code hl_function" href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#aaf5202ec306988b5b7a2226ef01908cc">peano4::parallel::SpacetreeSet::getInstance</a>().<a class="code hl_function" href="../../da/d58/classpeano4_1_1parallel_1_1SpacetreeSet.html#af3302644e7f7848b653167f1502f3554">traverse</a>(observer);</div>
<div class="line">      observers::AdditionalMeshTraversal::unprepareTraversal();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"><span class="preprocessor">  #endif</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md536"></a>
Logic behind the additional mesh traversal selection</h3>
<p>A naive way to implement the activation of the additional mesh sweep is the following code snippet:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (</div>
<div class="line">  repositories::isFirstGridSweepOfTimeStep()</div>
<div class="line">  and</div>
<div class="line">  repositories::StepRepository::toStepEnum( <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().getCurrentProgramStep() ) != repositories::StepRepository::Steps::AdditionalMeshTraversal</div>
<div class="line">  ) {</div>
<div class="line">    <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">    repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::AdditionalMeshTraversal )</div>
<div class="line">  );</div>
<div class="line">  continueToSolve         = <span class="keyword">true</span>;</div>
<div class="line">} <span class="keywordflow">else</span> </div>
</div><!-- fragment --><p>This variant kicks off the manual reconstruction prior to the first mesh sweep of the Runge-Kutta scheme. This seems to work and to do the job in our setup. However, it is not enough for higher-order convergence, where we would need a preprocessing step prior to each intermediate step. We ignore this fact here.</p>
<h3><a class="anchor" id="autotoc_md537"></a>
Hijack the projection</h3>
<p>Once we have computed the second derivatives into auxiliary variables, we have to project those guys onto the boundary. For this, we hijack the projection of the Runge-Kutta scheme. The documentation of <a class="el" href="../../d8/de7/namespaceexahype2_1_1solvers_1_1rkfd_1_1actionsets_1_1ProjectPatchOntoFaces.html">exahype2.solvers.rkfd.actionsets.ProjectPatchOntoFaces</a> requires K+1 predicates for a Runge-Kutta scheme of Kth order. The first K entries correspond to the Runge-Kutta scheme. The last one allows you to do something different for the initialisation. We disable all K-1 entries, and only set the very last option to true. This is clearly a hack, but if you study the generated code, it seems to work. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d3/d82/page_exahype2_home.html">ExaHyPE 2</a></li><li class="navelem"><a class="el" href="../../d8/d60/page_exahype2_tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:58 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
