<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d3/da0/tutorials_swift2_planet_orbit.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Planet orbit</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This simple tutorial runs through the steps that we followed to create the <a class="el" href="../../d9/d7c/tests_swift2_planet_orbit.html">planet orbit test case</a>, which basically ensures that the AMR underlying Swift 2 works.</p>
<div class="image">
<img src="../../two-particles-00.png" alt=""/>
</div>
<h1><a class="anchor" id="autotoc_md657"></a>
High-level code structure</h1>
<p>We need Peano's core Python package, the Swift 2 package, and then we employ DaStGen 2 which is a tool that allows Peano to write plain C++ classes which hold our particle data, e.g. We will add additional attributes to this data set and hence use the DaStGen2 package.</p>
<h2><a class="anchor" id="autotoc_md658"></a>
Create project</h2>
<p>First of all, we have to create a project. The project is our wrapper of the whole SPH code (which is not really SPH but simply a simple Lagrangian model for an object subject to an ODE):</p>
<div class="fragment"><div class="line"><span class="lineno">  104</span>project = <a class="code hl_class" href="../../d4/dd4/classswift2_1_1Project_1_1Project.html">swift2.Project</a>(</div>
<div class="line"><span class="lineno">  105</span>    namespace=[<span class="stringliteral">&quot;tests&quot;</span>, <span class="stringliteral">&quot;swift2&quot;</span>, <span class="stringliteral">&quot;planetorbit&quot;</span>],</div>
<div class="line"><span class="lineno">  106</span>    project_name=<span class="stringliteral">&quot;planetorbit&quot;</span>,</div>
<div class="line"><span class="lineno">  107</span>    executable=<span class="stringliteral">&quot;orbit-&quot;</span> + str(args.cell_size),</div>
<div class="line"><span class="lineno">  108</span>)</div>
</div><!-- fragment --><p>This snippet stems from <a class="el" href="../../dc/d2f/planet-orbit_8py.html">tests/swift2/planet-orbit/planet-orbit.py</a>.</p>
<h2><a class="anchor" id="autotoc_md659"></a>
Configure the overall simulation</h2>
<p>Peano will need to know the value of some general properties. For more information, consult the documentation of <a class="el" href="../../d6/d70/namespaceswift2_1_1Project.html">swift2.Project</a> and also the remarks on build variants:</p>
<div class="fragment"><div class="line"><span class="lineno">  169</span><span class="keywordflow">if</span> args.asserts:</div>
<div class="line"><span class="lineno">  170</span>    build_mode = peano4.output.CompileMode.Asserts</div>
<div class="line"><span class="lineno">  171</span><span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  172</span>    build_mode = peano4.output.CompileMode.Release</div>
<div class="line"><span class="lineno">  173</span> </div>
<div class="line"><span class="lineno">  174</span>offset = [0, 0, 0]</div>
<div class="line"><span class="lineno">  175</span>domain_size = [1, 1, 1]</div>
<div class="line"><span class="lineno">  176</span>periodic_boundary_conditions = [<span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>]  <span class="comment"># Periodic BC</span></div>
<div class="line"><span class="lineno">  177</span> </div>
<div class="line"><span class="lineno">  178</span>project.set_global_simulation_parameters(</div>
<div class="line"><span class="lineno">  179</span>    dimensions=dimensions,</div>
<div class="line"><span class="lineno">  180</span>    offset=offset,</div>
<div class="line"><span class="lineno">  181</span>    domain_size=domain_size,</div>
<div class="line"><span class="lineno">  182</span>    min_end_time=args.end_time,</div>
<div class="line"><span class="lineno">  183</span>    max_end_time=0.0,</div>
<div class="line"><span class="lineno">  184</span>    first_plot_time_stamp=0.0,</div>
<div class="line"><span class="lineno">  185</span>    time_in_between_plots=args.plot_delta,</div>
<div class="line"><span class="lineno">  186</span>    periodic_BC=periodic_boundary_conditions,</div>
<div class="line"><span class="lineno">  187</span>    plotter_precision=8,  <span class="comment"># plotter precision</span></div>
<div class="line"><span class="lineno">  188</span>)</div>
<div class="line"><span class="lineno">  189</span> </div>
<div class="line"><span class="lineno">  190</span>project.set_Peano4_installation(args.peanodir, build_mode)</div>
</div><!-- fragment --><p>The call of swift2.Project.set_load_balancer() activates one of Peano's generic load balancing strategies. The last line is notably interesting: It instructs the Python API to parse the settings of your configure (autotools) or CMake run. That is, all the flags that you specified throughout your installation will automatically be picked up by the code that the Python script will ultimately produce.</p>
<h2><a class="anchor" id="autotoc_md660"></a>
Generate a genuine Peano project</h2>
<p>Once all is complete, we generate a Peano project and make it dump the C++ code:</p>
<div class="fragment"></div><!-- fragment --><p>After the project is generated, we add the compile constants required (see below) and then can dump it into the file system and either compile it in place through the Python script, or leave it to the user to type in make.</p>
<h1><a class="anchor" id="autotoc_md661"></a>
Particle implementation</h1>
<h2><a class="anchor" id="autotoc_md662"></a>
Instantiate particle (and select species)</h2>
<p>A particle in Swift is defined by its type which implicitly select its numerics. Once instantiated, we say the particle has a <em><b>species</b></em>. In this simple example, we don't really have an interaction radius, so we can take the simplest particle with a fixed interaction radius.</p>
<p>We need a leapfrog time integrator rather than an explicit Euler to maintain a stable radius. However, we can provide various different schemes and just swap them in an out.</p>
<p>Besides the time stepping scheme (which implicitly defines the steps any particle completes per time step), each particle guides the size of the underlying adaptive mesh. We therefore specify min_h and max_h.</p>
<div class="fragment"><div class="line"><span class="lineno">  124</span>    particle = <a class="code hl_class" href="../../d2/df7/classswift2_1_1particle_1_1LeapfrogFixedSearchRadius_1_1LeapfrogFixedSearchRadius.html">swift2.particle.LeapfrogFixedSearchRadius</a>(</div>
<div class="line"><span class="lineno">  125</span>        name=<span class="stringliteral">&quot;Planet&quot;</span>,</div>
<div class="line"><span class="lineno">  126</span>        cfl_factor=0.2,</div>
<div class="line"><span class="lineno">  127</span>        initial_time_step_size=args.timestep_size,</div>
<div class="line"><span class="lineno">  128</span>        particles_per_cell=0,</div>
<div class="line"><span class="lineno">  129</span>        min_h=args.cell_size,</div>
<div class="line"><span class="lineno">  130</span>        max_h=0.3,</div>
<div class="line"><span class="lineno">  131</span>    )</div>
<div class="line"><span class="lineno">  132</span>    particle_set = project.add_particle_species(particle)</div>
</div><!-- fragment --><p>As we set the interaction radius to zero later on, and as we set the particles_per_cell to zero, the code will run into a dilemma: There will always be one cell in the mesh which hosts one particle which violates the zero threshold. So the code will aggressively refine until the mesh is smaller than min_h. That stops the refinement no matter of the violated particles_pre_cell constraint.</p>
<h2><a class="anchor" id="autotoc_md663"></a>
Adding additional attributes</h2>
<p>So far, our particles are primitive. They will hold a position and a maximum search radius, as any particle within Peano's particle toolbox owns these properties. The integration of choice will add further attributes. In the present case, that's speed and acceleration. But other than that, the particle so far has no properties. We add a few ones:</p>
<div class="fragment"><div class="line"><span class="lineno">  159</span>energy_kin_attr = <a class="code hl_class" href="../../df/de4/classdastgen2_1_1attributes_1_1Double_1_1Double.html">dastgen2.attributes.Double</a>(<span class="stringliteral">&quot;energyKin&quot;</span>)</div>
<div class="line"><span class="lineno">  160</span>energy_pot_attr = <a class="code hl_class" href="../../df/de4/classdastgen2_1_1attributes_1_1Double_1_1Double.html">dastgen2.attributes.Double</a>(<span class="stringliteral">&quot;energyPot&quot;</span>)</div>
<div class="line"><span class="lineno">  161</span>energy_tot_attr = <a class="code hl_class" href="../../df/de4/classdastgen2_1_1attributes_1_1Double_1_1Double.html">dastgen2.attributes.Double</a>(<span class="stringliteral">&quot;energyTot&quot;</span>)</div>
<div class="line"><span class="lineno">  162</span>particle.data.add_attribute(energy_kin_attr)</div>
<div class="line"><span class="lineno">  163</span>particle.data.add_attribute(energy_pot_attr)</div>
<div class="line"><span class="lineno">  164</span>particle.data.add_attribute(energy_tot_attr)</div>
</div><!-- fragment --><p>The package <a class="el" href="../../d6/ddd/namespacedastgen2_1_1attributes.html">dastgen2.attributes</a> hosts also arrays of doubles and integers and booleans. Please note that there is an opportunity to specify accuracies (valid bits) for floating point values and upper and lower bounds for integers. Such additional information allows Peano in combination with our LLVM modifications to produce particularly memory-efficient code.</p>
<h2><a class="anchor" id="autotoc_md664"></a>
Injecting the physics</h2>
<p>We start with the definition of some constants.</p>
<div class="fragment"><div class="line"><span class="lineno">  195</span><span class="comment"># Orbital parameters</span></div>
<div class="line"><span class="lineno">  196</span>N_orbits = 8</div>
<div class="line"><span class="lineno">  197</span><span class="comment"># Number of orbits</span></div>
<div class="line"><span class="lineno">  198</span>G_NEWTON = 6.67384e-11</div>
<div class="line"><span class="lineno">  199</span><span class="comment"># Newton&#39;s constant  [m^3/kg/s^2]</span></div>
<div class="line"><span class="lineno">  200</span>M_SUN = 1.9885e30</div>
<div class="line"><span class="lineno">  201</span><span class="comment"># Sun mass [kg]</span></div>
<div class="line"><span class="lineno">  202</span>M_EARTH = 5.97219e24</div>
<div class="line"><span class="lineno">  203</span><span class="comment"># Earth mass [kg]</span></div>
<div class="line"><span class="lineno">  204</span>R_MAX = 152097701000.0</div>
<div class="line"><span class="lineno">  205</span><span class="comment"># [m]</span></div>
<div class="line"><span class="lineno">  206</span>R_MIN = 147098074000.0</div>
<div class="line"><span class="lineno">  207</span><span class="comment"># [m]</span></div>
<div class="line"><span class="lineno">  208</span>V_MAX = 30287.0</div>
<div class="line"><span class="lineno">  209</span><span class="comment"># [m/s]</span></div>
<div class="line"><span class="lineno">  210</span> </div>
<div class="line"><span class="lineno">  211</span><span class="comment"># Initial positions in internal units</span></div>
<div class="line"><span class="lineno">  212</span>LENGTH_UNIT = 4.0 * R_MAX</div>
<div class="line"><span class="lineno">  213</span>SUN_X_COORD = str(0.5)</div>
<div class="line"><span class="lineno">  214</span>SUN_Y_COORD = str(0.5)</div>
<div class="line"><span class="lineno">  215</span>EARTH_X_INI = str(float(SUN_X_COORD) + R_MAX / LENGTH_UNIT)</div>
<div class="line"><span class="lineno">  216</span>EARTH_Y_INI = SUN_Y_COORD</div>
<div class="line"><span class="lineno">  217</span> </div>
<div class="line"><span class="lineno">  218</span><span class="comment"># Derived quantities</span></div>
<div class="line"><span class="lineno">  219</span>e = (R_MAX - R_MIN) / (R_MAX + R_MIN)</div>
<div class="line"><span class="lineno">  220</span><span class="comment"># Eccentricity [dimensionless]</span></div>
<div class="line"><span class="lineno">  221</span>b = np.sqrt(R_MAX * R_MIN)</div>
<div class="line"><span class="lineno">  222</span><span class="comment"># Semi-minor axis [m]</span></div>
<div class="line"><span class="lineno">  223</span>p = b * np.sqrt(1.0 - e * e)</div>
<div class="line"><span class="lineno">  224</span><span class="comment"># Semi-lactus rectum [m]</span></div>
<div class="line"><span class="lineno">  225</span>a = p / (1.0 - e * e)</div>
<div class="line"><span class="lineno">  226</span><span class="comment"># Semi-major axis [m]</span></div>
<div class="line"><span class="lineno">  227</span>T = np.sqrt(4.0 * np.pi * np.pi * a * a * a / (G_NEWTON * (M_SUN + M_EARTH)))</div>
<div class="line"><span class="lineno">  228</span><span class="comment"># Period [s] */</span></div>
<div class="line"><span class="lineno">  229</span> </div>
<div class="line"><span class="lineno">  230</span><span class="comment"># Time-step size</span></div>
<div class="line"><span class="lineno">  231</span>dt = 1e-3 * T</div>
<div class="line"><span class="lineno">  232</span><span class="comment"># [s]</span></div>
<div class="line"><span class="lineno">  233</span>dt /= T</div>
<div class="line"><span class="lineno">  234</span>N = N_orbits / dt</div>
<div class="line"><span class="lineno">  235</span>GLOBAL_TIME_STEP_SIZE = str(dt)</div>
<div class="line"><span class="lineno">  236</span> </div>
<div class="line"><span class="lineno">  237</span><span class="comment"># Initial velocity in internal units</span></div>
<div class="line"><span class="lineno">  238</span>EARTH_V_INI_X = str(0.0)</div>
<div class="line"><span class="lineno">  239</span>EARTH_V_INI_Y = str(V_MAX / LENGTH_UNIT * T)</div>
</div><!-- fragment --><p>The actual export happens later:</p>
<div class="fragment"><div class="line"><span class="lineno">  480</span> </div>
<div class="line"><span class="lineno">  481</span><span class="comment"># Export symbols and values for compilation (e.g. for SPH kernel)</span></div>
<div class="line"><span class="lineno">  482</span><span class="comment"># Dummy values for non SPH</span></div>
<div class="line"><span class="lineno">  483</span>peano4_project.output.makefile.add_CXX_flag(<span class="stringliteral">&quot;-D&quot;</span> + <span class="stringliteral">&quot;HYDRO_DIMENSION=1&quot;</span>)</div>
<div class="line"><span class="lineno">  484</span>peano4_project.output.makefile.add_CXX_flag(<span class="stringliteral">&quot;-D&quot;</span> + <span class="stringliteral">&quot;HYDRO_GAMMA_5_3&quot;</span>)</div>
<div class="line"><span class="lineno">  485</span>peano4_project.output.makefile.add_CXX_flag(<span class="stringliteral">&quot;-D&quot;</span> + <span class="stringliteral">&quot;QUARTIC_SPLINE_KERNEL&quot;</span>)</div>
<div class="line"><span class="lineno">  486</span> </div>
<div class="line"><span class="lineno">  487</span>peano4_project.constants.export_const_with_type(</div>
<div class="line"><span class="lineno">  488</span>    <span class="stringliteral">&quot;GLOBAL_TIME_STEP_SIZE&quot;</span>, GLOBAL_TIME_STEP_SIZE, <span class="stringliteral">&quot;double&quot;</span></div>
<div class="line"><span class="lineno">  489</span>)</div>
<div class="line"><span class="lineno">  490</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;G_NEWTON&quot;</span>, str(G_NEWTON), <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  491</span>peano4_project.constants.export_const_with_type(</div>
<div class="line"><span class="lineno">  492</span>    <span class="stringliteral">&quot;LENGTH_UNIT&quot;</span>, str(LENGTH_UNIT), <span class="stringliteral">&quot;double&quot;</span></div>
<div class="line"><span class="lineno">  493</span>)</div>
<div class="line"><span class="lineno">  494</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;M_SUN&quot;</span>, str(M_SUN), <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  495</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;SUN_X_COORD&quot;</span>, SUN_X_COORD, <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  496</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;SUN_Y_COORD&quot;</span>, SUN_Y_COORD, <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  497</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;EARTH_X_INI&quot;</span>, EARTH_X_INI, <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  498</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;EARTH_Y_INI&quot;</span>, EARTH_Y_INI, <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  499</span>peano4_project.constants.export_const_with_type(</div>
<div class="line"><span class="lineno">  500</span>    <span class="stringliteral">&quot;EARTH_V_INI_X&quot;</span>, EARTH_V_INI_X, <span class="stringliteral">&quot;double&quot;</span></div>
<div class="line"><span class="lineno">  501</span>)</div>
<div class="line"><span class="lineno">  502</span>peano4_project.constants.export_const_with_type(</div>
<div class="line"><span class="lineno">  503</span>    <span class="stringliteral">&quot;EARTH_V_INI_Y&quot;</span>, EARTH_V_INI_Y, <span class="stringliteral">&quot;double&quot;</span></div>
<div class="line"><span class="lineno">  504</span>)</div>
<div class="line"><span class="lineno">  505</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;ECCENTRICITY&quot;</span>, str(e), <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  506</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;PERIOD&quot;</span>, str(T), <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  507</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;R_MIN&quot;</span>, str(R_MIN), <span class="stringliteral">&quot;double&quot;</span>)</div>
<div class="line"><span class="lineno">  508</span>peano4_project.constants.export_const_with_type(<span class="stringliteral">&quot;R_MAX&quot;</span>, str(R_MAX), <span class="stringliteral">&quot;double&quot;</span>)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md665"></a>
Add the forces</h2>
<p>To add the forces, we have attach a C/C++ code snippet to the particle. In our present case, the force is hard-coded, i.e. does not depend on other particles. It uses some constants that we have previously defined in the Python script. Here, we have now two options:</p>
<ul>
<li>We can take the C++ code snippet in Python and replace the constant strings in there via a Python format() call. The C++ code then will see the actual constants as hard-coded values.</li>
<li>We can use some constants like SUN_X_COORD in the C++ code and define these as proper constants in the generated C++ code.</li>
</ul>
<p>In the example below, we go down the second route. That means, the code as it stands will contain some constants like SUN_X_COORD. We have to ensure that these constants are properly exported into the Peano project. Both approaches (replacing literals before we dump the code snippet into the Python API and defining C++ constants) are fine and work. It is all a matter of taste.</p>
<div class="fragment"><div class="line"><span class="lineno">  244</span> </div>
<div class="line"><span class="lineno">  281</span>particle_force = <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  282</span><span class="stringliteral">// Template in tests/swift2/planet-orbit.py</span></div>
<div class="line"><span class="lineno">  283</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  284</span><span class="stringliteral">::swift2::kernels::forAllParticles(</span></div>
<div class="line"><span class="lineno">  285</span><span class="stringliteral">  marker,</span></div>
<div class="line"><span class="lineno">  286</span><span class="stringliteral">  localParticles,</span></div>
<div class="line"><span class="lineno">  287</span><span class="stringliteral">  numberOfCoalescedLocalParticlesPerVertex,</span></div>
<div class="line"><span class="lineno">  288</span><span class="stringliteral">  [=](</span></div>
<div class="line"><span class="lineno">  289</span><span class="stringliteral">    const peano4::datamanagement::CellMarker&amp; marker,</span></div>
<div class="line"><span class="lineno">  290</span><span class="stringliteral">    globaldata::Planet&amp;                       localParticle</span></div>
<div class="line"><span class="lineno">  291</span><span class="stringliteral">  ) -&gt; void {</span></div>
<div class="line"><span class="lineno">  292</span><span class="stringliteral">    if ( ::swift2::kernels::localParticleCanBeUpdatedInCellKernel(</span></div>
<div class="line"><span class="lineno">  293</span><span class="stringliteral">      marker,</span></div>
<div class="line"><span class="lineno">  294</span><span class="stringliteral">      localParticle</span></div>
<div class="line"><span class="lineno">  295</span><span class="stringliteral">    )) {</span></div>
<div class="line"><span class="lineno">  296</span><span class="stringliteral">      #if Dimensions==2</span></div>
<div class="line"><span class="lineno">  297</span><span class="stringliteral">      tarch::la::Vector&lt;Dimensions,double&gt; pos_sun = {SUN_X_COORD,SUN_Y_COORD};</span></div>
<div class="line"><span class="lineno">  298</span><span class="stringliteral">      #else</span></div>
<div class="line"><span class="lineno">  299</span><span class="stringliteral">      tarch::la::Vector&lt;Dimensions,double&gt; pos_sun = {SUN_X_COORD,SUN_Y_COORD,0.0};</span></div>
<div class="line"><span class="lineno">  300</span><span class="stringliteral">      #endif</span></div>
<div class="line"><span class="lineno">  301</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  302</span><span class="stringliteral">       /* G_NEWTON in internal units */</span></div>
<div class="line"><span class="lineno">  303</span><span class="stringliteral">      double const L3 = LENGTH_UNIT * LENGTH_UNIT * LENGTH_UNIT;</span></div>
<div class="line"><span class="lineno">  304</span><span class="stringliteral">      double const T2 = PERIOD * PERIOD;</span></div>
<div class="line"><span class="lineno">  305</span><span class="stringliteral">      double const GN = G_NEWTON * M_SUN * T2 / L3;</span></div>
<div class="line"><span class="lineno">  306</span><span class="stringliteral">      //double GN = 1.0;</span></div>
<div class="line"><span class="lineno">  307</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  308</span><span class="stringliteral">      tarch::la::Vector&lt;Dimensions,double&gt; earthSunDistance = localParticle.getX() - pos_sun;</span></div>
<div class="line"><span class="lineno">  309</span><span class="stringliteral">      const double r = tarch::la::norm2(earthSunDistance);</span></div>
<div class="line"><span class="lineno">  310</span><span class="stringliteral">      if (tarch::la::greater(r,0.0)) {</span></div>
<div class="line"><span class="lineno">  311</span><span class="stringliteral">        const double r_inv =  1.0 / r;</span></div>
<div class="line"><span class="lineno">  312</span><span class="stringliteral">        localParticle.setA( - GN * earthSunDistance * (r_inv * r_inv * r_inv) );</span></div>
<div class="line"><span class="lineno">  313</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  314</span><span class="stringliteral">        /* Update Energy */</span></div>
<div class="line"><span class="lineno">  315</span><span class="stringliteral">        const double vel = tarch::la::norm2( localParticle.getV() );</span></div>
<div class="line"><span class="lineno">  316</span><span class="stringliteral">        const double E_kin = 0.5 * vel * vel;</span></div>
<div class="line"><span class="lineno">  317</span><span class="stringliteral">        const double E_pot = - GN * r_inv;</span></div>
<div class="line"><span class="lineno">  318</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  319</span><span class="stringliteral">        /* Update total energy (overall minus sign) */</span></div>
<div class="line"><span class="lineno">  320</span><span class="stringliteral">        localParticle.setEnergyKin( E_kin );</span></div>
<div class="line"><span class="lineno">  321</span><span class="stringliteral">        localParticle.setEnergyPot(-E_pot );</span></div>
<div class="line"><span class="lineno">  322</span><span class="stringliteral">        localParticle.setEnergyTot( - ( E_kin + E_pot ) );</span></div>
<div class="line"><span class="lineno">  323</span><span class="stringliteral">      } // end of radius check</span></div>
<div class="line"><span class="lineno">  324</span><span class="stringliteral">    } // end of &quot;may I update&quot; check</span></div>
<div class="line"><span class="lineno">  325</span><span class="stringliteral">  }, // end of functor</span></div>
<div class="line"><span class="lineno">  326</span><span class="stringliteral">  ::swift2::kernels::alwaysUpdateInCellKernel&lt;globaldata::Planet&gt;</span></div>
<div class="line"><span class="lineno">  327</span><span class="stringliteral">);</span></div>
<div class="line"><span class="lineno">  328</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  329</span><span class="stringliteral">// end template</span></div>
<div class="line"><span class="lineno">  330</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  331</span> </div>
<div class="line"><span class="lineno">  332</span>particle.cell_kernel = particle_force</div>
</div><!-- fragment --><p>The code now is fully functional, but will not produced any output, as we haven't inserted any particle into our computational domain yet. Even if we do so, we will only see the particles and not their properties, as the code knows nothing about these properties. Please study the script benchmarks/swift2/planet-orbit/planet-orbit.py for more documentation how these two missing steps are to be realised.</p>
<p>If we had some proper n-body physics, we would use another iterator, i.e. one that runs through the particle pairs.</p>
<h2><a class="anchor" id="autotoc_md666"></a>
Set initial conditions</h2>
<div class="fragment"><div class="line"><span class="lineno">  337</span> </div>
<div class="line"><span class="lineno">  347</span>search_radius = args.cell_size / 100.0</div>
<div class="line"><span class="lineno">  348</span>initialisation_snippet = (</div>
<div class="line"><span class="lineno">  349</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  350</span><span class="stringliteral">  /*</span></div>
<div class="line"><span class="lineno">  351</span><span class="stringliteral">   * In this problem we will initialize just a single particle (Earth)</span></div>
<div class="line"><span class="lineno">  352</span><span class="stringliteral">   * This will orbit around a point where the hypothetical Sun is (no particle needed here)</span></div>
<div class="line"><span class="lineno">  353</span><span class="stringliteral">   */</span></div>
<div class="line"><span class="lineno">  354</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  355</span><span class="stringliteral">  /* Internal search radius used by Peano.</span></div>
<div class="line"><span class="lineno">  356</span><span class="stringliteral">   * Should always be larger than actual SPH interaction radius (~2h).</span></div>
<div class="line"><span class="lineno">  357</span><span class="stringliteral">   * But no really used here. */</span></div>
<div class="line"><span class="lineno">  358</span><span class="stringliteral">  particle-&gt;setSearchRadius(&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  359</span>    + str(search_radius)</div>
<div class="line"><span class="lineno">  360</span>    + <span class="stringliteral">&quot;&quot;&quot;);</span></div>
<div class="line"><span class="lineno">  361</span><span class="stringliteral">  particle-&gt;setV( {0, 0, 0} );</span></div>
<div class="line"><span class="lineno">  362</span><span class="stringliteral">  particle-&gt;setA( {0, 0, 0} );</span></div>
<div class="line"><span class="lineno">  363</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  364</span><span class="stringliteral">  // Orbiting particle: We can also have a free moving sun, but by default, this</span></div>
<div class="line"><span class="lineno">  365</span><span class="stringliteral">  // one rests and the earth is actually orbiting.</span></div>
<div class="line"><span class="lineno">  366</span><span class="stringliteral">  if( particle-&gt;getX(0) == EARTH_X_INI ){</span></div>
<div class="line"><span class="lineno">  367</span><span class="stringliteral">    particle-&gt;setV(0, EARTH_V_INI_X) ;</span></div>
<div class="line"><span class="lineno">  368</span><span class="stringliteral">    particle-&gt;setV(1, EARTH_V_INI_Y) ;</span></div>
<div class="line"><span class="lineno">  369</span><span class="stringliteral">  }</span></div>
<div class="line"><span class="lineno">  370</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  371</span><span class="stringliteral">  /*</span></div>
<div class="line"><span class="lineno">  372</span><span class="stringliteral">   * Set initial energy</span></div>
<div class="line"><span class="lineno">  373</span><span class="stringliteral">   */</span></div>
<div class="line"><span class="lineno">  374</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  375</span><span class="stringliteral">  /* G_NEWTON in internal units */</span></div>
<div class="line"><span class="lineno">  376</span><span class="stringliteral">  double const L3 = LENGTH_UNIT * LENGTH_UNIT * LENGTH_UNIT;</span></div>
<div class="line"><span class="lineno">  377</span><span class="stringliteral">  double const T2 = PERIOD * PERIOD;</span></div>
<div class="line"><span class="lineno">  378</span><span class="stringliteral">  double const GN = G_NEWTON * M_SUN * T2 / L3;</span></div>
<div class="line"><span class="lineno">  379</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  380</span><span class="stringliteral">  /* Sun-Earth initial distance */</span></div>
<div class="line"><span class="lineno">  381</span><span class="stringliteral">  const double r_ini = particle-&gt;getX()(0) - SUN_X_COORD;</span></div>
<div class="line"><span class="lineno">  382</span><span class="stringliteral">  const double r_inv = r_ini ? 1.0 / r_ini : 0.0;</span></div>
<div class="line"><span class="lineno">  383</span><span class="stringliteral">  const double vel = tarch::la::norm2( particle-&gt;getV() );</span></div>
<div class="line"><span class="lineno">  384</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  385</span><span class="stringliteral">  const double E_kin = 0.5 * vel * vel;</span></div>
<div class="line"><span class="lineno">  386</span><span class="stringliteral">  const double E_pot = - GN * r_inv;</span></div>
<div class="line"><span class="lineno">  387</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  388</span><span class="stringliteral">  particle-&gt;setEnergyKin( E_kin );</span></div>
<div class="line"><span class="lineno">  389</span><span class="stringliteral">  particle-&gt;setEnergyPot(-E_pot );</span></div>
<div class="line"><span class="lineno">  390</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  391</span><span class="stringliteral">  /* Overall minus sign for plotting */</span></div>
<div class="line"><span class="lineno">  392</span><span class="stringliteral">  particle-&gt;setEnergyTot( -( E_kin + E_pot ) );</span></div>
<div class="line"><span class="lineno">  393</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  394</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;=====================================&quot; );</span></div>
<div class="line"><span class="lineno">  395</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Initial energy:&quot;);</span></div>
<div class="line"><span class="lineno">  396</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Kinetic energy  :&quot; &lt;&lt; E_kin);</span></div>
<div class="line"><span class="lineno">  397</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Potential energy:&quot; &lt;&lt; E_pot);</span></div>
<div class="line"><span class="lineno">  398</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Total energy    :&quot; &lt;&lt; E_kin + E_pot);</span></div>
<div class="line"><span class="lineno">  399</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Search Radius   :&quot; &lt;&lt; particle-&gt;getSearchRadius() );</span></div>
<div class="line"><span class="lineno">  400</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;Initial velocity:&quot; &lt;&lt; particle-&gt;getV() );</span></div>
<div class="line"><span class="lineno">  401</span><span class="stringliteral">  logInfo( &quot;Init()&quot;, &quot;=====================================&quot; );</span></div>
<div class="line"><span class="lineno">  402</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  403</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  404</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  405</span>)</div>
<div class="line"><span class="lineno">  406</span> </div>
<div class="line"><span class="lineno">  407</span><span class="comment">#</span></div>
<div class="line"><span class="lineno">  408</span><span class="comment"># Insert Earth into system</span></div>
<div class="line"><span class="lineno">  409</span><span class="comment">#</span></div>
<div class="line"><span class="lineno">  410</span>project.algorithm_step_initial_conditions.add_action_set(</div>
<div class="line"><span class="lineno">  411</span>    <a class="code hl_class" href="../../dc/d56/classswift2_1_1input_1_1InsertParticlesByCoordinates_1_1InsertParticlesByCoordinates.html">swift2.input.InsertParticlesByCoordinates</a>(</div>
<div class="line"><span class="lineno">  412</span>        particle_set=particle_set,</div>
<div class="line"><span class="lineno">  413</span>        initialisation_call=initialisation_snippet,</div>
<div class="line"><span class="lineno">  414</span>        coordinates=[(EARTH_X_INI, EARTH_Y_INI, 0)],</div>
<div class="line"><span class="lineno">  415</span>    )</div>
<div class="line"><span class="lineno">  416</span>)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md667"></a>
Plot</h2>
<div class="fragment"><div class="line"><span class="lineno">  421</span> </div>
<div class="line"><span class="lineno">  444</span>particle_plotter = <a class="code hl_class" href="../../de/d96/classpeano4_1_1toolbox_1_1particles_1_1PlotParticlesInVTKFormat_1_1PlotParticlesInVTKFormat.html">peano4.toolbox.particles.PlotParticlesInVTKFormat</a>(</div>
<div class="line"><span class="lineno">  445</span>    <span class="stringliteral">&quot;particles&quot;</span>,</div>
<div class="line"><span class="lineno">  446</span>    particle_set,</div>
<div class="line"><span class="lineno">  447</span>    <span class="stringliteral">&quot;globaldata::{}::getSpecies().getMinTimeStamp()&quot;</span>.format(particle.name),</div>
<div class="line"><span class="lineno">  448</span>)</div>
<div class="line"><span class="lineno">  449</span>particle_plotter.add_attribute_to_plot(particle.velocity, dimensions)</div>
<div class="line"><span class="lineno">  450</span>particle_plotter.add_attribute_to_plot(energy_kin_attr, 1)</div>
<div class="line"><span class="lineno">  451</span>particle_plotter.add_attribute_to_plot(energy_pot_attr, 1)</div>
<div class="line"><span class="lineno">  452</span>particle_plotter.add_attribute_to_plot(energy_tot_attr, 1)</div>
<div class="line"><span class="lineno">  453</span>project.algorithm_step_plot.add_action_set(particle_plotter)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md668"></a>
A better code structure</h1>
<p>The code above is fully functional. One however might argue that the mixture of Python code and string-based C++ code is not particularly nice, hardly reusable and difficult to debug: You have to generate the code, compile, parse the error and then reconstruct where in the Python script it comes from. It hence would be nicer to define the Physics in a header/implementation file of its own. Once we have a Peano project in Python, we can add further C++ files to its make file. That is, we can implement the Physics independently and then add these files to the project manually. This way, we work with Python in the Python scripts and with C++ only in proper C++ classes.</p>
<h1><a class="anchor" id="autotoc_md669"></a>
In-situ analysis features to implement automatic testing/constraints</h1>
<p>In-situ analysis of simulations is very important for many sophisticated experiments. Swift 2 offers various ways to realise such on-the-fly data analysis. We do not really use such an analysis here, but we use the in-situ plug-in points to phrase our one fundamental constraint in this example: The particle should not disappear! So we basically assess that the orbit is stable (and that there are no bugs).</p>
<p>The elegant way to realise in-situ checks is to plug into one of the particle steps. In the example below, we take the particle's final reduction step and check, once this one is completed, if our global constraints are still fulfilled:</p>
<div class="fragment"><div class="line"><span class="lineno">  458</span>particle.add_to_reduction(</div>
<div class="line"><span class="lineno">  459</span>    f<span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  460</span><span class="stringliteral">nonCriticalAssertion( vertexdata::{particle.name}Set::getNumberOfRemainingLocalParticles() == 1 );</span></div>
<div class="line"><span class="lineno">  461</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  462</span>)</div>
</div><!-- fragment --><p>Following the discussion above, it would be more elegant to derive from the baseline class and then to add these steps. We don't work with a subclass here. "Fortunately", the Euler and leap frog solver here both provide a routine (property setter) to append additional source code to the final reduction.</p>
<p>Particles are associated to vertices, and the sets of particles (tied to vertices) are organised through instances of <a class="el" href="../../d5/ddd/classtoolbox_1_1particles_1_1ParticleSet.html" title="Abstract base class for all flavours of particle sets.">toolbox.particles.ParticleSet</a> and subclasses thereof. This class allows us to query how many local particles we have. As we plug into the wrap-up phase of the global reduction, we know that this quantity is valid at this point. If we worked with MPI, we should guard this check such that it is only performed on the global master.</p>
<p>Technically, we realise the validation with a non-critical assertion. This is <a class="el" href="../../d1/d9e/tarch_logging.html">a special type of an assertion</a>: If violated, it does <em><b>not</b></em> stop the simulation immediately. Instead, it allows the code to finish the current time step, then asks it to dump the result, and eventually quits the code. For many logical errors, this is better, as we get a snapshot of the last system state. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d6/dba/page_swift2_home.html">Swift 2</a></li><li class="navelem"><a class="el" href="../../d1/dad/swift_tutorials.html">Tutorials</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:00 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
