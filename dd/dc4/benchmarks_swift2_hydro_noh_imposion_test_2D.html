<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/dc4/benchmarks_swift2_hydro_noh_imposion_test_2D.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">2D Noh implosion test</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Simple Noh implosion test benchmark in 2D with \( N ^d \) particles. The setup yields snapshots similar to the ones below.</p>
<div class="image">
<img src="../../noh_0.png" alt=""/>
</div>
 <div class="image">
<img src="../../noh_150.png" alt=""/>
</div>
 <div class="image">
<img src="../../noh_300.png" alt=""/>
</div>
<p>As with all Swift 2 experiments, you have to ensure that you translate with </p><div class="fragment"><div class="line">--enable-particles --enable-swift</div>
</div><!-- fragment --><p> before you start working with the scripts. Furthermore, the Python path has to be set properly:</p>
<div class="fragment"><div class="line"><span class="keyword">export</span> PYTHONPATH=~/../../../../python</div>
</div><!-- fragment --><p>The benchmark suite is designed to study three different things:</p>
<ol type="1">
<li>The impact of the mesh concept on the computational cost, i.e. to which degree does the mesh introduce overhead or manage to reduce the computational complexity.</li>
<li>The impact of different memory layouts on the time to solution.</li>
<li>The efficacy and efficiency of the vectorisation over selected kernels.</li>
</ol>
<p>Obviously, these three properties are tightly interconnected.</p>
<h1><a class="anchor" id="autotoc_md718"></a>
Clean-up data</h1>
<p>No matter which setup you run: Once you have created your executables, you might want to get rid of all the generated glue code that sits in your directory. To clean up all generated data, type in</p>
<div class="fragment"><div class="line">rm *patch-file *.vtu *.pvd</div>
<div class="line">rm vertexdata celldata globaldata repositories observers</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md719"></a>
Validate correctness</h1>
<p>I've written a variant of the code which automatically checks if particles get losted.</p>
<div class="fragment"><div class="line"><span class="keyword">export</span> PYTHONPATH=$PYTHONPATH:../../../../python</div>
<div class="line">TIMESTEP_SIZE=0.0001</div>
<div class="line">PLOT_DELTA=0.0</div>
<div class="line"><a class="code hl_define" href="../../dd/d92/setup__big_8h.html#a20d957deb8664b329350579517d9821e">N_PART</a>=100</div>
<div class="line"><a class="code hl_define" href="../../dd/d92/setup__big_8h.html#a20d957deb8664b329350579517d9821e">N_PART</a>=10</div>
<div class="line">END_TIME=0.01</div>
<div class="line">PLOT_DELTA=0.0</div>
<div class="line">REALISATION=domain-decomposition.scattered.bucket-sort.no-optimisation</div>
<div class="line">python3 <a class="code hl_namespace" href="../../d3/d2a/namespacenoh.html">noh</a>.py -dt $TIMESTEP_SIZE -et $END_TIME -np $N_PART -<a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a> $PLOT_DELTA -rea $REALISATION -v -<a class="code hl_variable" href="../../db/dba/hydro_8h.html#ac51334f57ef8b81c0629c9421798c344">m</a> release -o noh2D.$REALISATION-asserts; cp repositories/ModifiedGlobalState.cpp repositories/GlobalState.cpp; clear; make</div>
<div class="ttc" id="ahydro_8h_html_ac51334f57ef8b81c0629c9421798c344"><div class="ttname"><a href="../../db/dba/hydro_8h.html#ac51334f57ef8b81c0629c9421798c344">m</a></div><div class="ttdeci">float m</div><div class="ttdef"><b>Definition</b> <a href="../../db/dba/hydro_8h_source.html#l00257">hydro.h:257</a></div></div>
<div class="ttc" id="anamespacenoh_html"><div class="ttname"><a href="../../d3/d2a/namespacenoh.html">noh</a></div><div class="ttdef"><b>Definition</b> <a href="../../dc/daf/benchmarks_2swift2_2hydro_2noh-implosion-test-2D_2noh_8py_source.html#l00001">noh.py:1</a></div></div>
<div class="ttc" id="anamespaceplot_html"><div class="ttname"><a href="../../de/d73/namespaceplot.html">plot</a></div><div class="ttdoc">-lift-drop-statistics</div></div>
<div class="ttc" id="asetup__big_8h_html_a20d957deb8664b329350579517d9821e"><div class="ttname"><a href="../../dd/d92/setup__big_8h.html#a20d957deb8664b329350579517d9821e">N_PART</a></div><div class="ttdeci">#define N_PART</div><div class="ttdef"><b>Definition</b> <a href="../../dd/d92/setup__big_8h_source.html#l00005">setup_big.h:5</a></div></div>
</div><!-- fragment --><p>Setups like this build a standard executable with assertions (or release). After that one is built, they swap in a slightly altered GlobalState.cpp file which is usually overwritten after each Python rerun, i.e. solely generated. This tweaked state tracks the number of particles after the first time step and then ensures in each subsequent time step that the number of particles is preserved. Otherwise it quits (also in release mode) and dumps some relevant particle history information.</p>
<h1><a class="anchor" id="autotoc_md720"></a>
Impact of memory layouts and sorting</h1>
<p>The impact of the various memory layouts and the sorting variations have to be assessed using a representative and reasonably large setup. Furthermore, it might make sense to restrict the studies to one NUMA node only on a production-level chip. The rationale here is that most codes would deploy one MPI rank per NUMA domain to avoid NUMA effects/penalties.</p>
<p>Before we start, we have to build the executables (build-memory-layout.sh):</p>
<div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line"> </div>
<div class="line">export PYTHONPATH=$PYTHONPATH:../../../../python</div>
<div class="line"> </div>
<div class="line"># Script to run experiment (Noh 2D)</div>
<div class="line"> </div>
<div class="line"># Parameters</div>
<div class="line">TIMESTEP_SIZE=0.0001</div>
<div class="line">#N_PART=2000</div>
<div class="line">PLOT_DELTA=0.0</div>
<div class="line"> </div>
<div class="line">rm noh2D.*</div>
<div class="line">rm profile-noh2D.*</div>
<div class="line">rm README-*.md</div>
<div class="line"> </div>
<div class="line">set -e</div>
<div class="line"> </div>
<div class="line">for REALISATION in domain-decomposition.scattered.bucket-sort.no-optimisation domain-decomposition.continuous-per-vertex.bucket-sort.no-optimisation domain-decomposition.continuous-per-vertex.bucket-sort.vectorise-distance-checks-preamble domain-decomposition.continuous-per-vertex.bucket-sort.vectorise-all</div>
<div class="line">do</div>
<div class="line">  echo build $REALISATION</div>
<div class="line">  N_PART=5000</div>
<div class="line">  PLOT_DELTA=0.0</div>
<div class="line">  END_TIME=0.1</div>
<div class="line">  python3 noh.py -dt $TIMESTEP_SIZE -et $END_TIME -np $N_PART -plot $PLOT_DELTA -rea $REALISATION -v -m release -o noh2D.$REALISATION</div>
<div class="line"> </div>
<div class="line">  echo build $REALISATION</div>
<div class="line">  N_PART=2000</div>
<div class="line">  PLOT_DELTA=0.0</div>
<div class="line">  END_TIME=0.0005</div>
<div class="line">  python3 noh.py -dt $TIMESTEP_SIZE -et $END_TIME -np $N_PART -plot $PLOT_DELTA -rea $REALISATION -v -m release -o profile-noh2D.$REALISATION</div>
<div class="line"> </div>
<div class="line">  # N_PART=120</div>
<div class="line">  # PLOT_DELTA=0.001</div>
<div class="line">  # python3 noh.py -dt $TIMESTEP_SIZE -et $END_TIME -np $N_PART -plot $PLOT_DELTA -rea $REALISATION -v -m release -o noh2D.$REALISATION-test</div>
<div class="line">  # #</div>
<div class="line">  # # See remarks on correctness checks in README.dox in the section &quot;Validate correctness&quot;</div>
<div class="line">  # #</div>
<div class="line">  # cp repositories/ModifiedGlobalState.cpp repositories/GlobalState.cpp; make -j</div>
<div class="line"> </div>
<div class="line">done</div>
<div class="line"> </div>
</div><!-- fragment --><p>Once all the executables are there, we set the number of available cores (for OpenMP, setting OMP_NUM_THREADS=xxx does the job) and submit tests via</p>
<div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line"> </div>
<div class="line">#</div>
<div class="line"># Ensure that script terminates if one run fails</div>
<div class="line">#</div>
<div class="line">set -e </div>
<div class="line"> </div>
<div class="line">for REALISATION in domain-decomposition.scattered.bucket-sort.no-optimisation domain-decomposition.scattered.bucket-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.scattered.multiscale-sort.no-optimisation domain-decomposition.scattered.multiscale-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.continuous-per-vertex.bucket-sort.no-optimisation domain-decomposition.continuous-per-vertex.bucket-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.continuous-per-vertex.bucket-sort.vectorise-all domain-decomposition.continuous-per-vertex.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   domain-decomposition.continuous-per-vertex.multiscale-sort.no-optimisation domain-decomposition.continuous-per-vertex.multiscale-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.continuous-per-vertex.multiscale-sort.vectorise-all domain-decomposition.continuous-per-vertex.multiscale-sort.vectorise-distance-checks \</div>
<div class="line">                   domain-decomposition.global-continuous.bucket-sort.no-optimisation domain-decomposition.global-continuous.bucket-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.global-continuous.bucket-sort.vectorise-all domain-decomposition.global-continuous.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   domain-decomposition.global-continuous.multiscale-sort.no-optimisation domain-decomposition.global-continuous.multiscale-sort.outer-guards \</div>
<div class="line">                   domain-decomposition.global-continuous.multiscale-sort.vectorise-all domain-decomposition.global-continuous.multiscale-sort.vectorise-distance-checks \</div>
<div class="line">                   task-tree.scattered.bucket-sort.no-optimisation task-tree.scattered.bucket-sort.outer-guards \</div>
<div class="line">                   task-tree.scattered.multiscale-sort.no-optimisation task-tree.scattered.multiscale-sort.outer-guards \</div>
<div class="line">                   task-tree.continuous-per-vertex.bucket-sort.no-optimisation task-tree.continuous-per-vertex.bucket-sort.outer-guards \</div>
<div class="line">                   task-tree.continuous-per-vertex.bucket-sort.vectorise-all task-tree.continuous-per-vertex.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   task-tree.continuous-per-vertex.multiscale-sort.no-optimisation task-tree.continuous-per-vertex.multiscale-sort.outer-guards \</div>
<div class="line">                   task-tree.continuous-per-vertex.multiscale-sort.vectorise-all task-tree.continuous-per-vertex.multiscale-sort.vectorise-distance-checks \</div>
<div class="line">                   task-tree.global-continuous.bucket-sort.no-optimisation task-tree.global-continuous.bucket-sort.outer-guards \</div>
<div class="line">                   task-tree.global-continuous.bucket-sort.vectorise-all task-tree.global-continuous.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   task-tree.global-continuous.multiscale-sort.no-optimisation task-tree.global-continuous.multiscale-sort.outer-guards \</div>
<div class="line">                   task-tree.global-continuous.multiscale-sort.vectorise-all task-tree.global-continuous.multiscale-sort.vectorise-distance-checks \</div>
<div class="line">                   task-graph.scattered.bucket-sort.no-optimisation task-graph.scattered.bucket-sort.outer-guards \</div>
<div class="line">                   task-graph.scattered.multiscale-sort.no-optimisation task-graph.scattered.multiscale-sort.outer-guards \</div>
<div class="line">                   task-graph.continuous-per-vertex.bucket-sort.no-optimisation task-graph.continuous-per-vertex.bucket-sort.outer-guards \</div>
<div class="line">                   task-graph.continuous-per-vertex.bucket-sort.vectorise-all task-graph.continuous-per-vertex.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   task-graph.continuous-per-vertex.multiscale-sort.no-optimisation task-graph.continuous-per-vertex.multiscale-sort.outer-guards \</div>
<div class="line">                   task-graph.continuous-per-vertex.multiscale-sort.vectorise-all task-graph.continuous-per-vertex.multiscale-sort.vectorise-distance-checks \</div>
<div class="line">                   task-graph.global-continuous.bucket-sort.no-optimisation task-graph.global-continuous.bucket-sort.outer-guards \</div>
<div class="line">                   task-graph.global-continuous.bucket-sort.vectorise-all task-graph.global-continuous.bucket-sort.vectorise-distance-checks \</div>
<div class="line">                   task-graph.global-continuous.multiscale-sort.no-optimisation task-graph.global-continuous.multiscale-sort.outer-guards \</div>
<div class="line">                   task-graph.global-continuous.multiscale-sort.vectorise-all task-graph.global-continuous.multiscale-sort.vectorise-distance-checks</div>
<div class="line">do</div>
<div class="line">  EXECUTABLE=noh2D.$REALISATION</div>
<div class="line">  echo $EXECUTABLE</div>
<div class="line">  ./$EXECUTABLE &gt; $EXECUTABLE&quot;-&quot;$OMP_NUM_THREADS&quot;-threads.out&quot;</div>
<div class="line">done</div>
<div class="line"> </div>
</div><!-- fragment --><p>After completion, we zip the outcome via</p>
<div class="fragment"><div class="line">tar -czvf MyMachine-$OMP_NUM_THREADS-threads.tar.gz *.out</div>
</div><!-- fragment --><p>The zipped outcome can be visualised by a call similar to</p>
<div class="fragment"><div class="line">python3 <a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>-comparison-of-implementation-variants.py -o MyMachine MyMachine-8-threads.tar.gz MyMachine-16-threads.tar.gz ...</div>
</div><!-- fragment --><div class="image">
<img src="../../Hamilton8-2400.png" alt=""/>
</div>
<p>On SuperMUC, we see some irregularities for the biggest setups. Therefore, it makes sense to exclude them from some visualisation:</p>
<div class="fragment"><div class="line">python3 <a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>-comparison-of-implementation-variants.py -o SuperMUC   SuperMUC-112-threads.tar.gz  SuperMUC-56-threads.tar.gz SuperMUC-28-threads.tar.gz SuperMUC-14-threads.tar.gz</div>
<div class="line">python3 <a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a>-comparison-of-implementation-variants.py -o SuperMUC-small                          SuperMUC-56-threads.tar.gz SuperMUC-28-threads.tar.gz SuperMUC-14-threads.tar.gz</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md721"></a>
The impact of the mesh on the global runtime</h1>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000057">Todo</a></b></dt><dd>This is all to be rewritten</dd></dl>
<p>The present setup does work with constant cut-off radii. That is, once the particles are created, they do not change their interaction range. This is not what you will find in a lot of "realistic" SPH simulations, where the cut-off radius adopts to the particle distribution in space. However, it is reasonable to eliminate this dimension of complexity to assess the algortihmic impact of the cut-off.</p>
<p>To start a proper discussion of the latter, we first have to understand the cost relative to the particle count without any mesh. Unfortunately, Peano cannot work all without a mesh. We can however make the mesh comprise only 3x3 cells (see snapshots above). The script shipped with the present code does not allow us to set the mesh directly, but we can specify the number of particles per cell that we want to obain. This is, we can control the mesh resolution indirectly.</p>
<p>The beauty of these experiments is the physical accuracy: We may never pick a cut-off that is smaller than the interaction radius that the physics yield. By essentially removing the cut-off globally, we implicitly always pick a cut-off that's bigger than the physical interaction radius. It is automatically valid all the time.</p>
<h2><a class="anchor" id="autotoc_md722"></a>
Create benchmark executables</h2>
<p>Here are some classic setups that I use for benchmarking:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">np   </th><th class="markdownTableHeadNone">end time   </th><th class="markdownTableHeadNone">ppc   </th><th class="markdownTableHeadNone">mesh size    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">100   </td><td class="markdownTableBodyNone">1e-1   </td><td class="markdownTableBodyNone">100   </td><td class="markdownTableBodyNone">*    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">100   </td><td class="markdownTableBodyNone">1e-1   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">9x9 (81)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">1e-1   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">27x27 (729)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">1e-1   </td><td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">9x9 (81)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">400   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">*    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">400   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">27x27 (729)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">400   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">2000   </td><td class="markdownTableBodyNone">9x9 (81)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">81x81 (6,561) x    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">1200   </td><td class="markdownTableBodyNone">27x27 (729)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">1e-2   </td><td class="markdownTableBodyNone">8000   </td><td class="markdownTableBodyNone">9x9 (81)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1200   </td><td class="markdownTableBodyNone">1e-3   </td><td class="markdownTableBodyNone">800   </td><td class="markdownTableBodyNone">81x81 (6,561)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1200   </td><td class="markdownTableBodyNone">1e-3   </td><td class="markdownTableBodyNone">12000   </td><td class="markdownTableBodyNone">27x27 (729)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1200   </td><td class="markdownTableBodyNone">1e-3   </td><td class="markdownTableBodyNone">24000   </td><td class="markdownTableBodyNone">9x9 (81)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2400   </td><td class="markdownTableBodyNone">5e-4   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">243x243 (59,049)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2400   </td><td class="markdownTableBodyNone">5e-4   </td><td class="markdownTableBodyNone">1200   </td><td class="markdownTableBodyNone">81x81 (6,561)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2400   </td><td class="markdownTableBodyNone">5e-4   </td><td class="markdownTableBodyNone">8000   </td><td class="markdownTableBodyNone">27x27 (729)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2400   </td><td class="markdownTableBodyNone">5e-4   </td><td class="markdownTableBodyNone">84000   </td><td class="markdownTableBodyNone">9x9 (81)   </td></tr>
</table>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000058">Todo</a></b></dt><dd>We have to extend this list</dd></dl>
<p>These values are just popular ones we use for benchmarking. The setups marked with * use a way too fine mesh and therefore cannot capture the physical interaction radius. They yield physical nonsense. The ones marked with an x run into this situation too after a few time steps. So you can use them for benchmarking (to make statements on the algorithmic efficiency), but they should not be used for proper benchmarks making validity claims on the outcome.</p>
<p>To find out how the correlation of np and ppc affects the mesh construction, you can either go down the trial and error route, or you can study the generated README-noh2D.md file, which enlists exactly which particle properties are set and how they will affect the coarsest mesh size.</p>
<h2><a class="anchor" id="autotoc_md723"></a>
MPI</h2>
<p>The MPI parallelisation is based upon the mesh, i.e. you cannot exploit more than 9 ranks if your mesh is only 9 cells large. At the same time, any imbalance on the MPI level will directly propagate through to the runtime. That is, if you use a 81 cell mesh with 4 ranks, you will have three ranks hosting 20 cells, but the fourth rank will host 21 and the setup hence will be imbalanced right from the start.</p>
<h1><a class="anchor" id="autotoc_md724"></a>
Old docu</h1>
<h2><a class="anchor" id="autotoc_md725"></a>
Experimental setup</h2>
<p>We allow the user to specify the number of particles per axis via the Python argument &ndash;particle-number (or -np). We aim for roughly 20 particles per cell, which is physically unreasonable, but we can do so for this test, which means that it is reasonable to start with a mesh size of roughly \( \frac{1}{np} \cdot 20 \sqrt[-1]{d} \).</p>
<p>Below is a rough guideline (overview) of particle per axis and outcome for 2d experiments:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">np   </th><th class="markdownTableHeadNone">initial mesh cells   </th><th class="markdownTableHeadNone">mesh cells after insertion    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">10   </td><td class="markdownTableBodyNone">9 (3x3)   </td><td class="markdownTableBodyNone">81 (9x9)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">20   </td><td class="markdownTableBodyNone">9 (3x3)   </td><td class="markdownTableBodyNone">81 (9x9)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">40   </td><td class="markdownTableBodyNone">9 (3x3)   </td><td class="markdownTableBodyNone">81 (9x9)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">80   </td><td class="markdownTableBodyNone">81 (9x9)   </td><td class="markdownTableBodyNone">729 (27x27)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">160   </td><td class="markdownTableBodyNone">729 (27x27)   </td><td class="markdownTableBodyNone">6,561 (81x81)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">320   </td><td class="markdownTableBodyNone">729 (27x27)   </td><td class="markdownTableBodyNone">6,561 (81x81)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">640   </td><td class="markdownTableBodyNone">6,561 (81x81)   </td><td class="markdownTableBodyNone">59,049   </td></tr>
</table>
<p>As always, the important detail is to study all artifacts that our Python API produces. Per executable, you will obtain a README-my-exec.md file which details your settings, provides</p>
<h2><a class="anchor" id="autotoc_md726"></a>
Benchmark different configurations</h2>
<p>For benchmarking, I typically pick rather short runtimes and disable the plots. </p><div class="fragment"><div class="line">python3 <a class="code hl_namespace" href="../../d3/d2a/namespacenoh.html">noh</a>.py -np 320 -<a class="code hl_namespace" href="../../de/d73/namespaceplot.html">plot</a> 0 -et 0.001</div>
</div><!-- fragment --><p>We can pick certain mantisssa sizes via the ms argument. Please note that the code sets all variables besides the position to the chosen accuracy. For real real-world setups, you probably want to pick different mantissa accuracies per attribute.</p>
<h2><a class="anchor" id="autotoc_md727"></a>
Vectorisation studies</h2>
<p>The Noh benchmark is one of our classic test cases to study vectorisation of the kernels. Our first subject of study is the function swift2::kernels::forceKernelVectorised() which is a nice function to see what has to be done to get good SIMD efficiency, but it makes sense to study more than this simple single kernel. Before we tweak this function, I recommend to re-translate with the Intel compiler, and to include "-O3 -xHost" in the code. Alternatively, you might want to use "-Ofast -march=native". After that, I typically add one more flag to the setup: "-qopt-report=3".</p>
<p>These instructions follow <a class="el" href="../../d2/daf/swift_particle_new_solver.html">Swift's generic recommendations</a> when it comes to the development of vectorised solvers. You might want to add the optimisation report to all of Peano, but then you'll get a mass of optimisation reports which are difficult to digest. Therefore, I often only add this flag to the actual project's Makefile. However, any Python script rerun will overwrite the Makefile. Therefore, it is important to make backups.</p>
<h3><a class="anchor" id="autotoc_md728"></a>
Code changes</h3>
<p>All the changes that are required within the Python script to switch to a particular optimisation are all encoded via the script argument optimisation. Run the Python script with &ndash;help to get an overview, and search the script for args.optimisation for details. The steps are rather simple:</p>
<ol type="1">
<li>If the optimisation is enabled, we first need another graph compiler. We use <div class="fragment"><div class="line"><span class="keywordflow">if</span> args.optimisation != <span class="stringliteral">&quot;none&quot;</span>:</div>
<div class="line">  project.algorithm_steps_task_graph_compiler      = <a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>.graphcompiler.map_particle_steps_onto_separate_mesh_traversals_insert_dummy_sweeps_and_vectorise</div>
<div class="ttc" id="anamespaceswift2_html"><div class="ttname"><a href="../../de/dac/namespaceswift2.html">swift2</a></div><div class="ttdoc">This file is part of the SWIFT 2 project.</div><div class="ttdef"><b>Definition</b> <a href="../../da/d65/FixedBoundary_8h_source.html#l00008">FixedBoundary.h:8</a></div></div>
</div><!-- fragment --> here, which might not be the best compiler but does the job.</li>
<li>Next, we have to switch to a coalesced memory access. This is not required if we only study the impact of the memory re-arrangement: <div class="fragment"><div class="line"> particle = <a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>.<a class="code hl_namespace" href="../../d2/d41/namespaceswift2_1_1particle.html">particle</a>.<a class="code hl_namespace" href="../../d3/d4b/namespaceswift2_1_1particle_1_1SPHLeapfrogFixedSearchRadius.html">SPHLeapfrogFixedSearchRadius</a>(</div>
<div class="line">    name=name,</div>
<div class="line">    dimensions_hydro=hydro_dimensions,</div>
<div class="line">    cfl_factor=args.cfl_factor,</div>
<div class="line">    initial_time_step_size=args.timestep_size,</div>
<div class="line">    constant_time_step_size=True,</div>
<div class="line">    swift_project_namespace=project_namespace,</div>
<div class="line">    particles_per_cell=particles_per_cell,</div>
<div class="line">    min_h=max_cell_size,</div>
<div class="line">    max_h=max_cell_size,</div>
<div class="line">    use_optimised_coalesced_memory_access_kernels = args.optimisation == <span class="stringliteral">&quot;vectorise-per-vertex&quot;</span></div>
<div class="line">)</div>
<div class="ttc" id="anamespaceswift2_1_1particle_1_1SPHLeapfrogFixedSearchRadius_html"><div class="ttname"><a href="../../d3/d4b/namespaceswift2_1_1particle_1_1SPHLeapfrogFixedSearchRadius.html">swift2.particle.SPHLeapfrogFixedSearchRadius</a></div><div class="ttdef"><b>Definition</b> <a href="../../d6/d2e/SPHLeapfrogFixedSearchRadius_8py_source.html#l00001">SPHLeapfrogFixedSearchRadius.py:1</a></div></div>
<div class="ttc" id="anamespaceswift2_1_1particle_html"><div class="ttname"><a href="../../d2/d41/namespaceswift2_1_1particle.html">swift2.particle</a></div><div class="ttdoc">This file is part of the SWIFT 2 project.</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d00/python_2swift2_2particle_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
</div><!-- fragment --></li>
<li>Finally, we alter the actual administration of the particle sets: <div class="fragment"><div class="line">particle_set = project.add_particle_species(particle)</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span>  args.optimisation == <span class="stringliteral">&quot;continuous-per-vertex&quot;</span> or args.optimisation == <span class="stringliteral">&quot;vectorise-per-vertex&quot;</span>:</div>
<div class="line">    particle_set.generator = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d5/d91/namespacepeano4_1_1toolbox.html">toolbox</a>.<a class="code hl_namespace" href="../../d1/d65/namespacepeano4_1_1toolbox_1_1particles.html">particles</a>.ParticleSetGenerator_ContinuousPerVertex(particle_set)</div>
<div class="line"><span class="keywordflow">else</span>:</div>
<div class="line">    particle_set.generator = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d5/d91/namespacepeano4_1_1toolbox.html">toolbox</a>.<a class="code hl_namespace" href="../../d1/d65/namespacepeano4_1_1toolbox_1_1particles.html">particles</a>.ParticleSetGenerator_ScatteredOnHeap_IndexByList(particle_set)</div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_1_1particles_html"><div class="ttname"><a href="../../d1/d65/namespacepeano4_1_1toolbox_1_1particles.html">peano4.toolbox.particles</a></div><div class="ttdef"><b>Definition</b> <a href="../../d3/d04/python_2peano4_2toolbox_2particles_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_html"><div class="ttname"><a href="../../d5/d91/namespacepeano4_1_1toolbox.html">peano4.toolbox</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/db6/python_2peano4_2toolbox_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="autotoc_md729"></a>
Insights</h3>
<ul>
<li>The kernel <em><b>swift2::kernels::forceKernelVectorised()</b></em> is used by the routine computeHydroForce(). It makes sense to grep the cpp files within observers for a call to this routine, and then to open the corresponding .optrpt file of the cpp file. Vectorisation should be successful for the routine calling forceKernelVectorised() and look similar to <div class="fragment"><div class="line">LOOP BEGIN at ../../../../src/<a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>/<a class="code hl_namespace" href="../../de/dd9/namespacekernels.html">kernels</a>/ParticleParticleInteraction.cpph (580, 7)</div>
<div class="line"> </div>
<div class="line">    LOOP BEGIN at ../../../../src/<a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>/<a class="code hl_namespace" href="../../de/dd9/namespacekernels.html">kernels</a>/ParticleParticleInteraction.cpph (589, 11)</div>
<div class="line">        remark #15300: LOOP WAS VECTORIZED</div>
<div class="line">        remark #15305: vectorization support: vector length 4</div>
<div class="line">        remark #15475: --- begin vector loop cost summary ---</div>
<div class="line">        remark #15476: scalar cost: 310.000000</div>
<div class="line">        remark #15477: vector cost: 148.000000</div>
<div class="line">        remark #15478: estimated potential speedup: 2.062500</div>
<div class="line">        remark #15309: vectorization support: normalized vectorization overhead 0.140625</div>
<div class="line">        remark #15482: vectorized math library calls: 3</div>
<div class="line">        remark #15484: vector function calls: 0</div>
<div class="line">        remark #15485: serialized function calls: 0</div>
<div class="line">        remark #15488: --- end vector loop cost summary ---</div>
<div class="line">        remark #15447: --- begin vector loop memory reference summary ---</div>
<div class="line">        remark #15450: unmasked unaligned unit stride loads: 0</div>
<div class="line">        remark #15451: unmasked unaligned unit stride stores: 0</div>
<div class="line">        remark #15456: masked unaligned unit stride loads: 0</div>
<div class="line">        remark #15457: masked unaligned unit stride stores: 0</div>
<div class="line">        remark #15458: masked indexed (or gather) loads: 0</div>
<div class="line">        remark #15459: masked indexed (or scatter) stores: 0</div>
<div class="line">        remark #15462: unmasked indexed (or gather) loads: 19</div>
<div class="line">        remark #15463: unmasked indexed (or scatter) stores: 0</div>
<div class="line">        remark #15567: Gathers are generated due to non-unit stride index of the corresponding loads.</div>
<div class="line">        remark #15554: Unmasked VLS-optimized loads (each <a class="code hl_struct" href="../../d3/d20/structpart.html">part</a> of the group counted separately): 0</div>
<div class="line">        remark #15555: Masked VLS-optimized loads (each <a class="code hl_struct" href="../../d3/d20/structpart.html">part</a> of the group counted separately): 0</div>
<div class="line">        remark #15556: Unmasked VLS-optimized stores (each <a class="code hl_struct" href="../../d3/d20/structpart.html">part</a> of the group counted separately): 0</div>
<div class="line">        remark #15557: Masked VLS-optimized stores (each <a class="code hl_struct" href="../../d3/d20/structpart.html">part</a> of the group counted separately): 0</div>
<div class="line">        remark #15497: vector compress: 0</div>
<div class="line">        remark #15498: vector expand: 0</div>
<div class="line">        remark #15474: --- end vector loop memory reference summary ---</div>
<div class="line">        remark #25587: Loop has reduction</div>
<div class="line"> </div>
<div class="line">        LOOP BEGIN at ../../../../src/<a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>/<a class="code hl_namespace" href="../../de/dd9/namespacekernels.html">kernels</a>/kernel_hydro.h (206, 3)</div>
<div class="line">            remark #25436: Loop completely unrolled by 3</div>
<div class="line">        LOOP END</div>
<div class="line"> </div>
<div class="line">        LOOP BEGIN at ../../../../src/<a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>/<a class="code hl_namespace" href="../../de/dd9/namespacekernels.html">kernels</a>/kernel_hydro.h (206, 3)</div>
<div class="line">            remark #25436: Loop completely unrolled by 3</div>
<div class="line">        LOOP END</div>
<div class="line">    LOOP END</div>
<div class="ttc" id="anamespacekernels_html"><div class="ttname"><a href="../../de/dd9/namespacekernels.html">kernels</a></div><div class="ttdef"><b>Definition</b> <a href="../../d0/db5/idx_8h_source.html#l00005">idx.h:5</a></div></div>
<div class="ttc" id="astructpart_html"><div class="ttname"><a href="../../d3/d20/structpart.html">part</a></div><div class="ttdoc">Particle fields for the SPH particles.</div><div class="ttdef"><b>Definition</b> <a href="../../d8/d86/hydro__part_8h_source.html#l00099">hydro_part.h:99</a></div></div>
</div><!-- fragment --> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d6/dba/page_swift2_home.html">Swift 2</a></li><li class="navelem"><a class="el" href="../../d3/d24/swift_benchmarks.html">Benchmarks</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:01 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
