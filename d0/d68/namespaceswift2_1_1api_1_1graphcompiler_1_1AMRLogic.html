<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d0/d68/namespaceswift2_1_1api_1_1graphcompiler_1_1AMRLogic.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">swift2.api.graphcompiler.AMRLogic Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a02540a8c30edd9c58ba664c5233e2cc9" id="r_a02540a8c30edd9c58ba664c5233e2cc9"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a02540a8c30edd9c58ba664c5233e2cc9">add_dynamic_mesh_refinement_and_particle_resorting</a> (steps, alter_position, species_sets, sort_with_lifts_and_drops, verbose)</td></tr>
<tr class="memdesc:a02540a8c30edd9c58ba664c5233e2cc9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add action sets to step (aka mesh traversal) to adopt mesh to particle configuration.  <br /></td></tr>
<tr class="separator:a02540a8c30edd9c58ba664c5233e2cc9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a02540a8c30edd9c58ba664c5233e2cc9" name="a02540a8c30edd9c58ba664c5233e2cc9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a02540a8c30edd9c58ba664c5233e2cc9">&#9670;&#160;</a></span>add_dynamic_mesh_refinement_and_particle_resorting()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">swift2.api.graphcompiler.AMRLogic.add_dynamic_mesh_refinement_and_particle_resorting </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>steps</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>alter_position</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>species_sets</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>sort_with_lifts_and_drops</em>, </span></td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>verbose</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Add action sets to step (aka mesh traversal) to adopt mesh to particle configuration. </p>
<p>The AMR logic is based upon the observation that Peano's toolbox always holds the particles in the right place and hence allows us to realise all particle-particle interactions. If we don't get the mesh right, we might not be optimal in terms of cost. But we are never wrong!</p>
<h2><a class="anchor" id="autotoc_md480"></a>
Straightforward workflow</h2>
<p>In principle, SPH's AMR logic is pretty simple in the context of a the dual tree with its lifts and drops. The illustration below shows this trivial workflow on the left side:</p>
<div class="image">
<img src="../../AMR-logic.png" alt=""/>
</div>
<p>The image is the time axis and the bullets are the individual mesh traversals. On the left, we see the user input which eventually triggers a cascade of actions on the bookkeeping side (right). The user alters the particle position and hence might invalidate the particle-grid association. We have to re-sort. Some sorting can happen right in the same mesh traversal in which we alter the particles' properties in the touchCellLastTime or touchVertexLastTime actions. The green colour denotes stuff that's happening in the last data access - which might also introduce some MPI sends.</p>
<p>In the subsequent mesh traversal, we have to receive MPI data, move particles down in their tree and associate that to the correct vertex. This happens prior to any operation (denoted blue). Now that particles are in the right place, we can update their parallel state.</p>
<p>A straightforward implementation now might evaluate the AMR criterion, as all particles are in place and we can do so. Once we have collected all AMR info, we can distribute it globally and hand it out in the subsequent mesh traversal in which we consequently trigger refinements. Peano does not realise refinements immediately, but waits for the next mesh traversal to do so.</p>
<p>When we have done the refinement, we have to resort. Again, the resort has to spread over two mesh traversals, as the first half of the sorting might trigger MPI exchanges and multilevel traversals.</p>
<p>In this native data flow scheme, the user action affects the behaviour of five follow-up mesh traversals.</p>
<p>Alternative to add_dynamic_mesh_refinement_and_particle_resorting_aggressive_mesh_adoption() which is compatible with memory pool solutions, as long as you insert a dummy mesh sweep after each routine which changes the particle-mesh topology (or you ensure that the subsequent sweep does not evaluate particle-particle interactions).</p>
<p>The big difference to add_dynamic_mesh_refinement_and_particle_resorting_aggressive_mesh_adoption() is that we do analyse the AMR after we've resorted the particles. However, we do not realise the AMR up until we have to due to physics. So we make the AMR lag behind even further.</p>
<p>The big differences hence arise in the section where we do the association, and then we introduce the additional gather routines. As we do not update the association four times but only twice, we can also update the state only once instead of two times.</p>
<h2><a class="anchor" id="autotoc_md481"></a>
Workflow optimised towards minimal resorting</h2>
<p>The optimised workflow accepts that we we are fine to deal with a suboptimal mesh layout, as long as we minimise the number of particle movements. This is a different cost objective than in the description above. We realise that we will always need a resort when we have updated a mesh.</p>
<p>The idea is that we know that a user interaction forces us to update the particle-mesh association, while AMR does not: We have to lift particles from areas of the tree which are coarsened, but otherwise AMR does not invalidate a valid mesh association. Particles might reside on too coarse levels, but still all the kernel evaluations remain correct. The lift is the only thing that causes issues, as it might mean that particles literally travel.</p>
<p>To avoid that we have to do two sorts per particle position update, we evaluate the AMR criterion two grid sweeps ahead of the actual particle position update. This way, the AMR realisation and the actual position update coincide in the same mesh sweep. No need for an additional sorting step.</p>
<p>The disadvantage of this scheme is that the mesh always lags behind. The AMR just is about the realise when the particles move again. So it might have been optimal before, but now it is not good anymore. In return, we however get a scheme which does, amortised, need only one resorting step per mesh update plus AMR update.</p>
<h2><a class="anchor" id="autotoc_md482"></a>
Interplay with gathering</h2>
<p>The aggressive AMR is not compatible with particles that gather data in memory pools.</p>
<h2><a class="anchor" id="autotoc_md483"></a>
Realisation</h2>
<p>This implementation puts emphasis that the mesh is always as tighly adopted to the particles as possible. If necessary, this might mean that we resort the particles multiple times per grid sweep: If they change their position, we resort. But once we have resorted, we might want to change the mesh, which in turn means we have to resort again, as we might have new cells or cells might have been deleted.</p>
<h2><a class="anchor" id="autotoc_md484"></a>
Order of action sets</h2>
<p>As so often, the order of the action sets is tremendously important, as the individual action sets interact with each other. When we discuss the order here, we may assume that all the function steps aka action sets are already fully implemented and in the right order.</p>
<p>The trigger the AMR can be integrated whereever we want within the pipeline. It simply deploys events, i.e. it is order-agnostic.</p>
<p>For the remaining action sets, we observe the following properties:</p>
<ul>
<li>Mesh analysis: Looks into the cell stats. These are in place, so it should be one of the last things. The analysis happens in touchCellLastTime().</li>
<li>UpdateParallelState sets the particle flags in touchCellFirstTime(). In the last access to the vertex, it looks at all particles' flags and throws away particles which are virtual. It is iportant that that flag update happens when all particles are properly in place. The throwing away should be the very last thing, though we can throw away particles before we move them around if we want.</li>
<li>UpdateAssociation. Should be the very first thing, but should happen, before we update the state. In principle, the state can also come later, but we might mess up the stats if it comes before the particle migration: it might count particles multiple times.</li>
</ul>
<p>So we want to have the following lifecycle from a grid's point of view:</p>
<ul>
<li>touchVertexFirstTime():<ul>
<li>Sort in the particles from coarser meshes or the global sieve list.</li>
<li>Set their new parallel state.</li>
<li>Then the user-defined stuff.</li>
</ul>
</li>
<li>touchCellFirstTime():<ul>
<li>Mark local particles as local, but it doesn't really matter when this happens.</li>
</ul>
</li>
<li>touchCellLastTime():<ul>
<li>User code.</li>
<li>Maintain some mesh statistics.</li>
</ul>
</li>
<li>touchVertexLastTime():<ul>
<li>User-defined stuff.</li>
<li>Resort particles (to coarser levels, e.g.).</li>
<li>Throw away virtual (remote) particles.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md485"></a>
Arguments</h2>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">steps</td><td>[<a class="el" href="../../dc/d53/namespacepeano4_1_1solversteps_1_1Step.html">peano4.solversteps.Step</a>]</td></tr>
    <tr><td class="paramname">alter_position</td><td>[{True,False}]</td></tr>
    <tr><td class="paramname">species_sets</td><td>[Species]</td></tr>
    <tr><td class="paramname">verbose</td><td>{True, False} Controls how much debug information is dropped. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="../../d7/d11/AMRLogic_8py_source.html#l00017">17</a> of file <a class="el" href="../../d7/d11/AMRLogic_8py_source.html">AMRLogic.py</a>.</p>

<p class="reference">References <a class="el" href="../../d1/d99/Prediction_8EnclaveTask_8template_8cpp_source.html#l00021">int</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../de/dac/namespaceswift2.html">swift2</a></li><li class="navelem"><a class="el" href="../../dd/dea/namespaceswift2_1_1api.html">api</a></li><li class="navelem"><a class="el" href="../../d3/dd6/namespaceswift2_1_1api_1_1graphcompiler.html">graphcompiler</a></li><li class="navelem"><a class="el" href="../../d0/d68/namespaceswift2_1_1api_1_1graphcompiler_1_1AMRLogic.html">AMRLogic</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:30:40 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
