<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d3/dc8/page_swift_performance_optimisation.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Performance optimisation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1140">Optimising the single core performance of individual species (vectorisation)</a><ul><li class="level2"><a href="#autotoc_md1141">Step 1: Maintaining the active sets</a></li>
<li class="level2"><a href="#autotoc_md1142">Step 2: Storage of particles and maintaining the particle-mesh association</a></li>
<li class="level2"><a href="#autotoc_md1143">Step 3: Optimise the core kernels</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This section discusses some Swift-specific performance optimisation steps. While Swift 2.0 and its baseline, Peano, provide simplistic performance analysis features to spot some flaws, a proper performance optimisation has to be guided by external performance analysis tools. Furthermore, please read <a class="el" href="../../da/d8a/page_peano_performance_optimisation.html">Peano's generic performance optimisation remarks</a> parallel to this page. All of the recommendations there apply for SWIFT, too.</p>
<h1><a class="anchor" id="autotoc_md1140"></a>
Optimising the single core performance of individual species (vectorisation)</h1>
<p>To enable proper vectorisation is not trivial within a Lagrangian framework, as we typically need the right instructions, i.e. compute kernels, but also a fitting memory layout. As a user, you are responsible to ensure that the memory layout is properly chosen, and then you can activate the solvers' vectorisation.</p>
<p>Some of Swift's solvers are however already well-prepared to exploit the knowledge about optimised memory layouts and proper setups of action sets and hence can be vectorised. This does not hold for all solvers. You have to study their documentation, typically alter some switches and then tune the memory layout and particle handling as described below. Please note that not all solvers are compatible with all graph compiler flavours either. Again, this is something you might want to check with the solver documentation.</p>
<p>Even if your solver does not support vectorisation, you might benefit from the discussions below such as the memory pool and the different flavours of active set handling. The impact just won't be that big. The page <a class="el" href="../../d2/daf/swift_particle_new_solver.html">Creating new particle types (solvers) with new algorithmic steps</a> provides further details how to write vectorised solvers, i.e. how to prepare solvers to be able to exploit continuous, well-administered memory.</p>
<h2><a class="anchor" id="autotoc_md1141"></a>
Step 1: Maintaining the active sets</h2>
<p>There are two different versions how to maintain the active sets: We can either build them up as proper sets and add particles to the set whenever we touchCellFirstTime() and remove them from the cell when we invoke touchCellLastTime(). Or we can work with a list, memorise how many particles we add per touchCellFirstTime() and remove exactly this number when we backtrack through the tree.</p>
<p>The set variant is robust, but it is not very fast as we have to check for each particle in touchCellLastTime() where it is within the set and then we can remove it. We also miss out on any adjacent memory storage. The list variant is faster and preserves the ordering of the particles per vertex/cell (see the remarks below), but it works if and only if the particle-mesh association remains invariant. Such an "ordered" particle sequence allows you to use compute kernels with coalesced memory access, i.e. vectorisation. This insight gives rise to a third variant, where we use the coalesced memory storage and insert sorting sweeps whenever the particle positions change, such that we can always work with properly sorted particles.</p>
<p>Whether or not to use one variant or the other is a decision that's made by the graph compiler. Some compiler flavours support different active set construction variants, others are tied to one variant only. By default, the project initialises its graph compiler with the variant that does not try to vectorise or use sorted particles. You can alter that in your code:</p>
<div class="fragment"><div class="line">project.algorithm_steps_task_graph_compiler      = <a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>.graphcompiler.map_particle_steps_onto_separate_mesh_traversals_insert_dummy_sweeps_and_vectorise</div>
<div class="ttc" id="anamespaceswift2_html"><div class="ttname"><a href="../../de/dac/namespaceswift2.html">swift2</a></div><div class="ttdoc">This file is part of the SWIFT 2 project.</div><div class="ttdef"><b>Definition</b> <a href="../../da/d65/FixedBoundary_8h_source.html#l00008">FixedBoundary.h:8</a></div></div>
</div><!-- fragment --><p>Just pick another variant (consult namespace docu) here. Please note that these operations do typically unfold their potential if and only if you use a fully vectorised solver in combination with a proper particle memory management below.</p>
<p>Note: If you use a scheme which relies on vectorisation all the time, you have to also alter the initialisation via</p>
<div class="fragment"><div class="line">project.initialisation_steps_task_graph_compiler  = <a class="code hl_namespace" href="../../de/dac/namespaceswift2.html">swift2</a>.graphcompiler.serialise_initialisation_steps_and_map_onto_separate_mesh_traversals_for_coalescend_memory_access</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1142"></a>
Step 2: Storage of particles and maintaining the particle-mesh association</h2>
<p>Maintaining the association of particles to meshes is key, as Peano traverses the mesh and issues the particle updates for those particles tied to particular vertices or cells. We distinguish different ways how the particles themselves are organised in the memory and how the indices over the particles are built up and maintained. All particles are always stored on the heap, but how they populate the heap can be changed by using different <a class="el" href="../../db/d9c/toolbox_particles_memorypool.html">memor pools</a>.</p>
<p>You can alter the scheme per particle species by taking your instance of <a class="el" href="../../d7/d5c/namespacepeano4_1_1toolbox_1_1particles_1_1ParticleSet.html">peano4.toolbox.particles.ParticleSet</a>. Each particle set hosts an attribute generator. You can exchange the generator and thus switch administration and storage variants per species.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Feature   </th><th class="markdownTableHeadNone">Generator   </th><th class="markdownTableHeadNone">Semantics    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">scattered particles, list index   </td><td class="markdownTableBodyNone"><a class="el" href="../../d4/dd5/classpeano4_1_1toolbox_1_1particles_1_1ParticleSet_1_1ParticleSetGenerator__ScatteredOnHeap__IndexByList.html" title="Map a particle set onto heap objects indexed by a list.">peano4.toolbox.particles.ParticleSet.ParticleSetGenerator_ScatteredOnHeap_IndexByList</a>   </td><td class="markdownTableBodyNone">Scatter the particles all over the heap. The pointers per vertex to the particles are organised as a linked list.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">scattered particles, vector index   </td><td class="markdownTableBodyNone"><a class="el" href="../../d5/db4/classpeano4_1_1toolbox_1_1particles_1_1ParticleSet_1_1ParticleSetGenerator__ScatteredOnHeap__IndexByVector.html" title="Map a particle set onto heap objects indexed by an std::vector.">peano4.toolbox.particles.ParticleSet.ParticleSetGenerator_ScatteredOnHeap_IndexByVector</a>   </td><td class="markdownTableBodyNone">Almost the same as peano4.toolbox.particles.ParticleSetGenerator_ScatteredOnHeap_IndexByList, but the lists of pointers are realised through std::vector.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">arrays of particles per vertex   </td><td class="markdownTableBodyNone"><a class="el" href="../../d7/dba/classpeano4_1_1toolbox_1_1particles_1_1ParticleSet_1_1ParticleSetGenerator__ContinuousPerVertex.html" title="Map a particle set onto heap objects indexed by a list.">peano4.toolbox.particles.ParticleSet.ParticleSetGenerator_ContinuousPerVertex</a>   </td><td class="markdownTableBodyNone">The code tries to hold the particles associated with one vertex in one consecutive array. Whenever this is not possible, we use a linked list to reference the particles scattered over the memory.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">global array of particles   </td><td class="markdownTableBodyNone"><a class="el" href="../../d2/d96/classpeano4_1_1toolbox_1_1particles_1_1ParticleSet_1_1ParticleSetGenerator__GlobalContinuous.html" title="Map a particle set onto heap objects indexed by a list.">peano4.toolbox.particles.ParticleSet.ParticleSetGenerator_GlobalContinuous</a>   </td><td class="markdownTableBodyNone">The code tries to hold the particles in one big consecutive array where all particles associated with one vertex are held en bloc.   </td></tr>
</table>
<p>The scattered variants holds the particles somewhere on the global heap, and try never to move them. If particles travel within their subdomain, the code solely update the pointers each vertex holds to the particle. As a consequence, we might run into a fragmented heap occupation and the compute kernels will have to deal with scattered memory access. Coalescent memory access is basically never possible.</p>
<div class="image">
<img src="../../ParticleSetGenerator_ScatteredOnHeap.png" alt=""/>
</div>
<p>In return, we don't move (potentially heavy) particles around in memory and hence don't stress the OS memory system. To maintain the lists of the particles per vertex, we offer different versions. Again, the pointers can be stored within a consecutive memory block (array), or we can use a list which adds another level of overhead but is more flexible if particle-associations change frequently.</p>
<div class="image">
<img src="../../ParticleSetGenerator_ContinuousPerVertex.png" alt=""/>
</div>
<p>We also offer a variant which <a class="el" href="../../db/d9c/toolbox_particles_memorypool.html">stores the particles continuously within one memory chunks per vertex</a>. You can study <a class="el" href="../../d9/d04/structtoolbox_1_1particles_1_1memorypool_1_1VertexWiseContinuousMemoryPool.html" title="Memory pool offering continuous global memory for a particle species.">toolbox::particles::memorypool::VertexWiseContinuousMemoryPool</a> for a discussion on its realisation. Finally, there's also a variant which tries to hold all the particles in one big blob, i.e. as one large array. This global sorting is realised through <a class="el" href="../../d5/d4c/classtoolbox_1_1particles_1_1memorypool_1_1GlobalContinuousMemoryPool.html" title="Memory pool offering continuous global memory for a particle species.">toolbox::particles::memorypool::GlobalContinuousMemoryPool</a>.</p>
<div class="image">
<img src="../../ParticleSetGenerator_GlobalContinuous.png" alt=""/>
</div>
<p>The code to switch the storage scheme is relatively easy. Capture the particle set that the Swift 2 project returns when you add a particle species:</p>
<div class="fragment"><div class="line">particle_set = project.add_particle_species(particle)</div>
<div class="line">particle_set.generator = <a class="code hl_namespace" href="../../d8/d8f/namespacepeano4.html">peano4</a>.<a class="code hl_namespace" href="../../d5/d91/namespacepeano4_1_1toolbox.html">toolbox</a>.<a class="code hl_namespace" href="../../d1/d65/namespacepeano4_1_1toolbox_1_1particles.html">particles</a>.ParticleSetGenerator_ContinuousPerVertex(particle_set)</div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_1_1particles_html"><div class="ttname"><a href="../../d1/d65/namespacepeano4_1_1toolbox_1_1particles.html">peano4.toolbox.particles</a></div><div class="ttdef"><b>Definition</b> <a href="../../d3/d04/python_2peano4_2toolbox_2particles_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_1_1toolbox_html"><div class="ttname"><a href="../../d5/d91/namespacepeano4_1_1toolbox.html">peano4.toolbox</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/db6/python_2peano4_2toolbox_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
<div class="ttc" id="anamespacepeano4_html"><div class="ttname"><a href="../../d8/d8f/namespacepeano4.html">peano4</a></div><div class="ttdef"><b>Definition</b> <a href="../../df/d17/CellMarker_8h_source.html#l00014">CellMarker.h:14</a></div></div>
</div><!-- fragment --><p>The line above changes the particle set generator, i.e. the class which maps the particle set onto an implementation.</p>
<h2><a class="anchor" id="autotoc_md1143"></a>
Step 3: Optimise the core kernels</h2>
<p>Once we have optimised the data layout, we can use this to start tweaking the actual compute kernels. We can, for example, vectorise them aggresively or offload (some of) them to a GPU. These techniques are studied in the last sections of <a class="el" href="../../d2/daf/swift_particle_new_solver.html">Creating new particle types (solvers) with new algorithmic steps</a>.</p>
<p>Besides the description of "how to tune" a kernel, we strongly advise to consult <a class="el" href="../../d0/dd8/swift_runtime_analysis.html">Swift's page on runtime analysis</a>, too. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../d6/dba/page_swift2_home.html">Swift 2</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:29:06 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
