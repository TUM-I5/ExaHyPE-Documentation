<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="../../Peano-icon.png" type="image/x-icon" />
<title>Peano</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="../../doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="../../toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="../../custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<!-- https://bryce.io/gitlab-corners/ -->
<style>.gitlab-corner-wrapper{overflow:hidden;width:100px;height:100px;position:absolute;top:0;right:0}.gitlab-corner{position:absolute;top:-16px;right:-50px;transform:rotate(45deg);background:#333;border:44px solid #333;border-bottom:none;border-top:#333 solid 16px}.gitlab-corner svg{width:60px;height:60px;margin-bottom:-4px}.cls-1{fill:#fc6d26}.cls-2{fill:#e24329}.cls-3{fill:#fca326}.gitlab-corner:hover .cls-1{animation:cycle .6s}.gitlab-corner:hover .cls-2{animation:cycleMid .6s}.gitlab-corner:hover .cls-3{animation:cycleEnd .6s}@keyframes cycle{100%,15%,60%{fill:#fc6d26}30%,75%{fill:#e24329}45%,90%{fill:#fca326}}@keyframes cycleMid{100%,15%,60%{fill:#e24329}30%,75%{fill:#fca326}45%,90%{fill:#fc6d26}}@keyframes cycleEnd{100%,15%,60%{fill:#fca326}30%,75%{fill:#fc6d26}45%,90%{fill:#e24329}}@media (max-width:500px){.gitlab-corner:hover .cls-1,.gitlab-corner:hover .cls-2,.gitlab-corner:hover .cls-3{animation:none}.gitlab-corner .cls-1{animation:cycle .6s}.gitlab-corner .cls-2{animation:cycleMid .6s}.gitlab-corner .cls-3{animation:cycleEnd .6s}}</style><div class="gitlab-corner-wrapper"><a href="https://gitlab.lrz.de/hpcsoftware/Peano" class="gitlab-corner" aria-label="View source on GitLab"><svg id="logo_art" data-name="logo art" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 586 559"><g id="g44"><path id="path46" class="cls-1" d="M461.17,301.83l-18.91-58.12L404.84,128.43a6.47,6.47,0,0,0-12.27,0L355.15,243.64H230.82L193.4,128.43a6.46,6.46,0,0,0-12.26,0L143.78,243.64l-18.91,58.19a12.88,12.88,0,0,0,4.66,14.39L293,435,456.44,316.22a12.9,12.9,0,0,0,4.73-14.39"/></g><g id="g48"><path id="path50" class="cls-2" d="M293,434.91h0l62.16-191.28H230.87L293,434.91Z"/></g><g id="g56"><path id="path58" class="cls-1" d="M293,434.91,230.82,243.63h-87L293,434.91Z"/></g><g id="g64"><path id="path66" class="cls-3" d="M143.75,243.69h0l-18.91,58.12a12.88,12.88,0,0,0,4.66,14.39L293,435,143.75,243.69Z"/></g><g id="g72"><path id="path74" class="cls-2" d="M143.78,243.69h87.11L193.4,128.49a6.47,6.47,0,0,0-12.27,0l-37.35,115.2Z"/></g><g id="g76"><path id="path78" class="cls-1" d="M293,434.91l62.16-191.28H442.3L293,434.91Z"/></g><g id="g80"><path id="path82" class="cls-3" d="M442.24,243.69h0l18.91,58.12a12.85,12.85,0,0,1-4.66,14.39L293,434.91l149.2-191.22Z"/></g><g id="g84"><path id="path86" class="cls-2" d="M442.28,243.69h-87.1l37.42-115.2a6.46,6.46,0,0,1,12.26,0l37.42,115.2Z"/></g></svg></a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Peano-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Peano
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('db/d11/tarch_NoncriticalAssertions.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Noncritical assertions</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A noncritical assertion is an assertion which indicates that something went horribly wrong due to a programming error, but the code should still continue with this mesh traversal, then dump the data, and eventually terminate.</p>
<p>You should never use an assertion for user errors, as assertions are compiled out from the code in release builds. Usual assertions make the code stop immediately. For many numerical bugs, this is not very useful. Instead, you can trigger a noncritical assertion which informs rank 0 that something went wrong. Rank 0 will now issue a data dump (it ignores whether you have enabled outputs or not, it simply enforces a plot of the grid) and then terminates deterministically. This way, you can inspect the solution just when the assertion had been violated.</p>
<h2><a class="anchor" id="autotoc_md228"></a>
Behaviour</h2>
<p>As a noncritical assertion does not immediately terminate the code, you might get a whole sequence of these guys in a row. Skip them all and read only the first one in this case. I try to filter out the messages, i.e. to display only the first one, but as the ranks try not to synchronise where possible, I can only filter error messages from one rank. That is, you'll still get up to one error/assertion message per rank.</p>
<h2><a class="anchor" id="autotoc_md229"></a>
Macros and behaviour in release mode</h2>
<p>In line with the assertions, I offer a set of macros for non-critical assertions. Again, they reduce to nop if you run in release mode, i.e. I don't check for non-critical assertions anymore.</p>
<p>However, the environment to handle non-critical assertions is always up, no matter if you run in release mode or not. Therefore, you can manually trigger a non-critical assertion through a call to triggerNonCriticalAssertion() and this call then won't be removed if you compile in release mode.</p>
<h2><a class="anchor" id="autotoc_md230"></a>
Realisation</h2>
<p>Logically, the assertions are implemented via a single integer. As long as this integer is zero, all is fine. If a non-critical assertion fails, we set the variable - which is local per rank - to the number of the failing rank. The global simulation driver, i.e. main, has to check the flag prior to every solver step. If the flag is non-zero, it has to stop and instead dump the solution. After that, it has to quit.</p>
<p>The crucial question here remains how you sync the individual ranks. If a rank goes down, it has to notify rank 0 that it had an issue, as rank 0 makes the global decisions.</p>
<p>I did play around with RMA and windows to realise the information propagation. My idea had been that any rank where a non-critical assertion arises dumps a flag into the window on rank 0 and rank 0 then takes it from there. This approach does not work straightforwardly, as you always need some synchronisation (fences, e.g.) in MPI.</p>
<p>Therefore, I decided to switch back to old-fashioned P2P messages. The rank that observes a failing assertion records this assertion and sends a message to rank 0. Whenever rank 0 is asked if a problem has popped up, it first looks into its own local variable (did a non-critical assertion arise on rank 0), and then it looks if there's an assertion message in the queue. To make this approach work, we need a dedicated assertion tag which is not used for any other purpose: After all, the assertion message logically might have to overtook other messages.</p>
<h2><a class="anchor" id="autotoc_md231"></a>
Modifications of main file</h2>
<p>If you want to support non-critical assertions, you have to alter your main loop to check for the flag every now and then. This is not done automatically, though some extensions such as Swift or ExaHyPE bring up the environment for non-critical assertions up by default.</p>
<p>Usually, the main driver's code snippet looks as follows:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code hl_function" href="../../da/d6a/namespacetarch.html#a3c78d84459df151a063cd1d26edadc76">tarch::hasNonCriticalAssertionBeenViolated</a>() and not haveReceivedNoncriticialAssertion) {</div>
<div class="line">  <a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a>().<a class="code hl_function" href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">setNextProgramStep</a>(</div>
<div class="line">    repositories::StepRepository::toProgramStep( repositories::StepRepository::Steps::Plot )</div>
<div class="line">);</div>
<div class="line"> haveReceivedNoncriticialAssertion = <span class="keyword">true</span>;</div>
<div class="line"> <a class="code hl_define" href="../../d1/d45/Log_8h.html#a2d2fd956e3c38ba6a1f694ccc0a1a602">logError</a>(</div>
<div class="line">   <span class="stringliteral">&quot;selectNextAlgorithmicStep()&quot;</span>, <span class="stringliteral">&quot;non-critical assertion has been triggered in code. Dump final state and terminate&quot;</span></div>
<div class="line"> );</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_function" href="../../da/d6a/namespacetarch.html#a3c78d84459df151a063cd1d26edadc76">tarch::hasNonCriticalAssertionBeenViolated</a>()) {</div>
<div class="line">  continueToSolve = <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> [...]</div>
<div class="ttc" id="aLog_8h_html_a2d2fd956e3c38ba6a1f694ccc0a1a602"><div class="ttname"><a href="../../d1/d45/Log_8h.html#a2d2fd956e3c38ba6a1f694ccc0a1a602">logError</a></div><div class="ttdeci">#define logError(methodName, logMacroMessageStream)</div><div class="ttdoc">Wrapper macro around tarch::tarch::logging::Log to improve logging.</div><div class="ttdef"><b>Definition</b> <a href="../../d1/d45/Log_8h_source.html#l00464">Log.h:464</a></div></div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1Node_html_a7bc31c5e9f0f24785ae7e19d7add30c0"><div class="ttname"><a href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a7bc31c5e9f0f24785ae7e19d7add30c0">peano4::parallel::Node::getInstance</a></div><div class="ttdeci">static Node &amp; getInstance()</div><div class="ttdef"><b>Definition</b> <a href="../../dc/d73/Node_8cpp_source.html#l00077">Node.cpp:77</a></div></div>
<div class="ttc" id="aclasspeano4_1_1parallel_1_1Node_html_a8a2b782cd625b91d5fdfb97b56f18caa"><div class="ttname"><a href="../../d8/dde/classpeano4_1_1parallel_1_1Node.html#a8a2b782cd625b91d5fdfb97b56f18caa">peano4::parallel::Node::setNextProgramStep</a></div><div class="ttdeci">void setNextProgramStep(int number)</div><div class="ttdoc">The user tells the set which program step to use, i.e.</div><div class="ttdef"><b>Definition</b> <a href="../../dc/d73/Node_8cpp_source.html#l00415">Node.cpp:415</a></div></div>
<div class="ttc" id="anamespacetarch_html_a3c78d84459df151a063cd1d26edadc76"><div class="ttname"><a href="../../da/d6a/namespacetarch.html#a3c78d84459df151a063cd1d26edadc76">tarch::hasNonCriticalAssertionBeenViolated</a></div><div class="ttdeci">bool hasNonCriticalAssertionBeenViolated()</div><div class="ttdef"><b>Definition</b> <a href="../../d9/df3/NonCriticalAssertions_8cpp_source.html#l00093">NonCriticalAssertions.cpp:93</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Peano</a></li><li class="navelem"><a class="el" href="../../dd/d46/page_tarch_home.html">Technical Architecture (tarch)</a></li>
    <li class="footer">Generated on Tue Jul 1 2025 11:28:57 for Peano by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
